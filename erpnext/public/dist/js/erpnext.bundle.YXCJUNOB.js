(()=>{frappe.provide("erpnext");$.extend(frappe.breadcrumbs.preferred,{"Item Group":"Stock","Customer Group":"Selling","Supplier Group":"Buying",Territory:"Selling","Sales Person":"Selling","Sales Partner":"Selling",Brand:"Stock","Maintenance Schedule":"Support","Maintenance Visit":"Support"});$.extend(frappe.breadcrumbs.module_map,{"ERPNext Integrations":"Integrations",Geo:"Settings",Portal:"Website",Utilities:"Settings","E-commerce":"Website",Contacts:"CRM"});frappe.provide("erpnext");frappe.provide("erpnext.utils");frappe.provide("erpnext.stock.utils");$.extend(erpnext,{get_currency:function(r){var e;return!r&&cur_frm&&(r=cur_frm.doc.company),r&&((e=frappe.get_doc(":Company",r))==null?void 0:e.default_currency)||frappe.boot.sysdefaults.currency},get_presentation_currency_list:()=>{let e=frappe.boot.docs.filter(t=>t.doctype===":Currency").map(t=>t.name);return e.unshift(""),e},toggle_naming_series:function(){cur_frm&&cur_frm.fields_dict.naming_series&&cur_frm.toggle_display("naming_series",!!cur_frm.doc.__islocal)},hide_company:function(r){if(r!=null&&r.fields_dict.company){var e=Object.keys(locals[":Company"]||{});e.length===1?(r.doc.company||r.set_value("company",e[0]),r.toggle_display("company",!1)):erpnext.last_selected_company&&(r.doc.company||r.set_value("company",erpnext.last_selected_company))}},is_perpetual_inventory_enabled:function(r){if(r){let e=locals[":Company"]&&locals[":Company"][r];if(e)return cint(e.enable_perpetual_inventory)}},stale_rate_allowed:()=>cint(frappe.boot.sysdefaults.allow_stale),setup_serial_or_batch_no:function(){},route_to_adjustment_jv:r=>{frappe.model.with_doctype("Journal Entry",()=>{let e=frappe.model.get_new_doc("Journal Entry");r.accounts.forEach(t=>{let a=frappe.model.add_child(e,"accounts");a.account=t.account,a.debit_in_account_currency=t.debit_in_account_currency,a.credit_in_account_currency=t.credit_in_account_currency,a.party_type=""}),frappe.set_route("Form","Journal Entry",e.name)})},route_to_pending_reposts:r=>{frappe.set_route("List","Repost Item Valuation",r)}});$.extend(erpnext.utils,{set_party_dashboard_indicators:function(r){if(r.doc.__onload&&r.doc.__onload.dashboard_info){var e=r.doc.__onload.dashboard_info;e.length>1?e.forEach(function(t){erpnext.utils.add_indicator_for_multicompany(r,t)}):e.length===1&&(r.dashboard.add_indicator(__("Annual Billing: {0}",[format_currency(e[0].billing_this_year,e[0].currency)]),"blue"),r.dashboard.add_indicator(__("Total Unpaid: {0}",[format_currency(e[0].total_unpaid,e[0].currency)]),e[0].total_unpaid?"orange":"green"),e[0].loyalty_points&&r.dashboard.add_indicator(__("Loyalty Points: {0}",[e[0].loyalty_points]),"blue"))}},view_serial_batch_nos:function(r){var t;if(!((t=r.doc)!=null&&t.items))return;let e=r.doc.items.filter(a=>a.serial_and_batch_bundle);e!=null&&e.length&&r.add_custom_button(__("Serial / Batch Nos"),()=>{frappe.route_options={voucher_no:r.doc.name,voucher_type:r.doc.doctype,from_date:r.doc.posting_date||r.doc.transaction_date,to_date:r.doc.posting_date||r.doc.transaction_date,company:r.doc.company},frappe.set_route("query-report","Serial and Batch Summary")},__("View"))},add_indicator_for_multicompany:function(r,e){r.dashboard.stats_area.show(),r.dashboard.stats_area_row.addClass("flex"),r.dashboard.stats_area_row.css("flex-wrap","wrap");var t=e.total_unpaid?"orange":"green",a=$('<div class="flex-column col-xs-6"><div style="margin-top:10px"><h6>'+e.company+'</h6></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Annual Billing: '+format_currency(e.billing_this_year,e.currency)+'</span></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator '+t+'">Total Unpaid: '+format_currency(e.total_unpaid,e.currency)+"</span></div></div>").appendTo(r.dashboard.stats_area_row);return e.loyalty_points&&$('<div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Loyalty Points: '+e.loyalty_points+"</span></div>").appendTo(a),a},get_party_name:function(r){var e={Customer:"customer_name",Supplier:"supplier_name",Employee:"employee_name",Member:"member_name"};return e[r]},copy_value_in_all_rows:function(r,e,t,a,i){var s=locals[e][t];if(s[i])for(var n=r[a]||[],o=0;o<n.length;o++)n[o][i]||(n[o][i]=s[i]);refresh_field(a)},get_terms:function(r,e,t){if(r)return frappe.call({method:"erpnext.setup.doctype.terms_and_conditions.terms_and_conditions.get_terms_and_conditions",args:{template_name:r,doc:e},callback:function(a){t(a)}})},make_bank_account:function(r,e){frappe.call({method:"erpnext.accounts.doctype.bank_account.bank_account.make_bank_account",args:{doctype:r,docname:e},freeze:!0,callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},add_dimensions:function(r,e){let t=frappe.query_reports[r].filters;frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions",callback:function(a){a.message[0].forEach(s=>{t.some(o=>o.fieldname===s.fieldname)||t.splice(e,0,{fieldname:s.fieldname,label:__(s.label),fieldtype:"MultiSelectList",get_data:function(o){return frappe.db.get_link_options(s.document_type,o)}})})}})},add_inventory_dimensions:function(r,e){let t=frappe.query_reports[r].filters;frappe.call({method:"erpnext.stock.doctype.inventory_dimension.inventory_dimension.get_inventory_dimensions",callback:function(a){a.message&&a.message.length&&a.message.forEach(i=>{let s=t.filter(n=>n.fieldname===i.fieldname);s.length?(s[0].fieldtype="MultiSelectList",s[0].get_data=function(n){return frappe.db.get_link_options(i.doctype,n)}):t.splice(e,0,{fieldname:i.fieldname,label:__(i.doctype),fieldtype:"MultiSelectList",get_data:function(n){return frappe.db.get_link_options(i.doctype,n)}})})}})},make_subscription:function(r,e){frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.make_auto_repeat",args:{doctype:r,docname:e},callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},make_pricing_rule:function(r,e){frappe.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.make_pricing_rule",args:{doctype:r,docname:e},callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},first_row_is_empty:function(r){return $.isArray(r)&&r.length>0?!r[0].item_code:!1},remove_empty_first_row:function(r,e){let t=r.doc[e];return this.first_row_is_empty(t)&&(r.doc[e]=t.splice(1)),t},get_tree_options:function(r){let e=frappe.model.unscrub(r),t=frappe.defaults.get_user_permissions(),a;return t&&t[e]?a=t[e].map(i=>i.doc):a=$.map(locals[`:${e}`],function(i){return i.name}).sort(),a.filter((i,s,n)=>n.indexOf(i)===s)},get_tree_default:function(r){let e=this.get_tree_options(r);return e.includes(frappe.defaults.get_default(r))?frappe.defaults.get_default(r):e[0]},overrides_parent_value_in_all_rows:function(r,e,t,a,i,s){if(r[s]){let n=r[a]||[];for(let o=0;o<n.length;o++)n[o][i]=r[s];frappe.refresh_field(a)}},create_new_doc:function(r,e){frappe.model.with_doctype(r,function(){var t=frappe.model.get_new_doc(r);for(let[a,i]of Object.entries(e))t[a]=i;frappe.ui.form.make_quick_entry(r,null,null,t)})},check_payments_app:()=>{if(frappe.boot.versions&&!frappe.boot.versions.payments){let r='<a href="https://frappecloud.com/marketplace/apps/payments">Marketplace</a>',e='<a href="https://github.com/frappe/payments/">GitHub</a>',t=__("payments app is not installed. Please install it from {0} or {1}",[r,e]);frappe.msgprint(t)}},pick_serial_and_batch_bundle(r,e,t,a,i){let s=frappe.get_doc(e,t);s.type_of_transaction=a,frappe.db.get_value("Item",s.item_code,["has_batch_no","has_serial_no"]).then(n=>{s.has_batch_no=n.message.has_batch_no,s.has_serial_no=n.message.has_serial_no,new erpnext.SerialBatchPackageSelector(r,s,o=>{if(o){let l={serial_and_batch_bundle:o.name,qty:Math.abs(o.total_qty)};i||(i="warehouse"),o.warehouse&&(l[i]=o.warehouse),frappe.model.set_value(s.doctype,s.name,l)}})})},get_fiscal_year:function(r,e=!1,t=!1){if(!frappe.boot.setup_complete)return;r||(r=frappe.datetime.get_today());let a="";return frappe.call({method:"erpnext.accounts.utils.get_fiscal_year",args:{date:r,boolean:t},async:!1,callback:function(i){i.message&&(e?a=i.message:a=i.message[0])}}),a}});erpnext.utils.select_alternate_items=function(r){let e=r.frm,t=r.warehouse_field||"warehouse",a=r.item_field||"item_code";this.data=[];let i=new frappe.ui.Dialog({title:__("Select Alternate Item"),fields:[{fieldtype:"Section Break",label:__("Items")},{fieldname:"alternative_items",fieldtype:"Table",cannot_add_rows:!0,in_place_edit:!0,data:this.data,get_data:()=>this.data,fields:[{fieldtype:"Data",fieldname:"docname",hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:1,label:__("Item Code")},{fieldtype:"Link",fieldname:"alternate_item",options:"Item",default:"",in_list_view:1,label:__("Alternate Item"),onchange:function(){let s=this.get_value(),n=this.grid_row.on_grid_fields_dict.warehouse.get_value();s&&n&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:s,warehouse:n},callback:o=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(o.message||0)}})},get_query:s=>({query:"erpnext.stock.doctype.item_alternative.item_alternative.get_alternative_items",filters:{item_code:s.item_code}})},{fieldtype:"Link",fieldname:"warehouse",options:"Warehouse",default:"",in_list_view:1,label:__("Warehouse"),onchange:function(){let s=this.get_value(),n=this.grid_row.on_grid_fields_dict.item_code.get_value();n&&s&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:n,warehouse:s},callback:o=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(o.message||0)}})}},{fieldtype:"Float",fieldname:"actual_qty",default:0,read_only:1,in_list_view:1,label:__("Available Qty")}]}],primary_action:function(){this.get_values().alternative_items.filter(o=>{if(o.alternate_item&&o.item_code!=o.alternate_item)return!0}).forEach(o=>{let l=frappe.get_doc(r.child_doctype,o.docname),c=null;l.doctype==="Work Order Item"?c=l.required_qty:c=l.qty,l[a]=o.alternate_item,frappe.model.set_value(l.doctype,l.name,"qty",c),frappe.model.set_value(l.doctype,l.name,r.original_item_field,o.item_code),e.trigger(a,l.doctype,l.name)}),refresh_field(r.child_docname),this.hide()},primary_action_label:__("Update")});e.doc[r.child_docname].forEach(s=>{(!r.condition||r.condition(s))&&i.fields_dict.alternative_items.df.data.push({docname:s.name,item_code:s[a],warehouse:s[t],actual_qty:s.actual_qty})}),this.data=i.fields_dict.alternative_items.df.data,i.fields_dict.alternative_items.grid.refresh(),i.show()};erpnext.utils.update_child_items=function(r){let e=r.frm,t=typeof r.cannot_add_row=="undefined"?!0:r.cannot_add_row,a=typeof r.cannot_add_row=="undefined"?"items":r.child_docname,i=frappe.get_meta(`${e.doc.doctype} Item`),s=!!r.has_reserved_stock,n=c=>i.fields.find(d=>d.fieldname==c).precision;this.data=e.doc[r.child_docname].map(c=>({docname:c.name,name:c.name,item_code:c.item_code,delivery_date:c.delivery_date,schedule_date:c.schedule_date,conversion_factor:c.conversion_factor,qty:c.qty,rate:c.rate,uom:c.uom,fg_item:c.fg_item,fg_item_qty:c.fg_item_qty}));let o=[{fieldtype:"Data",fieldname:"docname",read_only:1,hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:0,disabled:0,label:__("Item Code"),get_query:function(){let c;return e.doc.doctype=="Sales Order"?c={is_sales_item:1}:e.doc.doctype=="Purchase Order"&&(e.doc.is_subcontracted?e.doc.is_old_subcontracting_flow?c={is_sub_contracted_item:1}:c={is_stock_item:0}:c={is_purchase_item:1}),{query:"erpnext.controllers.queries.item_query",filters:c}}},{fieldtype:"Link",fieldname:"uom",options:"UOM",read_only:0,label:__("UOM"),reqd:1,onchange:function(){frappe.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:this.doc.item_code,uom:this.value},callback:c=>{if(!c.exc){if(this.doc.conversion_factor==c.message.conversion_factor)return;let d=this.doc.docname;l.fields_dict.trans_items.df.data.some(p=>{if(p.docname==d)return p.conversion_factor=c.message.conversion_factor,l.fields_dict.trans_items.grid.refresh(),!0})}}})}},{fieldtype:"Float",fieldname:"qty",default:0,read_only:0,in_list_view:1,label:__("Qty"),precision:n("qty")},{fieldtype:"Currency",fieldname:"rate",options:"currency",default:0,read_only:0,in_list_view:1,label:__("Rate"),precision:n("rate")}];(e.doc.doctype=="Sales Order"||e.doc.doctype=="Purchase Order")&&(o.splice(2,0,{fieldtype:"Date",fieldname:e.doc.doctype=="Sales Order"?"delivery_date":"schedule_date",in_list_view:1,label:e.doc.doctype=="Sales Order"?__("Delivery Date"):__("Reqd by date"),reqd:1}),o.splice(3,0,{fieldtype:"Float",fieldname:"conversion_factor",label:__("Conversion Factor"),precision:n("conversion_factor")})),e.doc.doctype=="Purchase Order"&&e.doc.is_subcontracted&&!e.doc.is_old_subcontracting_flow&&o.push({fieldtype:"Link",fieldname:"fg_item",options:"Item",reqd:1,in_list_view:0,read_only:0,disabled:0,label:__("Finished Good Item"),get_query:()=>({filters:{is_stock_item:1,is_sub_contracted_item:1,default_bom:["!=",""]}})},{fieldtype:"Float",fieldname:"fg_item_qty",reqd:1,default:0,read_only:0,in_list_view:0,label:__("Finished Good Item Qty"),precision:n("fg_item_qty")});let l=new frappe.ui.Dialog({title:__("Update Items"),size:"extra-large",fields:[{fieldname:"trans_items",fieldtype:"Table",label:"Items",cannot_add_rows:t,in_place_edit:!1,reqd:1,data:this.data,get_data:()=>this.data,fields:o}],primary_action:function(){e.doctype=="Sales Order"&&s?(this.hide(),frappe.confirm(__("The reserved stock will be released when you update items. Are you certain you wish to proceed?"),()=>this.update_items())):this.update_items()},update_items:function(){let c=this.get_values().trans_items.filter(d=>!!d.item_code);frappe.call({method:"erpnext.controllers.accounts_controller.update_child_qty_rate",freeze:!0,args:{parent_doctype:e.doc.doctype,trans_items:c,parent_doctype_name:e.doc.name,child_docname:a},callback:function(){e.reload_doc()}}),this.hide(),refresh_field("items")},primary_action_label:__("Update")});l.show()};erpnext.utils.map_current_doc=function(r){function e(){if($.isArray(cur_frm.doc.items)&&cur_frm.doc.items.length>0){cur_frm.doc.items[0].item_code||(cur_frm.doc.items=cur_frm.doc.items.splice(1));var a=frappe.meta.get_docfield(cur_frm.doctype,"items").options,i=null;frappe.get_meta(a).fields.forEach(function(o){o.options===r.source_doctype&&(i=o.fieldname)});var s=!1,n={};$.each(cur_frm.doc.items,function(o,l){r.source_name.forEach(function(c){l[i]==c&&(s=!0,n[l.item_code]?n[l.item_code]+=flt(l.qty):n[l.item_code]=flt(l.qty))})}),s&&r.source_name.forEach(function(o){if(frappe.model.with_doc(r.source_doctype,o,function(l){var c=frappe.model.get_doc(r.source_doctype,o);$.each(c.items||[],function(d,p){if(p.qty>flt(n[p.item_code]))return s=!1,!1})}),s){frappe.msgprint(__("You have already selected items from {0} {1}",[r.source_doctype,o]));return}})}return frappe.call({type:"POST",method:"frappe.model.mapper.map_docs",args:{method:r.method,source_names:r.source_name,target_doc:cur_frm.doc,args:r.args},freeze:!0,freeze_message:__("Mapping {0} ...",[r.source_doctype]),callback:function(o){o.exc||(frappe.model.sync(o.message),cur_frm.dirty(),cur_frm.refresh())}})}let t={};if(r.get_query_filters&&(t.filters=r.get_query_filters),r.get_query_method&&(t.query=r.get_query_method),(t.filters||t.query)&&(r.get_query=()=>t),r.source_doctype){let a=[];["Purchase Receipt","Delivery Note"].includes(r.source_doctype)&&frappe.get_meta(cur_frm.doc.doctype).fields.find(n=>n.fieldname==="taxes")&&a.push({fieldname:"merge_taxes",fieldtype:"Check",label:__("Merge taxes from multiple documents")});let i=new frappe.ui.form.MultiSelectDialog({doctype:r.source_doctype,target:r.target,date_field:r.date_field||void 0,setters:r.setters,read_only_setters:r.read_only_setters,data_fields:a,get_query:r.get_query,add_filters_group:1,allow_child_item_selection:r.allow_child_item_selection,child_fieldname:r.child_fieldname,child_columns:r.child_columns,size:r.size,action:function(s,n){let o=s;if(o.length===0){frappe.msgprint(__("Please select {0}",[r.source_doctype]));return}o.constructor===Array?r.source_name=[...new Set(o)]:r.source_name=o,(r.allow_child_item_selection||["Purchase Receipt","Delivery Note"].includes(r.source_doctype))&&(r.args=n),i.dialog.hide(),e()}});return i}r.source_name&&(r.source_name=[r.source_name],e())};frappe.form.link_formatters.Item=function(r,e){return e&&r&&e.item_name&&e.item_name!==r&&e.item_code===r?r+": "+e.item_name:!r&&e.doctype&&e.item_name?e.item_name:r};frappe.form.link_formatters.Employee=function(r,e){return e&&r&&e.employee_name&&e.employee_name!==r&&e.employee===r?r+": "+e.employee_name:!r&&e.doctype&&e.employee_name?e.employee:r};frappe.form.link_formatters.Project=function(r,e){return e&&r&&e.project_name&&e.project_name!==r&&e.project===r?r+": "+e.project_name:!r&&e.doctype&&e.project_name?e.project:r};$(document).on("app_ready",function(){frappe.datetime.is_timezone_same()||$.each(["Stock Reconciliation","Stock Entry","Stock Ledger Entry","Delivery Note","Purchase Receipt","Sales Invoice"],function(r,e){frappe.ui.form.on(e,"onload",function(t){cur_frm.set_df_property("posting_time","description",frappe.sys_defaults.time_zone)})})});$(document).on("app_ready",function(){$.each(frappe.boot.service_level_agreement_doctypes,function(r,e){frappe.ui.form.on(e,{onload:function(t){!t.doc.service_level_agreement||frappe.call({method:"erpnext.support.doctype.service_level_agreement.service_level_agreement.get_service_level_agreement_filters",args:{doctype:t.doc.doctype,name:t.doc.service_level_agreement,customer:t.doc.customer},callback:function(a){a&&a.message&&(t.set_query("priority",function(){return{filters:{name:["in",a.message.priority]}}}),t.set_query("service_level_agreement",function(){return{filters:{name:["in",a.message.service_level_agreements]}}}))}})},refresh:function(t){if(t.doc.status!=="Closed"&&t.doc.service_level_agreement&&["First Response Due","Resolution Due"].includes(t.doc.agreement_status))frappe.call({method:"frappe.client.get",args:{doctype:"Service Level Agreement",name:t.doc.service_level_agreement},callback:function(a){let i=a.message.pause_sla_on,s=[];if($.each(i,(n,o)=>{s.push(o.status)}),s.includes(t.doc.status)){t.dashboard.clear_headline();let n={indicator:"orange",msg:__("SLA is on hold since {0}",[moment(t.doc.on_hold_since).fromNow(!0)])};t.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+n.indicator+'"><span>'+n.msg+"</span></span> </div></div>")}else k(t,a.message.apply_sla_for_resolution)}});else if(t.doc.service_level_agreement){t.dashboard.clear_headline();let a=t.doc.agreement_status=="Fulfilled"?{indicator:"green",msg:"Service Level Agreement has been fulfilled"}:{indicator:"red",msg:"Service Level Agreement Failed"};t.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+a.indicator+'"><span class="hidden-xs">'+a.msg+"</span></span> </div></div>")}}})})});function k(r,e){r.dashboard.clear_headline();let t;r.doc.first_responded_on?t=g(r.doc.response_by,r.doc.first_responded_on):t=h(r.doc.response_by,r.doc.agreement_status);let a=`
		<div class="row">
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${t.indicator}">
					<span>Time to Respond: ${t.diff_display}</span>
				</span>
			</div>`;if(e){let i;r.doc.resolution_date?i=g(r.doc.resolution_by,r.doc.resolution_date):i=h(r.doc.resolution_by,r.doc.agreement_status),a+=`
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${i.indicator}">
					<span>Time to Resolve: ${i.diff_display}</span>
				</span>
			</div>`}a+="</div>",r.dashboard.set_headline_alert(a)}function h(r,e){let t=moment(r).diff(frappe.datetime.system_datetime(!0)),a=t>=44500?moment.duration(t).humanize():"Failed",i=a=="Failed"&&e!="Fulfilled"?"red":"green";return{diff_display:a,indicator:i}}function g(r,e){return moment(r).diff(moment(e))>=0?{diff_display:"Fulfilled",indicator:"green"}:{diff_display:"Failed",indicator:"red"}}$.extend(erpnext.stock.utils,{set_item_details_using_barcode(r,e,t){new erpnext.utils.BarcodeScanner({frm:r}).scan_api_call(e.barcode,t)},get_serial_range(r,e){if(!r)return;let[t,a]=r.trim().split(e);if(!t||!a)return;let i=parseInt(a),s=t.length-a.length,n=parseInt(t.substring(s));return isNaN(n)||isNaN(i)?void 0:Array(i-n+1).fill(1).map((l,c)=>l+c).map(l=>l+n-1).map(l=>t.substring(0,s)+l.toString().padStart(a.length,"0"))}});frappe.provide("erpnext.queries");$.extend(erpnext.queries,{user:function(){return{query:"frappe.core.doctype.user.user.user_query"}},lead:function(){return{query:"erpnext.controllers.queries.lead_query"}},item:function(r){var e={query:"erpnext.controllers.queries.item_query"};return r&&(e.filters=r),e},bom:function(){return{query:"erpnext.controllers.queries.bom"}},task:function(){return{query:"erpnext.projects.utils.query_task"}},customer_filter:function(r){return r.customer||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(r.doctype,"customer",r.name))])),{filters:{customer:r.customer}}},contact_query:function(r){if(frappe.dynamic_link)return r[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(r.doctype,frappe.dynamic_link.fieldname,r.name))])),{query:"frappe.contacts.doctype.contact.contact.contact_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:r[frappe.dynamic_link.fieldname]}}},address_query:function(r){if(frappe.dynamic_link)return r[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(r.doctype,frappe.dynamic_link.fieldname,r.name))])),{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:r[frappe.dynamic_link.fieldname]}}},company_address_query:function(r){return r.company||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(r.doctype,"company",r.name))])),{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:"Company",link_name:r.company}}},dispatch_address_query:function(r){return{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:"Company",link_name:r.company||""}}},supplier_filter:function(r){return r.supplier||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(r.doctype,"supplier",r.name))])),{filters:{supplier:r.supplier}}},lead_filter:function(r){return r.lead||frappe.throw(__("Please specify a {0}",[__(frappe.meta.get_label(r.doctype,"lead",r.name))])),{filters:{lead:r.lead}}},not_a_group_filter:function(){return{filters:{is_group:0}}},employee:function(){return{query:"erpnext.controllers.queries.employee_query"}},warehouse:function(r){return{filters:[["Warehouse","company","in",["",cstr(r.company)]],["Warehouse","is_group","=",0]]}},get_filtered_dimensions:function(r,e,t,a){let i="";return e.forEach(s=>{i||(i=r[s])}),{query:"erpnext.controllers.queries.get_filtered_dimensions",filters:{dimension:t,account:i,company:a}}}});erpnext.queries.setup_queries=function(r,e,t){var a=this,i=function(s,n){var o=frappe.meta.get_docfields(s,r.doc.name,{fieldtype:"Link",options:e});$.each(o,function(l,c){n?r.set_query(c.fieldname,n,t):r.set_query(c.fieldname,t)})};i(r.doc.doctype),$.each(frappe.meta.get_docfields(r.doc.doctype,r.doc.name,{fieldtype:"Table"}),function(s,n){i(n.options,n.fieldname)})};erpnext.queries.setup_warehouse_query=function(r){r.set_query("warehouse","items",function(e,t,a){var i=locals[t][a],s=erpnext.queries.warehouse(r.doc);return i.item_code&&($.extend(s,{query:"erpnext.controllers.queries.warehouse_query"}),s.filters.push(["Bin","item_code","=",i.item_code])),s})};erpnext.SMSManager=function(e){var t=this;this.setup=function(){var a={Lead:"",Opportunity:"Your enquiry has been logged into the system. Ref No: "+e.name,Quotation:"Quotation "+e.name+" has been sent via email. Thanks!","Sales Order":"Sales Order "+e.name+" has been created against "+(e.quotation_no?"Quote No:"+e.quotation_no:"")+(e.po_no?" for your PO: "+e.po_no:""),"Delivery Note":"Items has been delivered against delivery note: "+e.name+(e.po_no?" for your PO: "+e.po_no:""),"Sales Invoice":"Invoice "+e.name+" has been sent via email "+(e.po_no?" for your PO: "+e.po_no:""),"Material Request":"Material Request "+e.name+" has been raised in the system","Purchase Order":"Purchase Order "+e.name+" has been sent via email","Purchase Receipt":"Items has been received against purchase receipt: "+e.name};["Sales Order","Delivery Note","Sales Invoice"].includes(e.doctype)?this.show(e.contact_person,"Customer",e.customer,"",a[e.doctype]):e.doctype==="Quotation"?this.show(e.contact_person,"Customer",e.party_name,"",a[e.doctype]):["Purchase Order","Purchase Receipt"].includes(e.doctype)?this.show(e.contact_person,"Supplier",e.supplier,"",a[e.doctype]):e.doctype=="Lead"?this.show("","","",e.mobile_no,a[e.doctype]):e.doctype=="Opportunity"?this.show("","","",e.contact_no,a[e.doctype]):e.doctype=="Material Request"&&this.show("","","","",a[e.doctype])},this.get_contact_number=function(a,i,s){frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.get_contact_number",args:{contact_name:a,ref_doctype:i,ref_name:s},callback:function(n){if(n.exc){frappe.msgprint(n.exc);return}t.number=n.message,t.show_dialog()}})},this.show=function(a,i,s,n,o){this.message=o,n?(t.number=n,t.show_dialog()):a?this.get_contact_number(a,i,s):t.show_dialog()},this.show_dialog=function(){t.dialog||t.make_dialog(),t.dialog.set_values({message:t.message,number:t.number}),t.dialog.show()},this.make_dialog=function(){var a=new frappe.ui.Dialog({title:"Send SMS",width:400,fields:[{fieldname:"number",fieldtype:"Data",label:"Mobile Number",reqd:1},{fieldname:"message",fieldtype:"Text",label:"Message",reqd:1},{fieldname:"send",fieldtype:"Button",label:"Send"}]});a.fields_dict.send.input.onclick=function(){var i=a.fields_dict.send.input,s=t.dialog.get_values();s&&($(i).set_working(),frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.send_sms",args:{receiver_list:[s.number],msg:s.message},callback:function(n){if($(i).done_working(),n.exc){frappe.msgprint(n.exc);return}t.dialog.hide()}}))},this.dialog=a},this.setup()};frappe.provide("erpnext.utils");var y=["Quotation","Sales Order","Delivery Note","Sales Invoice"],b=["Supplier Quotation","Purchase Order","Purchase Receipt","Purchase Invoice"];erpnext.utils.get_party_details=function(r,e,t,a){if(e||(e="erpnext.accounts.party.get_party_details"),!t){if(r.doctype!="Purchase Order"&&r.doc.customer||r.doc.party_name&&["Quotation","Opportunity"].includes(r.doc.doctype)){let i="Customer";r.doc.quotation_to&&["Lead","Prospect"].includes(r.doc.quotation_to)&&(i=r.doc.quotation_to),t={party:r.doc.customer||r.doc.party_name,party_type:i,price_list:r.doc.selling_price_list}}else r.doc.supplier&&(t={party:r.doc.supplier,party_type:"Supplier",bill_date:r.doc.bill_date,price_list:r.doc.buying_price_list});if(t||(in_list(y,r.doc.doctype)&&(t={party:r.doc.customer||r.doc.party_name,party_type:"Customer"}),in_list(b,r.doc.doctype)&&(t={party:r.doc.supplier,party_type:"Supplier"})),!t||!t.party)return;t.posting_date=r.doc.posting_date||r.doc.transaction_date,t.fetch_payment_terms_template=cint(!r.doc.ignore_default_payment_terms_template)}in_list(y,r.doc.doctype)&&!t.company_address&&r.doc.company_address&&(t.company_address=r.doc.company_address),in_list(b,r.doc.doctype)&&(!t.company_address&&r.doc.billing_address&&(t.company_address=r.doc.billing_address),!t.shipping_address&&r.doc.shipping_address&&(t.shipping_address=r.doc.shipping_address)),!(frappe.meta.get_docfield(r.doc.doctype,"taxes")&&!erpnext.utils.validate_mandatory(r,"Posting / Transaction Date",t.posting_date,t.party_type=="Customer"?"customer":"supplier"))&&(!erpnext.utils.validate_mandatory(r,"Company",r.doc.company,t.party_type=="Customer"?"customer":"supplier")||(t.currency=r.doc.currency,t.company=r.doc.company,t.doctype=r.doc.doctype,frappe.call({method:e,args:t,callback:function(i){i.message&&(r.supplier_tds=i.message.supplier_tds,r.updating_party_details=!0,frappe.run_serially([()=>r.set_value(i.message),()=>{r.updating_party_details=!1,a&&a(),r.refresh(),erpnext.utils.add_item(r)}]))}})))};erpnext.utils.add_item=function(r){if(r.is_new()){var e=frappe.get_prev_route();if(e[1]==="Item"&&!(r.doc.items&&r.doc.items.length)){var t=r.add_child("items");r.refresh_field("items"),frappe.model.set_value(t.doctype,t.name,"item_code",e[2])}}};erpnext.utils.get_address_display=function(r,e,t,a){if(!r.updating_party_details){if(!e)if(r.doctype!="Purchase Order"&&r.doc.customer)e="customer_address";else if(r.doc.supplier)e="supplier_address";else return;t||(t="address_display"),r.doc[e]?frappe.call({method:"frappe.contacts.doctype.address.address.get_address_display",args:{address_dict:r.doc[e]},callback:function(i){i.message&&r.set_value(t,i.message)}}):r.set_value(t,"")}};erpnext.utils.set_taxes_from_address=function(r,e,t,a){if(!r.updating_party_details){if(frappe.meta.get_docfield(r.doc.doctype,"taxes")){if(!erpnext.utils.validate_mandatory(r,"Lead / Customer / Supplier",r.doc.customer||r.doc.supplier||r.doc.lead||r.doc.party_name,e)||!erpnext.utils.validate_mandatory(r,"Posting / Transaction Date",r.doc.posting_date||r.doc.transaction_date,e))return}else return;frappe.call({method:"erpnext.accounts.party.get_address_tax_category",args:{tax_category:r.doc.tax_category,billing_address:r.doc[t],shipping_address:r.doc[a]},callback:function(i){i.exc||(r.doc.tax_category!=i.message?r.set_value("tax_category",i.message):erpnext.utils.set_taxes(r,e))}})}};erpnext.utils.set_taxes=function(r,e){if(frappe.meta.get_docfield(r.doc.doctype,"taxes")){if(!erpnext.utils.validate_mandatory(r,"Company",r.doc.company,e)||!erpnext.utils.validate_mandatory(r,"Lead / Customer / Supplier",r.doc.customer||r.doc.supplier||r.doc.lead||r.doc.party_name,e)||!erpnext.utils.validate_mandatory(r,"Posting / Transaction Date",r.doc.posting_date||r.doc.transaction_date,e))return}else return;var t,a;r.doc.lead?(t="Lead",a=r.doc.lead):r.doc.customer?(t="Customer",a=r.doc.customer):r.doc.supplier?(t="Supplier",a=r.doc.supplier):r.doc.quotation_to&&(t=r.doc.quotation_to,a=r.doc.party_name),r.doc.company||frappe.throw(__("Kindly select the company first")),frappe.call({method:"erpnext.accounts.party.set_taxes",args:{party:a,party_type:t,posting_date:r.doc.posting_date||r.doc.transaction_date,company:r.doc.company,customer_group:r.doc.customer_group,supplier_group:r.doc.supplier_group,tax_category:r.doc.tax_category,billing_address:r.doc.customer||r.doc.lead?r.doc.customer_address:r.doc.supplier_address,shipping_address:r.doc.shipping_address_name},callback:function(i){i.message&&r.set_value("taxes_and_charges",i.message)}})};erpnext.utils.get_contact_details=function(r){r.updating_party_details||(r.doc.contact_person?frappe.call({method:"frappe.contacts.doctype.contact.contact.get_contact_details",args:{contact:r.doc.contact_person},callback:function(e){e.message&&r.set_value(e.message)}}):r.set_value({contact_person:"",contact_display:"",contact_email:"",contact_mobile:"",contact_phone:"",contact_designation:"",contact_department:""}))};erpnext.utils.validate_mandatory=function(r,e,t,a){return t?!0:(r.doc[a]="",refresh_field(a),frappe.throw({message:__("Please enter {0} first",[e]),title:__("Mandatory")}),!1)};erpnext.utils.get_shipping_address=function(r,e){if(r.doc.company){if((r.doc.inter_company_order_reference||r.doc.internal_invoice_reference||r.doc.internal_order_reference)&&e)return e();frappe.call({method:"erpnext.accounts.custom.address.get_shipping_address",args:{company:r.doc.company,address:r.doc.shipping_address},callback:function(t){if(t.message&&(r.set_value("shipping_address",t.message[0]),r.set_value("shipping_address_display",t.message[1])),e)return e()}})}else frappe.msgprint(__("Select company first"))};frappe.provide("erpnext.stock");erpnext.stock.StockController=class extends frappe.ui.form.Controller{onload(){this.frm.fields_dict.company&&this.setup_warehouse_query()}barcode(e,t,a){let i=locals[t][a];i.barcode&&erpnext.stock.utils.set_item_details_using_barcode(this.frm,i,s=>{frappe.model.set_value(t,a,{item_code:s.message.item_code,qty:1})})}setup_warehouse_query(){var e=this;erpnext.queries.setup_queries(this.frm,"Warehouse",function(){return erpnext.queries.warehouse(e.frm.doc)})}setup_posting_date_time_check(){frappe.ui.form.on(this.frm.doctype,"set_posting_date_and_time_read_only",function(e){e.doc.docstatus==0&&e.doc.set_posting_time?(e.set_df_property("posting_date","read_only",0),e.set_df_property("posting_time","read_only",0)):(e.set_df_property("posting_date","read_only",1),e.set_df_property("posting_time","read_only",1))}),frappe.ui.form.on(this.frm.doctype,"set_posting_time",function(e){e.trigger("set_posting_date_and_time_read_only")}),frappe.ui.form.on(this.frm.doctype,"refresh",function(e){e.doc.docstatus==0&&(e.doc.posting_date||e.set_value("posting_date",frappe.datetime.nowdate()),e.doc.posting_time||e.set_value("posting_time",frappe.datetime.now_time()),e.trigger("set_posting_date_and_time_read_only"))})}show_stock_ledger(){var e=this;this.frm.doc.docstatus>0&&cur_frm.add_custom_button(__("Stock Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:moment(e.frm.doc.modified).format("YYYY-MM-DD"),company:e.frm.doc.company,show_cancelled_entries:e.frm.doc.docstatus===2,ignore_prepared_report:!0},frappe.set_route("query-report","Stock Ledger")},__("View"))}show_general_ledger(){let e=this;this.frm.doc.docstatus>0&&cur_frm.add_custom_button(__("Accounting Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:moment(e.frm.doc.modified).format("YYYY-MM-DD"),company:e.frm.doc.company,group_by:"Group by Voucher (Consolidated)",show_cancelled_entries:e.frm.doc.docstatus===2,ignore_prepared_report:!0},frappe.set_route("query-report","General Ledger")},__("View"))}};erpnext.SerialBatchPackageSelector=class{constructor(e,t,a){var i;this.frm=e,this.item=t,this.qty=t.qty,this.callback=a,this.bundle=(i=this.item)!=null&&i.is_rejected?this.item.rejected_serial_and_batch_bundle:this.item.serial_and_batch_bundle,this.make(),this.render_data()}make(){var i,s,n,o,l;let e=(i=this.item)!=null&&i.has_serial_no?__("Serial Nos"):__("Batch Nos"),t=this.bundle?__("Update"):__("Add");((s=this.item)==null?void 0:s.has_serial_no)&&((n=this.item)==null?void 0:n.has_batch_no)&&(e=__("Serial Nos / Batch Nos")),t+=" "+e,this.dialog=new frappe.ui.Dialog({title:((o=this.item)==null?void 0:o.title)||t,size:"large",fields:this.get_dialog_fields(),primary_action_label:t,primary_action:()=>this.update_bundle_entries(),secondary_action_label:__("Edit Full Form"),secondary_action:()=>this.edit_full_form()}),this.dialog.show(),this.$scan_btn=this.dialog.$wrapper.find(".link-btn"),this.$scan_btn.css("display","inline");let a=this.item.stock_qty||this.item.transfer_qty||this.item.qty;(l=this.item)!=null&&l.is_rejected&&(a=this.item.rejected_qty),a=Math.abs(a),a>0&&this.dialog.set_value("qty",a).then(()=>{if(this.item.serial_no&&!this.item.serial_and_batch_bundle){let c=this.item.serial_no.split(`
`);c.length>1?c.forEach(d=>{this.dialog.fields_dict.entries.df.data.push({serial_no:d,batch_no:this.item.batch_no})}):this.dialog.set_value("scan_serial_no",this.item.serial_no),frappe.model.set_value(this.item.doctype,this.item.name,"serial_no","")}else this.item.batch_no&&!this.item.serial_and_batch_bundle&&(this.dialog.set_value("scan_batch_no",this.item.batch_no),frappe.model.set_value(this.item.doctype,this.item.name,"batch_no",""));this.dialog.fields_dict.entries.grid.refresh()})}get_serial_no_filters(){var t;let e=((t=this.item)==null?void 0:t.type_of_transaction)==="Outward"?this.item.warehouse||this.item.s_warehouse:"";return this.frm.doc.doctype==="Stock Entry"&&(e=this.item.s_warehouse||this.item.t_warehouse),!e&&this.frm.doc.doctype==="Stock Reconciliation"&&(e=this.get_warehouse()),{item_code:this.item.item_code,warehouse:["=",e]}}get_dialog_fields(){var t;let e=[];return e.push({fieldtype:"Link",fieldname:"warehouse",label:__("Warehouse"),options:"Warehouse",default:this.get_warehouse(),onchange:()=>{var a;(a=this.item)!=null&&a.is_rejected?this.item.rejected_warehouse=this.dialog.get_value("warehouse"):this.item.warehouse=this.dialog.get_value("warehouse"),this.get_auto_data()},get_query:()=>({filters:{is_group:0,company:this.frm.doc.company}})}),this.frm.doc.doctype==="Stock Entry"&&this.frm.doc.purpose==="Manufacture"&&(e.push({fieldtype:"Column Break"}),e.push({fieldtype:"Link",fieldname:"work_order",label:__("For Work Order"),options:"Work Order",read_only:1,default:this.frm.doc.work_order}),e.push({fieldtype:"Section Break"})),e.push({fieldtype:"Column Break"}),this.item.has_serial_no&&e.push({fieldtype:"Data",options:"Barcode",fieldname:"scan_serial_no",label:__("Scan Serial No"),get_query:()=>({filters:this.get_serial_no_filters()}),onchange:()=>this.scan_barcode_data()}),this.item.has_batch_no&&!this.item.has_serial_no&&e.push({fieldtype:"Data",options:"Barcode",fieldname:"scan_batch_no",label:__("Scan Batch No"),onchange:()=>this.scan_barcode_data()}),((t=this.item)==null?void 0:t.type_of_transaction)==="Outward"?e=[...this.get_filter_fields(),...e]:e=[...e,...this.get_attach_field()],e.push({fieldtype:"Section Break",depends_on:"eval:doc.enter_manually !== 1 || doc.entries?.length > 0"}),e.push({fieldname:"entries",fieldtype:"Table",allow_bulk_edit:!0,depends_on:"eval:doc.enter_manually !== 1 || doc.entries?.length > 0",data:[],fields:this.get_dialog_table_fields()}),e}get_attach_field(){var s,n,o,l,c;let e=this,t=(s=this.item)!=null&&s.has_serial_no?__("Serial Nos"):__("Batch Nos"),a=this.bundle?__("Update"):__("Add");((n=this.item)==null?void 0:n.has_serial_no)&&((o=this.item)==null?void 0:o.has_batch_no)&&(t=__("Serial Nos / Batch Nos"));let i=[];return this.item.has_serial_no&&i.push({fieldtype:"Check",label:__("Enter Manually"),fieldname:"enter_manually",default:1,depends_on:"eval:doc.import_using_csv_file !== 1",change(){e.dialog.get_value("enter_manually")&&e.dialog.set_value("import_using_csv_file",0)}}),i=[...i,{fieldtype:"Check",label:__("Import Using CSV file"),fieldname:"import_using_csv_file",depends_on:"eval:doc.enter_manually !== 1",default:this.item.has_serial_no?0:1,change(){e.dialog.get_value("import_using_csv_file")&&e.dialog.set_value("enter_manually",0)}},{fieldtype:"Section Break",depends_on:"eval:doc.import_using_csv_file === 1",label:__("{0} {1} via CSV File",[a,t])},{fieldtype:"Button",fieldname:"download_csv",label:__("Download CSV Template"),click:()=>this.download_csv_file()},{fieldtype:"Column Break"},{fieldtype:"Attach",fieldname:"attach_serial_batch_csv",label:__("Attach CSV File"),onchange:()=>this.upload_csv_file()}],(l=this.item)!=null&&l.has_serial_no&&(i=[...i,{fieldtype:"Section Break",label:__("{0} {1} Manually",[a,t]),depends_on:"eval:doc.enter_manually === 1"},{fieldtype:"Data",label:__("Serial No Range"),fieldname:"serial_no_range",depends_on:"eval:doc.enter_manually === 1 && !doc.serial_no_series",description:__('"SN-01::10" for "SN-01" to "SN-10"'),onchange:()=>{this.set_serial_nos_from_range()}}]),(c=this.item)!=null&&c.has_serial_no&&(i=[...i,{fieldtype:"Column Break",depends_on:"eval:doc.enter_manually === 1"},{fieldtype:"Small Text",label:__("Enter Serial Nos"),fieldname:"upload_serial_nos",depends_on:"eval:doc.enter_manually === 1",description:__("Enter each serial no in a new line")}]),i}set_serial_nos_from_range(){let e=this.dialog.get_value("serial_no_range");if(!e)return;let t=erpnext.stock.utils.get_serial_range(e,"::");t&&this.dialog.set_value("upload_serial_nos",t.join(`
`))}create_serial_nos(){let{upload_serial_nos:e}=this.dialog.get_values();e||frappe.throw(__("Please enter Serial Nos")),frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.create_serial_nos",args:{item_code:this.item.item_code,serial_nos:e},callback:t=>{t.message&&(this.dialog.fields_dict.entries.df.data=[],this.set_data(t.message),this.update_bundle_entries())}})}download_csv_file(){let e=["Serial No"];this.item.has_serial_no&&this.item.has_batch_no?e=["Serial No","Batch No","Quantity"]:this.item.has_batch_no&&(e=["Batch No","Quantity"]);let t=`/api/method/erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.download_blank_csv_template?content=${encodeURIComponent(JSON.stringify(e))}`;window.open(frappe.urllib.get_full_url(t))||frappe.msgprint(__("Please enable pop-ups"))}upload_csv_file(){let e=this.dialog.get_value("attach_serial_batch_csv");frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.upload_csv_file",args:{item_code:this.item.item_code,file_path:e},callback:t=>{t.message.serial_nos&&t.message.serial_nos.length?this.set_data(t.message.serial_nos):t.message.batch_nos&&t.message.batch_nos.length&&this.set_data(t.message.batch_nos)}})}get_filter_fields(){return[{fieldtype:"Section Break",label:__("Auto Fetch")},{fieldtype:"Float",fieldname:"qty",label:__("Qty to Fetch"),onchange:()=>this.get_auto_data()},{fieldtype:"Column Break"},{fieldtype:"Select",options:["FIFO","LIFO","Expiry"],default:"FIFO",fieldname:"based_on",label:__("Fetch Based On"),onchange:()=>this.get_auto_data()},{fieldtype:"Section Break"}]}get_batch_qty(e,t){let a=this.item.s_warehouse||this.item.t_warehouse||this.item.warehouse;frappe.call({method:"erpnext.stock.doctype.batch.batch.get_batch_qty",args:{batch_no:e,warehouse:a,item_code:this.item.item_code,posting_date:this.frm.doc.posting_date,posting_time:this.frm.doc.posting_time},callback:i=>{i.message&&t(flt(i.message))}})}get_dialog_table_fields(){let e=[],t=this;this.item.has_serial_no&&e.push({fieldtype:"Link",options:"Serial No",fieldname:"serial_no",label:__("Serial No"),in_list_view:1,get_query:()=>({filters:this.get_serial_no_filters()})});let a=[];return this.item.has_batch_no&&(a=[{fieldtype:"Link",options:"Batch",fieldname:"batch_no",label:__("Batch No"),in_list_view:1,get_route_options_for_new_doc:()=>({item:this.item.item_code}),change(){let i=this.doc;!i.qty&&t.item.type_of_transaction==="Outward"&&t.get_batch_qty(i.batch_no,s=>{i.qty=s,this.grid.set_value("qty",s,i)})},get_query:()=>{let i=!1;(["Purchase Receipt","Purchase Invoice"].includes(this.frm.doc.doctype)&&!this.frm.doc.is_return||this.frm.doc.doctype==="Stock Entry"&&this.frm.doc.purpose==="Material Receipt")&&(i=!0);let s=t.include_expired_batches();return{query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:this.item.item_code,warehouse:this.item.s_warehouse||this.item.t_warehouse||this.item.warehouse,is_inward:i,include_expired_batches:s}}}}],this.item.has_serial_no||a.push({fieldtype:"Float",fieldname:"qty",label:__("Quantity"),in_list_view:1})),e=[...e,...a],e.push({fieldtype:"Data",fieldname:"name",label:__("Name"),hidden:1}),e}include_expired_batches(){return this.frm.doc.doctype==="Stock Reconciliation"||this.frm.doc.doctype==="Stock Entry"&&["Material Receipt","Material Transfer","Material Issue"].includes(this.frm.doc.purpose)}get_auto_data(){var i;let{qty:e,based_on:t}=this.dialog.get_values();if((this.item.serial_and_batch_bundle||this.item.rejected_serial_and_batch_bundle)&&this.qty&&e===Math.abs(this.qty)||this.item.serial_no||this.item.batch_no)return;t||(t="FIFO");let a=this.item.warehouse||this.item.s_warehouse;(i=this.item)!=null&&i.is_rejected&&(a=this.item.rejected_warehouse),e&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_auto_data",args:{item_code:this.item.item_code,warehouse:a,has_serial_no:this.item.has_serial_no,has_batch_no:this.item.has_batch_no,qty:e,based_on:t},callback:s=>{s.message&&(this.dialog.fields_dict.entries.df.data=s.message,this.dialog.fields_dict.entries.grid.refresh())}})}scan_barcode_data(){let{scan_serial_no:e,scan_batch_no:t}=this.dialog.get_values();this.dialog.set_value("enter_manually",0),(e||t)&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.is_serial_batch_no_exists",args:{item_code:this.item.item_code,type_of_transaction:this.item.type_of_transaction,serial_no:e,batch_no:t},callback:a=>{this.update_serial_batch_no()}})}update_serial_batch_no(){let{scan_serial_no:e,scan_batch_no:t}=this.dialog.get_values();if(e){let a=this.dialog.fields_dict.entries.df.data.filter(i=>{if(i.serial_no===e)return i});a!=null&&a.length&&frappe.throw(__("Serial No {0} already exists",[e])),this.item.has_batch_no?frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_batch_no_from_serial_no",args:{serial_no:e},callback:i=>{this.dialog.fields_dict.entries.df.data.push({serial_no:e,batch_no:i.message}),this.dialog.fields_dict.scan_serial_no.set_value(""),this.dialog.fields_dict.entries.grid.refresh()}}):(this.dialog.fields_dict.entries.df.data.push({serial_no:e}),this.dialog.fields_dict.scan_serial_no.set_value(""))}else if(t){let a=this.dialog.fields_dict.entries.df.data.filter(i=>{if(i.batch_no===t)return i});a!=null&&a.length?a[0].qty+=1:this.dialog.fields_dict.entries.df.data.push({batch_no:t,qty:1}),this.dialog.fields_dict.scan_batch_no.set_value("")}this.dialog.fields_dict.entries.grid.refresh()}update_bundle_entries(){var i;let e=this.dialog.get_values().entries,t=this.dialog.get_value("warehouse"),a=this.dialog.get_value("upload_serial_nos");if(!(e!=null&&e.length)&&a){this.create_serial_nos();return}(e&&!e.length||!e)&&frappe.throw(__("Please add atleast one Serial No / Batch No")),t||frappe.throw(__("Please select a Warehouse")),((i=this.item)==null?void 0:i.is_rejected)&&this.item.rejected_warehouse===this.item.warehouse&&frappe.throw(__("Rejected Warehouse and Accepted Warehouse cannot be same.")),frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.add_serial_batch_ledgers",args:{entries:e,child_row:this.item,doc:this.frm.doc,warehouse:t}}).then(s=>{frappe.run_serially([()=>{this.callback&&this.callback(s.message)},()=>this.frm.save(),()=>this.dialog.hide()])})}edit_full_form(){let e=this.item.serial_and_batch_bundle;if(!e){let t=frappe.model.get_new_doc("Serial and Batch Bundle",null,null,!0);t.item_code=this.item.item_code,t.warehouse=this.get_warehouse(),t.has_serial_no=this.item.has_serial_no,t.has_batch_no=this.item.has_batch_no,t.type_of_transaction=this.item.type_of_transaction,t.company=this.frm.doc.company,t.voucher_type=this.frm.doc.doctype,e=t.name}frappe.set_route("Form","Serial and Batch Bundle",e),this.dialog.hide()}get_warehouse(){var e,t;return(e=this.item)!=null&&e.is_rejected?this.item.rejected_warehouse:((t=this.item)==null?void 0:t.type_of_transaction)==="Outward"?this.item.warehouse||this.item.s_warehouse:this.item.warehouse||this.item.t_warehouse}render_data(){(this.bundle||this.frm.doc.is_return)&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_serial_batch_ledgers",args:{item_code:this.item.item_code,name:this.bundle,voucher_no:this.frm.is_new()?"":this.item.parent,child_row:this.frm.doc.is_return?this.item:""}}).then(e=>{e.message&&this.set_data(e.message)})}set_data(e){var t;e.forEach(a=>{a.qty=Math.abs(a.qty),a.name=a.child_row||a.name,this.dialog.fields_dict.entries.df.data.push(a)}),this.dialog.fields_dict.entries.grid.refresh(),(t=this.dialog.fields_dict.entries.df.data)!=null&&t.length&&this.dialog.set_value("enter_manually",0)}};erpnext.payments=class extends erpnext.stock.StockController{make_payment(){var e=this;this.dialog=new frappe.ui.Dialog({title:"Payment"}),this.dialog.show(),this.$body=this.dialog.body,this.set_payment_primary_action(),this.make_keyboard(),this.select_text()}select_text(){$(this.$body).find(".form-control").click(function(){$(this).select()})}set_payment_primary_action(){var e=this;this.dialog.set_primary_action(__("Submit"),function(){$.each(e.frm.doc.payments,function(t,a){if(a.amount!=0){e.dialog.hide(),e.submit_invoice();return}})})}make_keyboard(){var e=this;$(this.$body).empty(),$(this.$body).html(frappe.render_template("pos_payment",this.frm.doc)),this.show_payment_details(),this.bind_keyboard_event(),this.clear_amount()}make_multimode_payment(){var e=this;this.frm.doc.change_amount>0&&(e.payment_val=e.doc.outstanding_amount),this.payments=frappe.model.add_child(this.frm.doc,"Multi Mode Payment","payments"),this.payments.mode_of_payment=this.dialog.fields_dict.mode_of_payment.get_value(),this.payments.amount=flt(this.payment_val)}show_payment_details(){var e=this,t=$(this.$body).find(".multimode-payments").empty();this.frm.doc.payments.length?$.each(this.frm.doc.payments,function(a,i){$(frappe.render_template("payment_details",{mode_of_payment:i.mode_of_payment,amount:i.amount,idx:i.idx,currency:e.frm.doc.currency,type:i.type})).appendTo(t),i.type=="Cash"&&i.amount==e.frm.doc.paid_amount&&(e.idx=i.idx,e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.highlight_selected_row(),e.bind_amount_change_event())}):$("<p>No payment mode selected in pos profile</p>").appendTo(t)}set_outstanding_amount(){this.selected_mode=$(this.$body).find(repl("input[idx='%(idx)s']",{idx:this.idx})),this.highlight_selected_row(),this.payment_val=0,this.frm.doc.outstanding_amount>0&&flt(this.selected_mode.val())==0?(this.payment_val=flt(this.frm.doc.outstanding_amount/this.frm.doc.conversion_rate,precision("outstanding_amount")),this.selected_mode.val(format_currency(this.payment_val,this.frm.doc.currency)),this.update_payment_amount()):flt(this.selected_mode.val())>0&&(this.payment_val=flt(this.selected_mode.val())),this.selected_mode.select(),this.bind_amount_change_event()}bind_keyboard_event(){var e=this;this.payment_val="",this.bind_form_control_event(),this.bind_numeric_keys_event()}bind_form_control_event(){var e=this;$(this.$body).find(".pos-payment-row").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount()}),$(this.$body).find(".form-control").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount(),e.update_paid_amount(!0)}),$(this.$body).find(".write_off_amount").change(function(){e.write_off_amount(flt($(this).val()),precision("write_off_amount"))}),$(this.$body).find(".change_amount").change(function(){e.change_amount(flt($(this).val()),precision("change_amount"))})}highlight_selected_row(){var e=$(this.$body).find(repl(".pos-payment-row[idx='%(idx)s']",{idx:this.idx}));$(this.$body).find(".pos-payment-row").removeClass("selected-payment-mode"),e.addClass("selected-payment-mode"),$(this.$body).find(".amount").attr("disabled",!0),this.selected_mode.attr("disabled",!1)}bind_numeric_keys_event(){var e=this;$(this.$body).find(".pos-keyboard-key").click(function(){e.payment_val+=$(this).text(),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()}),$(this.$body).find(".delete-btn").click(function(){e.payment_val=cstr(flt(e.selected_mode.val())).slice(0,-1),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()})}bind_amount_change_event(){var e=this;this.selected_mode.change(function(){e.payment_val=flt($(this).val())||0,e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_payment_amount()})}clear_amount(){var e=this;$(this.$body).find(".clr").click(function(t){t.stopPropagation(),e.idx=$(this).attr("idx"),e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.payment_val=0,e.selected_mode.val(0),e.highlight_selected_row(),e.update_payment_amount()})}write_off_amount(e){this.frm.doc.write_off_amount=flt(e,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount")),this.calculate_outstanding_amount(!1),this.show_amounts()}change_amount(e){var t=this;this.frm.doc.change_amount=flt(e,precision("change_amount")),this.calculate_write_off_amount(),this.show_amounts()}update_paid_amount(e){var t=this;if(["change_amount","write_off_amount"].includes(this.idx)){var a=t.selected_mode.val();t.idx=="change_amount"?t.change_amount(a):(flt(a)==0&&e&&t.frm.doc.outstanding_amount>0&&(a=flt(t.frm.doc.outstanding_amount/t.frm.doc.conversion_rate,precision(t.idx))),t.write_off_amount(a))}else this.update_payment_amount()}update_payment_amount(){var e=this;$.each(this.frm.doc.payments,function(t,a){cint(e.idx)==cint(a.idx)&&(a.amount=flt(e.selected_mode.val(),2))}),this.calculate_outstanding_amount(!1),this.show_amounts()}show_amounts(){var e=this;$(this.$body).find(".write_off_amount").val(format_currency(this.frm.doc.write_off_amount,this.frm.doc.currency)),$(this.$body).find(".paid_amount").text(format_currency(this.frm.doc.paid_amount,this.frm.doc.currency)),$(this.$body).find(".change_amount").val(format_currency(this.frm.doc.change_amount,this.frm.doc.currency)),$(this.$body).find(".outstanding_amount").text(format_currency(this.frm.doc.outstanding_amount,frappe.get_doc(":Company",this.frm.doc.company).default_currency)),this.update_invoice()}};frappe.templates.visual_plant_floor_template=`{% $.each(workstations, (idx, row) => { %}
	<div class="workstation-wrapper">
		<div class="workstation-status text-right">
			{% if(row.status == "Production") { %}
				<div class="ring-container">
					<div class="ringring"></div>
					<div class="circle"></div>
				</div>
			{% } %}
			<span class="indicator-pill no-indicator-dot whitespace-nowrap {{row.color}}" style="margin: 3px 4px 0px 0px;">
				<span style="font-size:13px">{{row.status}}</span>
			</span>
		</div>
		<div class="workstation-image">
			<div class="flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100">
				<a class="workstation-image-link" href="{{row.workstation_link}}">
					{% if(row.status_image) { %}
						<img class="workstation-image-cls" src="{{row.status_image}}">
					{% } else { %}
						<div class="workstation-image-cls workstation-abbr">{{frappe.get_abbr(row.name, 2)}}</div>
					{% } %}
				</a>
			</div>
		</div>
		<div class="workstation-card" style="display: grid;">
			<span class="ellipsis" title="{{row.name}}">
				{{row.workstation_name}}
			</span>
		</div>
	</div>
{% }); %}
`;var f=class{constructor({wrapper:e,skip_filters:t=!1,plant_floor:a=null},i=null){this.wrapper=e,this.plant_floor=a,this.skip_filters=t,this.make(),this.skip_filters||(this.page=i,this.add_filter(),this.prepare_menu())}make(){this.wrapper.append(`
			<div class="plant-floor">
				<div class="plant-floor-filter">
				</div>
				<div class="plant-floor-container col-sm-12">
				</div>
			</div>
		`),this.skip_filters?this.plant_floor&&(this.wrapper.find(".plant-floor").css("border","none"),this.prepare_data()):(this.filter_wrapper=this.wrapper.find(".plant-floor-filter"),this.visualization_wrapper=this.wrapper.find(".plant-floor-visualization"))}prepare_data(){frappe.call({method:"erpnext.manufacturing.doctype.workstation.workstation.get_workstations",args:{plant_floor:this.plant_floor},callback:e=>{this.workstations=e.message,this.render_workstations()}})}add_filter(){this.plant_floor=frappe.ui.form.make_control({df:{fieldtype:"Link",options:"Plant Floor",fieldname:"plant_floor",label:__("Plant Floor"),reqd:1,onchange:()=>{this.render_plant_visualization()}},parent:this.filter_wrapper,render_input:!0}),this.plant_floor.$wrapper.addClass("form-column col-sm-2"),this.workstation_type=frappe.ui.form.make_control({df:{fieldtype:"Link",options:"Workstation Type",fieldname:"workstation_type",label:__("Machine Type"),onchange:()=>{this.render_plant_visualization()}},parent:this.filter_wrapper,render_input:!0}),this.workstation_type.$wrapper.addClass("form-column col-sm-2"),this.workstation=frappe.ui.form.make_control({df:{fieldtype:"Link",options:"Workstation",fieldname:"workstation",label:__("Machine"),onchange:()=>{this.render_plant_visualization()},get_query:()=>{if(this.workstation_type.get_value())return{filters:{workstation_type:this.workstation_type.get_value()||""}}}},parent:this.filter_wrapper,render_input:!0}),this.workstation.$wrapper.addClass("form-column col-sm-2"),this.workstation_status=frappe.ui.form.make_control({df:{fieldtype:"Select",options:`
Production
Off
Idle
Problem
Maintenance
Setup`,fieldname:"workstation_status",label:__("Status"),onchange:()=>{this.render_plant_visualization()}},parent:this.filter_wrapper,render_input:!0})}render_plant_visualization(){let e=this.plant_floor.get_value();e&&frappe.call({method:"erpnext.manufacturing.doctype.workstation.workstation.get_workstations",args:{plant_floor:e,workstation_type:this.workstation_type.get_value(),workstation:this.workstation.get_value(),workstation_status:this.workstation_status.get_value()},callback:t=>{this.workstations=t.message,this.render_workstations()}})}render_workstations(){this.wrapper.find(".plant-floor-container").empty();let e=frappe.render_template("visual_plant_floor_template",{workstations:this.workstations});$(e).appendTo(this.wrapper.find(".plant-floor-container"))}prepare_menu(){this.page.add_menu_item(__("Refresh"),()=>{this.render_plant_visualization()})}};frappe.ui.VisualPlantFloor=f;erpnext.taxes_and_totals=class extends erpnext.payments{setup(){this.fetch_round_off_accounts()}apply_pricing_rule_on_item(e){let t=e.price_list_rate,a=e.rate;["Sales Order","Quotation"].includes(e.parenttype)&&e.blanket_order_rate&&(t=e.blanket_order_rate),e.margin_type=="Percentage"?e.rate_with_margin=flt(t)+flt(t)*(flt(e.margin_rate_or_amount)/100):e.rate_with_margin=flt(t)+flt(e.margin_rate_or_amount),e.base_rate_with_margin=flt(e.rate_with_margin)*flt(this.frm.doc.conversion_rate),a=flt(e.rate_with_margin,precision("rate",e)),e.discount_percentage&&!e.discount_amount&&(e.discount_amount=flt(e.rate_with_margin)*flt(e.discount_percentage)/100),e.discount_amount>0&&(a=flt(e.rate_with_margin-e.discount_amount,precision("rate",e)),e.discount_percentage=100*flt(e.discount_amount)/flt(e.rate_with_margin)),frappe.model.set_value(e.doctype,e.name,"rate",a)}async calculate_taxes_and_totals(e){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),this.frm.doc.apply_discount_on=="Grand Total"&&this.frm.doc.is_cash_or_non_trade_discount&&(this.frm.doc.grand_total-=this.frm.doc.discount_amount,this.frm.doc.base_grand_total-=this.frm.doc.base_discount_amount,this.frm.doc.rounding_adjustment=0,this.frm.doc.base_rounding_adjustment=0,this.set_rounded_total()),await this.calculate_shipping_charges(),["Sales Invoice","POS Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(e),["Sales Invoice","POS Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.is_pos&&this.frm.doc.is_return&&(this.set_total_amount_to_default_mop(),this.calculate_paid_amount()),["Quotation","Sales Order","Delivery Note","Sales Invoice"].includes(this.frm.doc.doctype)&&(this.calculate_commission(),this.calculate_contribution()),this.frm.doc.doctype==="Purchase Invoice"&&this.frm.doc.is_return&&this.frm.doc.grand_total>this.frm.doc.paid_amount&&(this.frm.doc.paid_amount=flt(this.frm.doc.grand_total,precision("grand_total"))),this.frm.refresh_fields()}calculate_discount_amount(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.set_discount_amount(),this.apply_discount_amount())}_calculate_taxes_and_totals(){let e=this.frm.doc.doctype=="Quotation";this.frm._items=e?this.filtered_items():this.frm.doc.items,this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.adjust_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()}validate_conversion_rate(){this.frm.doc.conversion_rate=flt(this.frm.doc.conversion_rate,cur_frm?precision("conversion_rate"):9);var e=frappe.meta.get_label(this.frm.doc.doctype,"conversion_rate",this.frm.doc.name),t=this.get_company_currency();if(!this.frm.doc.conversion_rate)if(this.frm.doc.currency==t)this.frm.set_value("conversion_rate",1);else{let a=[e,this.frm.doc.currency,t],i=__("{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}",a);frappe.throw(i)}}calculate_item_values(){var e=this;if(!this.discount_amount_applied)for(let t of this.frm.doc.items||[]){if(frappe.model.round_floats_in(t),t.net_rate=t.rate,t.qty=t.qty===void 0?e.frm.doc.is_return?-1:1:t.qty,!(e.frm.doc.is_return||e.frm.doc.is_debit_note))t.net_amount=t.amount=flt(t.rate*t.qty,precision("amount",t));else{let a=flt(t.qty);a||(a=e.frm.doc.is_debit_note?1:-1,e.frm.doc.doctype!=="Purchase Receipt"&&e.frm.doc.is_return===1&&(a=flt(t.qty))),t.net_amount=t.amount=flt(t.rate*a,precision("amount",t))}t.item_tax_amount=0,t.total_weight=flt(t.weight_per_unit*t.stock_qty),e.set_in_company_currency(t,["price_list_rate","rate","amount","net_rate","net_amount"])}}set_in_company_currency(e,t){var a=this;$.each(t,function(i,s){e["base_"+s]=flt(flt(e[s],precision(s,e))*a.frm.doc.conversion_rate,precision("base_"+s,e))})}initialize_taxes(){var e=this;$.each(this.frm.doc.taxes||[],function(t,a){a.dont_recompute_tax||(a.item_wise_tax_detail={});var i=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];cstr(a.charge_type)!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&i.push("tax_amount"),$.each(i,function(s,n){a[n]=0}),this.discount_amount_applied||(erpnext.accounts.taxes.validate_taxes_and_charges(a.doctype,a.name),erpnext.accounts.taxes.validate_inclusive_tax(a,this.frm)),frappe.model.round_floats_in(a)})}fetch_round_off_accounts(){let e=this;frappe.flags.round_off_applicable_accounts=[],e.frm.doc.company&&frappe.call({method:"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts",args:{company:e.frm.doc.company,account_list:frappe.flags.round_off_applicable_accounts},callback(t){t.message&&frappe.flags.round_off_applicable_accounts.push(...t.message)}}),frappe.call({method:"erpnext.controllers.taxes_and_totals.get_rounding_tax_settings",callback:function(t){frappe.flags.round_off_settings=t.message}})}determine_exclusive_rate(){var e=this,t=!1;$.each(e.frm.doc.taxes||[],function(a,i){cint(i.included_in_print_rate)&&(t=!0)}),t!=!1&&$.each(this.frm.doc.items||[],function(a,i){var s=e._load_item_tax_rate(i.item_tax_rate),n=0,o=0;if($.each(e.frm.doc.taxes||[],function(c,d){var p=e.get_current_tax_fraction(d,s);d.tax_fraction_for_current_item=p[0];var u=p[1];c==0?d.grand_total_fraction_for_current_item=1+d.tax_fraction_for_current_item:d.grand_total_fraction_for_current_item=e.frm.doc.taxes[c-1].grand_total_fraction_for_current_item+d.tax_fraction_for_current_item,n+=d.tax_fraction_for_current_item,o+=u*flt(i.qty)}),!e.discount_amount_applied&&i.qty&&(o||n)){var l=flt(i.amount)-o;i.net_amount=flt(l/(1+n),precision("net_amount",i)),i.net_rate=i.qty?flt(i.net_amount/i.qty,precision("net_rate",i)):0,e.set_in_company_currency(i,["net_rate","net_amount"])}})}get_current_tax_fraction(e,t){var a=0,i=0;if(cint(e.included_in_print_rate)){var s=this._get_tax_rate(e,t);e.charge_type=="On Net Total"?a=s/100:e.charge_type=="On Previous Row Amount"?a=s/100*this.frm.doc.taxes[cint(e.row_id)-1].tax_fraction_for_current_item:e.charge_type=="On Previous Row Total"?a=s/100*this.frm.doc.taxes[cint(e.row_id)-1].grand_total_fraction_for_current_item:e.charge_type=="On Item Quantity"&&(i=flt(s))}return e.add_deduct_tax&&e.add_deduct_tax=="Deduct"&&(a*=-1,i*=-1),[a,i]}_get_tax_rate(e,t){return Object.keys(t).indexOf(e.account_head)!=-1?flt(t[e.account_head],precision("rate",e)):e.rate}calculate_net_total(){var e=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm._items||[],function(t,a){e.frm.doc.total+=a.amount,e.frm.doc.total_qty+=a.qty,e.frm.doc.base_total+=a.base_amount,e.frm.doc.net_total+=a.net_amount,e.frm.doc.base_net_total+=a.base_net_amount}),frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"])}calculate_shipping_charges(){if(!this.frm.doc.is_pos&&(frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"]),frappe.meta.get_docfield(this.frm.doc.doctype,"shipping_rule",this.frm.doc.name)))return this.shipping_rule()}add_taxes_from_item_tax_template(e){let t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(a,i){if(!(t.frm.doc.taxes||[]).find(n=>n.account_head===a)){let n=frappe.model.add_child(t.frm.doc,"taxes");n.charge_type="On Net Total",n.account_head=a,n.rate=0}}))}calculate_taxes(){var e=this;this.frm.doc.rounding_adjustment=0;var t={};$.each(this.frm.doc.taxes||[],function(a,i){i.charge_type=="Actual"&&(t[i.idx]=flt(i.tax_amount,precision("tax_amount",i)))}),$.each(this.frm._items||[],function(a,i){var s=e._load_item_tax_rate(i.item_tax_rate);$.each(e.frm.doc.taxes||[],function(n,o){var l=e.get_current_tax_amount(i,o,s);frappe.flags.round_row_wise_tax&&(l=flt(l,precision("tax_amount",o))),o.charge_type=="Actual"&&(t[o.idx]-=l,a==e.frm._items.length-1&&(l+=t[o.idx])),o.charge_type!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&(o.tax_amount+=l),o.tax_amount_for_current_item=l,o.tax_amount_after_discount_amount+=l,o.category&&(l=o.category=="Valuation"?0:l,l*=o.add_deduct_tax=="Deduct"?-1:1),n==0?o.grand_total_for_current_item=flt(i.net_amount+l):o.grand_total_for_current_item=flt(e.frm.doc.taxes[n-1].grand_total_for_current_item+l),a==e.frm._items.length-1&&(e.round_off_totals(o),e.set_in_company_currency(o,["tax_amount","tax_amount_after_discount_amount"]),e.round_off_base_values(o),e.set_cumulative_total(n,o),e.set_in_company_currency(o,["total"]),n==e.frm.doc.taxes.length-1&&e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total"&&e.frm.doc.discount_amount&&(e.frm.doc.rounding_adjustment=flt(e.frm.doc.grand_total-flt(e.frm.doc.discount_amount)-o.total,precision("rounding_adjustment"))))})})}set_cumulative_total(e,t){var a=t.tax_amount_after_discount_amount;t.category=="Valuation"&&(a=0),t.add_deduct_tax=="Deduct"&&(a=-1*a),e==0?t.total=flt(this.frm.doc.net_total+a,precision("total",t)):t.total=flt(this.frm.doc.taxes[e-1].total+a,precision("total",t))}_load_item_tax_rate(e){return e?JSON.parse(e):{}}get_current_tax_amount(e,t,a){var i=this._get_tax_rate(t,a),s=0;if(["On Previous Row Amount","On Previous Row Total"].includes(t.charge_type)&&(t.idx===1&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),t.row_id||(t.row_id=t.idx-1)),t.charge_type=="Actual"){var n=flt(t.tax_amount,precision("tax_amount",t));s=this.frm.doc.net_total?e.net_amount/this.frm.doc.net_total*n:0}else t.charge_type=="On Net Total"?s=i/100*e.net_amount:t.charge_type=="On Previous Row Amount"?s=i/100*this.frm.doc.taxes[cint(t.row_id)-1].tax_amount_for_current_item:t.charge_type=="On Previous Row Total"?s=i/100*this.frm.doc.taxes[cint(t.row_id)-1].grand_total_for_current_item:t.charge_type=="On Item Quantity"&&(s=i*e.qty);return t.dont_recompute_tax||this.set_item_wise_tax(e,t,i,s),s}set_item_wise_tax(e,t,a,i){let s=t.item_wise_tax_detail,n=e.item_code||e.item_name;typeof s=="string"&&(t.item_wise_tax_detail=JSON.parse(t.item_wise_tax_detail),s=t.item_wise_tax_detail);let o=i*this.frm.doc.conversion_rate;frappe.flags.round_row_wise_tax?(o=flt(o,precision("tax_amount",t)),s&&s[n]&&(o+=flt(s[n][1],precision("tax_amount",t)))):s&&s[n]&&(o+=s[n][1]),s[n]=[a,flt(o,precision("base_tax_amount",t))]}round_off_totals(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.tax_amount=Math.round(e.tax_amount),e.tax_amount_after_discount_amount=Math.round(e.tax_amount_after_discount_amount)),e.tax_amount=flt(e.tax_amount,precision("tax_amount",e)),e.tax_amount_after_discount_amount=flt(e.tax_amount_after_discount_amount,precision("tax_amount",e))}round_off_base_values(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.base_tax_amount=Math.round(e.base_tax_amount),e.base_tax_amount_after_discount_amount=Math.round(e.base_tax_amount_after_discount_amount))}manipulate_grand_total_for_inclusive_tax(){this.adjust_grand_total_for_inclusive_tax()}adjust_grand_total_for_inclusive_tax(){var e=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=!1;if($.each(this.frm.doc.taxes||[],function(n,o){cint(o.included_in_print_rate)&&(t=!0)}),t){var a=e.frm.doc.taxes.slice(-1)[0],i=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(n){if(!n.included_in_print_rate)return flt(n.tax_amount_after_discount_amount)})),s=e.frm.doc.total+i-flt(a.total,precision("grand_total"));e.discount_amount_applied&&e.frm.doc.discount_amount&&(s-=flt(e.frm.doc.discount_amount)),s=flt(s,precision("rounding_adjustment")),s&&Math.abs(s)<=5/Math.pow(10,precision("tax_amount",a))?e.frm.doc.grand_total_diff=s:e.frm.doc.grand_total_diff=0}}}calculate_totals(){var e=this,t=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(t?this.frm.doc.taxes[t-1].total+flt(this.frm.doc.grand_total_diff):this.frm.doc.net_total),["Quotation","Sales Order","Delivery Note","Sales Invoice","POS Invoice"].includes(this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,t&&($.each(this.frm.doc.taxes||[],function(a,i){["Valuation and Total","Total"].includes(i.category)&&(i.add_deduct_tax=="Add"?e.frm.doc.taxes_and_charges_added+=flt(i.tax_amount_after_discount_amount):e.frm.doc.taxes_and_charges_deducted+=flt(i.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()}set_rounded_total(){var e=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?e=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(e=frappe.sys_defaults.disable_rounded_total),cint(e)){this.frm.doc.rounded_total=0,this.frm.doc.base_rounded_total=0;return}frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))}_cleanup(){this.frm.doc.base_in_words=this.frm.doc.in_words="";let e=this.frm.doc.items;if(e&&e.length&&(frappe.meta.get_docfield(e[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(e||[],function(a,i){delete i.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||t.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(a,i){$.each(t,function(s,n){delete i[n]}),i.dont_recompute_tax||(i.item_wise_tax_detail=JSON.stringify(i.item_wise_tax_detail))})}}set_discount_amount(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))}apply_discount_amount(){var e=this,t=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){if(this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount")),this.frm.doc.apply_discount_on=="Grand Total"&&this.frm.doc.is_cash_or_non_trade_discount)return;var a=this.get_total_for_discount_amount(),i=0;a&&($.each(this.frm._items||[],function(s,n){if(t=flt(e.frm.doc.discount_amount)*n.net_amount/a,n.net_amount=flt(n.net_amount-t,precision("net_amount",n)),i+=n.net_amount,(!(e.frm.doc.taxes||[]).length||a==e.frm.doc.net_total||e.frm.doc.apply_discount_on=="Net Total")&&s==(e.frm._items||[]).length-1){var o=flt(e.frm.doc.net_total-i-e.frm.doc.discount_amount,precision("net_total"));n.net_amount=flt(n.net_amount+o,precision("net_amount",n))}n.net_rate=n.qty?flt(n.net_amount/n.qty,precision("net_rate",n)):0,e.set_in_company_currency(n,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}}get_total_for_discount_amount(){if(this.frm.doc.apply_discount_on=="Net Total")return this.frm.doc.net_total;var e=0,t={};return $.each(this.frm.doc.taxes||[],function(a,i){if(["Actual","On Item Quantity"].includes(i.charge_type)){var s=i.category=="Valuation"?0:i.tax_amount;s*=i.add_deduct_tax=="Deduct"?-1:1,t[i.idx]=s}else if(t[i.row_id]!==null){var n=flt(t[i.row_id])*flt(i.rate)/100;t[i.idx]=n}}),$.each(t,function(a,i){i&&(e+=i)}),flt(this.frm.doc.grand_total-e,precision("grand_total"))}calculate_total_advance(e){var t=frappe.utils.sum($.map(this.frm.doc.advances||[],function(a){return flt(a.allocated_amount,precision("allocated_amount",a))}));this.frm.doc.total_advance=flt(t,precision("total_advance")),this.frm.doc.write_off_outstanding_amount_automatically&&(this.frm.doc.write_off_amount=0),this.calculate_outstanding_amount(e),this.calculate_write_off_amount()}is_internal_invoice(){return!!(["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.company===this.frm.doc.represents_company)}calculate_outstanding_amount(e){if(["Sales Invoice","POS Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0||this.is_internal_invoice())&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),["Sales Invoice","POS Invoice","Purchase Invoice"].includes(this.frm.doc.doctype))){let i=this.frm.doc.rounded_total||this.frm.doc.grand_total,s=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var t=flt(i-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var t=flt(flt(s,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),["Sales Invoice","POS Invoice"].includes(this.frm.doc.doctype)){let n=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(t-this.frm.doc.loyalty_amount,precision("base_grand_total")):t;this.set_default_payment(n,e),this.calculate_paid_amount()}this.calculate_change_amount();var a=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(t-flt(a)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}}set_total_amount_to_default_mop(){let e=this.frm.doc.rounded_total||this.frm.doc.grand_total,t=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var a=flt(e-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var a=flt(flt(t,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));this.frm.doc.payments.find(i=>{i.default?i.amount=a:i.amount=0}),this.frm.refresh_fields()}set_default_payment(e,t){var a=this,i=!0;this.frm.doc.is_pos&&(t===void 0||t)&&$.each(this.frm.doc.payments||[],function(s,n){if(n.default&&i&&e>0){let o,l;a.frm.doc.party_account_currency==a.frm.doc.currency?(o=flt(e*a.frm.doc.conversion_rate,precision("base_amount",n)),l=flt(e,precision("amount",n))):(o=flt(e,precision("base_amount",n)),l=flt(e/a.frm.doc.conversion_rate,precision("amount",n))),frappe.model.set_value(n.doctype,n.name,"base_amount",o),frappe.model.set_value(n.doctype,n.name,"amount",l),i=!1}else a.frm.doc.paid_amount&&frappe.model.set_value(n.doctype,n.name,"amount",0)})}calculate_paid_amount(){var e=this,t=0,a=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(i,s){s.base_amount=flt(s.amount*e.frm.doc.conversion_rate,precision("base_amount",s)),t+=s.amount,a+=s.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(a+=this.frm.doc.loyalty_amount,t+=flt(this.frm.doc.loyalty_amount/e.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.set_value("paid_amount",flt(t,precision("paid_amount"))),this.frm.set_value("base_paid_amount",flt(a,precision("base_paid_amount")))}calculate_change_amount(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,["Sales Invoice","POS Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var e=$.map(this.frm.doc.payments,function(i){return i.type});if(in_list(e,"Cash")){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total,a=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-t,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-a,precision("base_change_amount"))}}}calculate_write_off_amount(){this.frm.doc.write_off_outstanding_amount_automatically&&(this.frm.doc.write_off_amount=flt(this.frm.doc.outstanding_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount")),this.calculate_outstanding_amount(!1))}filtered_items(){return this.frm.doc.items.filter(e=>!e.is_alternative)}};erpnext.TransactionController=class extends erpnext.taxes_and_totals{setup(){super.setup();let e=this;this.set_fields_onload_for_line_item(),this.frm.ignore_doctypes_on_cancel_all=["Serial and Batch Bundle"],frappe.flags.hide_serial_batch_dialog=!0,frappe.ui.form.on(this.frm.doctype+" Item","rate",function(t,a,i){var s=frappe.get_doc(a,i),n=frappe.meta.has_field(a,"margin_type");frappe.model.round_floats_in(s,["rate","price_list_rate"]),s.price_list_rate&&!s.blanket_order_rate?s.rate>s.price_list_rate&&n?(s.discount_percentage=0,s.margin_type="Amount",s.margin_rate_or_amount=flt(s.rate-s.price_list_rate,precision("margin_rate_or_amount",s)),s.rate_with_margin=s.rate):(s.discount_percentage=flt((1-s.rate/s.price_list_rate)*100,precision("discount_percentage",s)),s.discount_amount=flt(s.price_list_rate)-flt(s.rate),s.margin_type="",s.margin_rate_or_amount=0,s.rate_with_margin=0):(s.discount_percentage=0,s.margin_type="",s.margin_rate_or_amount=0,s.rate_with_margin=0),s.base_rate_with_margin=s.rate_with_margin*flt(t.doc.conversion_rate),cur_frm.cscript.set_gross_profit(s),cur_frm.cscript.calculate_taxes_and_totals(),cur_frm.cscript.calculate_stock_uom_rate(t,a,i)}),frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(t,a,i){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(t,a,i){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(t,a,i){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(t,a,i){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(t){t.doc.additional_discount_percentage?t.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"additional_discount_percentage",function(t){if(!t.doc.apply_discount_on){frappe.msgprint(__("Please set 'Apply Additional Discount On'"));return}t.via_discount_percentage=!0,t.doc.additional_discount_percentage&&t.doc.discount_amount&&(t.doc.discount_amount=0,t.cscript.calculate_taxes_and_totals());var a=flt(t.doc[frappe.model.scrub(t.doc.apply_discount_on)]),i=flt(a*flt(t.doc.additional_discount_percentage)/100,precision("discount_amount"));t.set_value("discount_amount",i).then(()=>delete t.via_discount_percentage)}),frappe.ui.form.on(this.frm.doctype,"discount_amount",function(t){t.cscript.set_dynamic_labels(),t.via_discount_percentage||(t.doc.additional_discount_percentage=0),t.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype+" Item",{items_add:function(t,a,i){var n;var s=frappe.get_doc(a,i);!s.warehouse&&t.doc.set_warehouse&&(s.warehouse=t.doc.set_warehouse),!s.target_warehouse&&t.doc.set_target_warehouse&&(s.target_warehouse=t.doc.set_target_warehouse),!s.from_warehouse&&t.doc.set_from_warehouse&&(s.from_warehouse=t.doc.set_from_warehouse),s.docstatus===0&&frappe.meta.has_field(s.doctype,"use_serial_batch_fields")&&cint((n=frappe.user_defaults)==null?void 0:n.use_serial_batch_fields)===1&&frappe.model.set_value(s.doctype,s.name,"use_serial_batch_fields",1),erpnext.accounts.dimensions.copy_dimension_from_first_row(t,a,i,"items")}}),this.frm.fields_dict.items.grid.get_field("serial_and_batch_bundle")&&this.frm.set_query("serial_and_batch_bundle","items",function(t,a,i){return{filters:{item_code:locals[a][i].item_code,voucher_type:t.doctype,voucher_no:["in",[t.name,""]],is_cancelled:0}}}),this.frm.fields_dict.items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","items",function(t,a,i){return e.set_query_for_batch(t,a,i)}),this.frm.docstatus<2&&this.frm.fields_dict.payment_terms_template&&this.frm.fields_dict.payment_schedule&&this.frm.doc.payment_terms_template&&!this.frm.doc.payment_schedule.length&&this.frm.trigger("payment_terms_template"),this.frm.fields_dict.taxes&&(this.taxes_remove=this.calculate_taxes_and_totals),this.frm.fields_dict.items&&(this.items_remove=this.process_item_removal),this.frm.fields_dict.recurring_print_format&&this.frm.set_query("recurring_print_format",function(t){return{filters:[["Print Format","doc_type","=",cur_frm.doctype]]}}),this.frm.fields_dict.return_against&&this.frm.set_query("return_against",function(t){var a={docstatus:1,is_return:0,company:t.company};return e.frm.fields_dict.customer&&t.customer&&(a.customer=t.customer),e.frm.fields_dict.supplier&&t.supplier&&(a.supplier=t.supplier),{filters:a}}),this.frm.fields_dict.items.grid.get_field("expense_account")&&this.frm.set_query("expense_account","items",function(t){return{filters:{company:t.company,report_type:"Profit and Loss",is_group:0}}}),frappe.meta.get_docfield(this.frm.doc.doctype,"pricing_rules")&&this.frm.set_indicator_formatter("pricing_rule",function(t){return t.rule_applied?"green":"red"}),this.frm.fields_dict.items.grid.get_field("blanket_order")&&this.frm.set_query("blanket_order","items",function(t,a,i){var s=locals[a][i];return{query:"erpnext.controllers.queries.get_blanket_orders",filters:{company:t.company,blanket_order_type:t.doctype==="Sales Order"?"Selling":"Purchasing",item:s.item_code}}}),this.frm.fields_dict.taxes_and_charges&&this.frm.set_query("taxes_and_charges",function(){return{filters:[["company","=",e.frm.doc.company],["docstatus","!=",2]]}})}set_fields_onload_for_line_item(){var e;this.frm.is_new()&&((e=this.frm.doc)==null?void 0:e.items)&&this.frm.doc.items.forEach(t=>{var a;t.docstatus===0&&frappe.meta.has_field(t.doctype,"use_serial_batch_fields")&&cint((a=frappe.user_defaults)==null?void 0:a.use_serial_batch_fields)===1&&frappe.model.set_value(t.doctype,t.name,"use_serial_batch_fields",1)})}toggle_enable_for_stock_uom(e){frappe.call({method:"erpnext.stock.doctype.stock_settings.stock_settings.get_enable_stock_uom_editing",callback:t=>{if(t.message){var a=t.message[e];this.frm.fields_dict.items.grid.toggle_enable("stock_qty",a)}}})}onload(){var e=this;if(this.frm.doc.__islocal){var t=frappe.defaults.get_user_default("currency");let a=(i,s)=>{if(e.frm.fields_dict[i]&&!e.frm.doc[i])return e.frm.set_value(i,s)};return this.frm.trigger("set_default_internal_warehouse"),frappe.run_serially([()=>a("currency",t),()=>a("price_list_currency",t),()=>a("status","Draft"),()=>a("is_subcontracted",0),()=>{this.frm.doc.company&&!this.frm.doc.amended_from&&this.frm.trigger("company")}])}}is_return(){!this.frm.doc.is_return&&this.frm.doc.return_against&&this.frm.set_value("return_against","")}setup_quality_inspection(){if(!["Delivery Note","Sales Invoice","Purchase Receipt","Purchase Invoice","Subcontracting Receipt"].includes(this.frm.doc.doctype))return;let e=this;!this.frm.is_new()&&this.frm.doc.docstatus===0&&frappe.model.can_create("Quality Inspection")&&(this.frm.add_custom_button(__("Quality Inspection(s)"),()=>{e.make_quality_inspection()},__("Create")),this.frm.page.set_inner_btn_group_as_primary(__("Create")));let t=["Purchase Receipt","Purchase Invoice","Subcontracting Receipt"].includes(this.frm.doc.doctype)?"Incoming":"Outgoing",a=this.frm.get_docfield("items","quality_inspection");a.get_route_options_for_new_doc=function(i){return e.frm.is_new()?{}:{inspection_type:t,reference_type:e.frm.doc.doctype,reference_name:e.frm.doc.name,item_code:i.doc.item_code,description:i.doc.description,item_serial_no:i.doc.serial_no?i.doc.serial_no.split(`
`)[0]:null,batch_no:i.doc.batch_no}},this.frm.set_query("quality_inspection","items",function(i,s,n){let o=locals[s][n];return{filters:{docstatus:1,inspection_type:t,reference_name:i.name,item_code:o.item_code}}})}make_payment_request(){let e=this,t=["Sales Order","Sales Invoice"].includes(this.frm.doc.doctype)?"Inward":"Outward";frappe.call({method:"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request",args:{dt:e.frm.doc.doctype,dn:e.frm.doc.name,recipient_id:e.frm.doc.contact_email,payment_request_type:t,party_type:t=="Outward"?"Supplier":"Customer",party:t=="Outward"?e.frm.doc.supplier:e.frm.doc.customer,party_name:t=="Outward"?e.frm.doc.supplier_name:e.frm.doc.customer_name},callback:function(a){a.exc||(frappe.model.sync(a.message),frappe.set_route("Form",a.message.doctype,a.message.name))}})}onload_post_render(){var e;this.frm.doc.__islocal&&!(this.frm.doc.taxes||[]).length&&!((e=this.frm.doc.__onload)!=null&&e.load_after_mapping)?frappe.after_ajax(()=>this.apply_default_taxes()):this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(()=>this.calculate_taxes_and_totals()),frappe.meta.get_docfield(this.frm.doc.doctype+" Item","item_code")&&(this.setup_item_selector(),this.frm.get_field("items").grid.set_multiple_add("item_code","qty"))}refresh(){erpnext.toggle_naming_series(),erpnext.hide_company(this.frm),this.set_dynamic_labels(),this.setup_sms(),this.setup_quality_inspection(),this.validate_has_items(),erpnext.utils.view_serial_batch_nos(this.frm),this.set_route_options_for_new_doc()}set_route_options_for_new_doc(){if(this.frm.fields_dict.items.grid.get_field("batch_no")){let e=this.frm.get_docfield("items","batch_no");e&&(e.get_route_options_for_new_doc=function(t){return{item:t.doc.item_code}})}if(this.frm.fields_dict.items.grid.get_field("serial_and_batch_bundle")){let e=this.frm.get_docfield("items","serial_and_batch_bundle");e&&(e.get_route_options_for_new_doc=t=>({item_code:t.doc.item_code,voucher_type:this.frm.doc.doctype}))}}scan_barcode(){frappe.flags.dialog_set=!1,new erpnext.utils.BarcodeScanner({frm:this.frm}).process_scan()}barcode(e,t,a){let i=locals[t][a];i.barcode&&erpnext.stock.utils.set_item_details_using_barcode(this.frm,i,s=>{frappe.model.set_value(t,a,{item_code:s.message.item_code,qty:1})})}validate_has_items(){let e=this.frm.doc.items;this.frm.has_items=e&&e.length&&e[0].qty&&e[0].item_code}apply_default_taxes(){var e=this,t=frappe.meta.get_docfield(e.frm.doc.doctype,"taxes_and_charges",e.frm.doc.name);if(!(!this.frm.doc.taxes_and_charges&&this.frm.doc.taxes&&this.frm.doc.taxes.length>0)&&t)return frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:t.options,tax_template:e.frm.doc.taxes_and_charges||"",company:e.frm.doc.company},debounce:2e3,callback:function(a){!a.exc&&a.message&&frappe.run_serially([()=>{a.message.taxes_and_charges&&(e.frm.doc.taxes_and_charges=a.message.taxes_and_charges),a.message.taxes&&e.frm.set_value("taxes",a.message.taxes)},()=>e.set_dynamic_labels(),()=>e.calculate_taxes_and_totals()])}})}setup_sms(){var e=this;let t=["Purchase Invoice","BOM"];this.frm.doc.docstatus===1&&!["Lost","Stopped","Closed"].includes(this.frm.doc.status)&&!t.includes(this.frm.doctype)&&this.frm.page.add_menu_item(__("Send SMS"),function(){e.send_sms()})}send_sms(){var e=new erpnext.SMSManager(this.frm.doc)}item_code(e,t,a){var i=this,s=frappe.get_doc(t,a),n=0,o=0;if(s.weight_per_unit=0,s.weight_uom="",s.conversion_factor=0,["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)?(n=cint(i.frm.doc.update_stock),o=n):(this.frm.doc.doctype==="Purchase Receipt"||this.frm.doc.doctype==="Delivery Note")&&(o=1),o&&s.use_serial_batch_fields===1&&(o=0),s.barcode=null,s.item_code||s.serial_no)if(!this.validate_company_and_party())this.frm.fields_dict.items.grid.grid_rows[s.idx-1].remove();else return s.pricing_rules="",this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:s,args:{doc:i.frm.doc,args:{item_code:s.item_code,barcode:s.barcode,serial_no:s.serial_no,batch_no:s.batch_no,set_warehouse:i.frm.doc.set_warehouse,warehouse:s.warehouse,customer:i.frm.doc.customer||i.frm.doc.party_name,quotation_to:i.frm.doc.quotation_to,supplier:i.frm.doc.supplier,currency:i.frm.doc.currency,is_internal_supplier:i.frm.doc.is_internal_supplier,is_internal_customer:i.frm.doc.is_internal_customer,update_stock:n,conversion_rate:i.frm.doc.conversion_rate,price_list:i.frm.doc.selling_price_list||i.frm.doc.buying_price_list,price_list_currency:i.frm.doc.price_list_currency,plc_conversion_rate:i.frm.doc.plc_conversion_rate,company:i.frm.doc.company,order_type:i.frm.doc.order_type,is_pos:cint(i.frm.doc.is_pos),is_return:cint(i.frm.doc.is_return),is_subcontracted:i.frm.doc.is_subcontracted,ignore_pricing_rule:i.frm.doc.ignore_pricing_rule,doctype:i.frm.doc.doctype,name:i.frm.doc.name,project:s.project||i.frm.doc.project,qty:s.qty||1,net_rate:s.rate,base_net_rate:s.base_net_rate,stock_qty:s.stock_qty,conversion_factor:s.conversion_factor,weight_per_unit:s.weight_per_unit,uom:s.uom,weight_uom:s.weight_uom,manufacturer:s.manufacturer,stock_uom:s.stock_uom,pos_profile:cint(i.frm.doc.is_pos)?i.frm.doc.pos_profile:"",cost_center:s.cost_center,tax_category:i.frm.doc.tax_category,item_tax_template:s.item_tax_template,child_doctype:s.doctype,child_docname:s.name,is_old_subcontracting_flow:i.frm.doc.is_old_subcontracting_flow}},callback:function(l){l.exc||frappe.run_serially([()=>{var c;s.docstatus===0&&frappe.meta.has_field(s.doctype,"use_serial_batch_fields")&&!s.use_serial_batch_fields&&cint((c=frappe.user_defaults)==null?void 0:c.use_serial_batch_fields)===1&&(s.use_serial_batch_fields=1)},()=>{var c=locals[t][a];i.add_taxes_from_item_tax_template(c.item_tax_rate),c.free_item_data&&c.free_item_data.length>0&&i.apply_product_discount(c)},()=>{(i.frm.doc.is_internal_customer||i.frm.doc.is_internal_supplier)&&i.frm.doc.represents_company===i.frm.doc.company?i.get_incoming_rate(s,i.frm.posting_date,i.frm.posting_time,i.frm.doc.doctype,i.frm.doc.company):i.frm.script_manager.trigger("price_list_rate",t,a)},()=>{(i.frm.doc.is_internal_customer||i.frm.doc.is_internal_supplier)&&i.calculate_taxes_and_totals()},()=>i.toggle_conversion_factor(s),()=>{if(o&&!frappe.flags.trigger_from_barcode_scanner)return frappe.db.get_value("Item",s.item_code,["has_batch_no","has_serial_no"]).then(c=>{c.message&&(c.message.has_batch_no||c.message.has_serial_no)?frappe.flags.hide_serial_batch_dialog=!1:o=!1})},()=>{if(o&&!frappe.flags.hide_serial_batch_dialog)return frappe.db.get_single_value("Stock Settings","disable_serial_no_and_batch_selector").then(c=>{c&&(frappe.flags.hide_serial_batch_dialog=!0)})},()=>{if(o&&!frappe.flags.hide_serial_batch_dialog&&!frappe.flags.dialog_set){var c=locals[t][a];$.each(l.message,function(d,p){c[d]||(c[d]=p)}),c.has_batch_no&&c.has_serial_no&&(c.batch_no=void 0),frappe.flags.dialog_set=!0,erpnext.show_serial_batch_selector(i.frm,c,d=>{i.frm.script_manager.trigger("qty",d.doctype,d.name),i.frm.doc.set_warehouse||i.frm.script_manager.trigger("warehouse",d.doctype,d.name),i.apply_price_list(d,!0)},void 0,!frappe.flags.hide_serial_batch_dialog)}else frappe.flags.dialog_set=!1},()=>i.conversion_factor(e,t,a,!0),()=>i.remove_pricing_rule(s),()=>{if(s.apply_rule_on_other_items){let c=s.name;i.apply_rule_on_other_items({key:s})}},()=>{var c=i.get_company_currency();i.update_item_grid_labels(c)}])}})}price_list_rate(e,t,a){var i=frappe.get_doc(t,a);frappe.model.round_floats_in(i,["price_list_rate","discount_percentage"]),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","POS Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item"]),t?this.apply_pricing_rule_on_item(i):i.rate=flt(i.price_list_rate*(1-i.discount_percentage/100),precision("rate",i)),this.calculate_taxes_and_totals()}margin_rate_or_amount(e,t,a){let i=frappe.get_doc(t,a);this.apply_pricing_rule_on_item(i),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()}margin_type(e,t,a){let i=frappe.get_doc(t,a);i.margin_type?(this.apply_pricing_rule_on_item(i,e,t,a),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()):frappe.model.set_value(t,a,"margin_rate_or_amount",0)}get_incoming_rate(e,t,a,i,s){let n={item_code:e.item_code,warehouse:in_list("Purchase Receipt","Purchase Invoice")?e.from_warehouse:e.warehouse,posting_date:t,posting_time:a,qty:e.qty*e.conversion_factor,serial_no:e.serial_no,batch_no:e.batch_no,voucher_type:i,company:s,allow_zero_valuation_rate:e.allow_zero_valuation_rate};frappe.call({method:"erpnext.stock.utils.get_incoming_rate",args:{args:n},callback:function(o){frappe.model.set_value(e.doctype,e.name,"rate",o.message*e.conversion_factor)}})}add_taxes_from_item_tax_template(e){let t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(a,i){if(!(t.frm.doc.taxes||[]).find(n=>n.account_head===a)){let n=frappe.model.add_child(t.frm.doc,"taxes");n.charge_type="On Net Total",n.account_head=a,n.rate=0}}))}serial_no(e,t,a){var i=this,s=frappe.get_doc(t,a);s&&s.doctype==="Purchase Receipt Item Supplied"||s&&s.serial_no&&(s.item_code?(s.serial_no=s.serial_no.replace(/,/g,`
`),s.conversion_factor=s.conversion_factor||1,refresh_field("serial_no",s.name,s.parentfield),e.is_return||setTimeout(()=>{i.update_qty(t,a)},3e3)):this.frm.trigger("item_code",t,a))}on_submit(){["Purchase Invoice","Sales Invoice"].includes(this.frm.doc.doctype)&&!this.frm.doc.update_stock||this.refresh_serial_batch_bundle_field()}refresh_serial_batch_bundle_field(){frappe.route_hooks.after_submit=e=>{e.reload_doc()}}update_qty(e,t){var a=[],i=[],s=frappe.get_doc(e,t);i=s.serial_no.split(`
`);for(var n=0;n<i.length;n++)i[n]!=""&&a.push(i[n]);frappe.model.set_value(s.doctype,s.name,"qty",a.length/s.conversion_factor),frappe.model.set_value(s.doctype,s.name,"stock_qty",a.length)}validate(){this.calculate_taxes_and_totals(!1)}update_stock(){this.frm.trigger("set_default_internal_warehouse")}set_default_internal_warehouse(){let e=this;(this.frm.doc.doctype==="Sales Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Delivery Note")&&this.frm.doc.is_internal_customer&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_target_warehouse",t.default_in_transit_warehouse)}),(this.frm.doc.doctype==="Purchase Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Purchase Receipt")&&this.frm.doc.is_internal_supplier&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_from_warehouse",t.default_in_transit_warehouse)})}company(){var e=this,t=function(){e.frm.doc.company&&e.frm.fields_dict.currency&&frappe.run_serially([()=>a(),()=>e.update_item_tax_map(),()=>e.apply_default_taxes(),()=>e.apply_pricing_rule(),()=>s(),()=>n()])},a=function(){if(!e.is_a_mapped_document()){var l=frappe.meta.has_field(e.frm.doc.doctype,"customer")?"Customer":"Supplier",c=e.frm.doc[l.toLowerCase()];c?frappe.call({method:"frappe.client.get_value",args:{doctype:l,filters:{name:c},fieldname:"default_currency"},callback:function(d){d.message&&i(d.message.default_currency)}}):i()}},i=function(l){var c=e.get_company_currency(),d=l||c;e.frm.doc.currency!=d&&e.frm.set_value("currency",d),e.frm.doc.currency==c&&e.frm.set_value("conversion_rate",1),e.frm.doc.price_list_currency==c&&e.frm.set_value("plc_conversion_rate",1),e.frm.script_manager.trigger("currency")},s=function(){if(frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&!e.frm.doc.tc_name){var l=frappe.get_doc(":Company",e.frm.doc.company),c=["Quotation","Sales Order","Delivery Note","Sales Invoice"],d=c.includes(e.frm.doc.doctype)?"default_selling_terms":"default_buying_terms";l&&l[d]&&e.frm.set_value("tc_name",l[d])}},n=function(){if(e.frm.fields_dict.letter_head){var l=frappe.get_doc(":Company",e.frm.doc.company);l&&l.default_letter_head&&e.frm.set_value("letter_head",l.default_letter_head)}},o=function(l){if(["Sales Invoice","Purchase Invoice"].includes(e.frm.doc.doctype)){if(e.frm.doc.doctype=="Sales Invoice")var c="Customer",d="debit_to";else var c="Supplier",d="credit_to";var p=e.frm.doc[frappe.model.scrub(c)];if(p&&e.frm.doc.company)return frappe.call({method:"erpnext.accounts.party.get_party_account",args:{company:e.frm.doc.company,party_type:c,party:p},callback:function(u){!u.exc&&u.message&&(e.frm.set_value(d,u.message),l())}});l()}else l()};frappe.meta.get_docfield(this.frm.doctype,"shipping_address")&&["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)?e.frm.doc.items.some(c=>c.delivered_by_supplier)||(console.log("get_shipping_address"),erpnext.utils.get_shipping_address(this.frm,function(){o(t)})):o(t),this.frm.doc.company&&(erpnext.last_selected_company=this.frm.doc.company)}transaction_date(){this.frm.doc.transaction_date&&(this.frm.transaction_date=this.frm.doc.transaction_date,frappe.ui.form.trigger(this.frm.doc.doctype,"currency"))}posting_date(){var e=this;if(this.frm.doc.posting_date){if(this.frm.posting_date=this.frm.doc.posting_date,this.frm.doc.doctype=="Sales Invoice"&&this.frm.doc.customer||this.frm.doc.doctype=="Purchase Invoice"&&this.frm.doc.supplier)return frappe.call({method:"erpnext.accounts.party.get_due_date",args:{posting_date:e.frm.doc.posting_date,party_type:e.frm.doc.doctype=="Sales Invoice"?"Customer":"Supplier",bill_date:e.frm.doc.bill_date,party:e.frm.doc.doctype=="Sales Invoice"?e.frm.doc.customer:e.frm.doc.supplier,company:e.frm.doc.company},callback:function(t,a){t.message&&(e.frm.doc.due_date=t.message,refresh_field("due_date"),frappe.ui.form.trigger(e.frm.doc.doctype,"currency"),e.recalculate_terms())}});frappe.ui.form.trigger(e.frm.doc.doctype,"currency")}}due_date(){if(this.frm.doc.due_date&&!this.frm.updating_party_details&&!this.frm.doc.is_pos&&(this.frm.doc.payment_terms_template||this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length)){var e="",t="",a=__("Please clear the")+" ";this.frm.doc.payment_terms_template&&(e=__("selected Payment Terms Template"),a=a+e),(this.frm.doc.payment_schedule||[]).length&&(t=__("Payment Schedule Table"),e.length!==0&&(t=" and "+t),a=a+t),frappe.msgprint(a)}}bill_date(){this.posting_date()}recalculate_terms(){let e=this.frm.doc;if(e.payment_terms_template)this.payment_terms_template();else if(e.payment_schedule){let t=this;e.payment_schedule.forEach(function(a){a.payment_term?t.payment_term(e,a.doctype,a.name):frappe.model.set_value(a.doctype,a.name,"due_date",e.posting_date||e.transaction_date)})}}get_company_currency(){return erpnext.get_currency(this.frm.doc.company)}contact_person(){erpnext.utils.get_contact_details(this.frm)}currency(){var i;let e=this.frm.doc.transaction_date||this.frm.doc.posting_date,t=this;this.set_dynamic_labels();let a=this.get_company_currency();this.frm.doc.currency&&this.frm.doc.currency!==a&&!((i=this.frm.doc.__onload)!=null&&i.load_after_mapping)?this.get_exchange_rate(e,this.frm.doc.currency,a,function(s){s!=t.frm.doc.conversion_rate&&(t.set_margin_amount_based_on_currency(s),t.set_actual_charges_based_on_currency(s),t.frm.set_value("conversion_rate",s))}):this.frm.doc.currency===this.get_company_currency()?this.frm.set_value("conversion_rate",1):this.conversion_rate()}conversion_rate(){var t;let e=this.frm;this.frm.doc.currency===this.get_company_currency()&&this.frm.set_value("conversion_rate",1),this.frm.doc.currency===this.frm.doc.price_list_currency&&this.frm.doc.plc_conversion_rate!==this.frm.doc.conversion_rate&&this.frm.set_value("plc_conversion_rate",this.frm.doc.conversion_rate),flt(this.frm.doc.conversion_rate)>0&&((t=this.frm.doc.__onload)!=null&&t.load_after_mapping?this.calculate_taxes_and_totals():this.in_apply_price_list||this.apply_price_list()),this.frm.set_df_property("conversion_rate","read_only",erpnext.stale_rate_allowed()?0:1)}apply_discount_on_item(e,t,a,i){var s=frappe.get_doc(t,a);s!=null&&s.price_list_rate?this.price_list_rate(e,t,a):s[i]=0,this.set_gross_profit(s)}shipping_rule(){var e=this;if(this.frm.doc.shipping_rule)return this.frm.call({doc:this.frm.doc,method:"apply_shipping_rule",callback:function(t){e._calculate_taxes_and_totals()}}).fail(()=>this.frm.set_value("shipping_rule",""))}set_margin_amount_based_on_currency(e){if(in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Invoice","Purchase Order","Purchase Receipt"]),this.frm.doc.doctype){var t=this;$.each(this.frm.doc.items||[],function(a,i){i.margin_type=="Amount"&&frappe.model.set_value(i.doctype,i.name,"margin_rate_or_amount",flt(i.margin_rate_or_amount)/flt(e))})}}set_actual_charges_based_on_currency(e){var t=this;$.each(this.frm.doc.taxes||[],function(a,i){i.charge_type=="Actual"&&frappe.model.set_value(i.doctype,i.name,"tax_amount",flt(i.base_tax_amount)/flt(e))})}get_exchange_rate(e,t,a,i){var s;if(["Quotation","Sales Order","Delivery Note","Sales Invoice"].includes(this.frm.doctype)?s="for_selling":["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)&&(s="for_buying"),!(!e||!t||!a))return frappe.call({method:"erpnext.setup.utils.get_exchange_rate",args:{transaction_date:e,from_currency:t,to_currency:a,args:s},freeze:!0,freeze_message:__("Fetching exchange rates ..."),callback:function(n){i(flt(n.message))}})}price_list_currency(){var a;var e=this;this.set_dynamic_labels();var t=this.get_company_currency();this.frm.doc.price_list_currency!==t&&!((a=this.frm.doc.__onload)!=null&&a.load_after_mapping)?this.get_exchange_rate(this.frm.doc.posting_date,this.frm.doc.price_list_currency,t,function(i){e.frm.set_value("plc_conversion_rate",i)}):this.plc_conversion_rate()}plc_conversion_rate(){this.frm.doc.price_list_currency===this.get_company_currency()?this.frm.set_value("plc_conversion_rate",1):this.frm.doc.price_list_currency===this.frm.doc.currency&&this.frm.doc.plc_conversion_rate&&cint(this.frm.doc.plc_conversion_rate)!=1&&cint(this.frm.doc.plc_conversion_rate)!=cint(this.frm.doc.conversion_rate)&&this.frm.set_value("conversion_rate",this.frm.doc.plc_conversion_rate),this.in_apply_price_list||this.apply_price_list(null,!0)}uom(e,t,a){var i=this,s=frappe.get_doc(t,a);if(s.pricing_rules="",s.item_code&&s.uom)return this.frm.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:s.item_code,uom:s.uom},callback:function(n){n.exc||(frappe.model.set_value(t,a,"conversion_factor",n.message.conversion_factor),i.apply_price_list(s,!0))}});i.calculate_stock_uom_rate(e,t,a)}conversion_factor(e,t,a,i){if(frappe.meta.get_docfield(t,"stock_qty",a)){var s=frappe.get_doc(t,a);if(frappe.model.round_floats_in(s,["qty","conversion_factor"]),s.stock_qty=flt(s.qty*s.conversion_factor,precision("stock_qty",s)),refresh_field("stock_qty",s.name,s.parentfield),this.toggle_conversion_factor(s),e.doctype!="Material Request"&&(s.total_weight=flt(s.stock_qty*s.weight_per_unit),refresh_field("total_weight",s.name,s.parentfield),this.calculate_net_weight()),frappe.flags.dont_fetch_price_list_rate)return;!i&&frappe.meta.has_field(e.doctype,"price_list_currency")&&this.apply_price_list(s,!0),this.calculate_stock_uom_rate(e,t,a)}}is_a_mapped_document(e){var i;let a={"Delivery Note":["si_detail","so_detail","dn_detail"],"Sales Invoice":["dn_detail","so_detail","sales_invoice_item"],"Purchase Receipt":["purchase_order_item","purchase_invoice_item","purchase_receipt_item"],"Purchase Invoice":["purchase_order_item","pr_detail","po_detail"],"Sales Order":["prevdoc_docname","quotation_item"],"Purchase Order":["supplier_quotation_item"]}[this.frm.doc.doctype]||[];if(e)return a.map(s=>e[s]).filter(Boolean).length>0;if((i=this.frm.doc)!=null&&i.items){let s=this.frm.doc.items[0];if(!s)return!1;let n=a.filter(o=>s[o]);return(n==null?void 0:n.length)>0}}batch_no(e,t,a){let i=frappe.get_doc(t,a);this.is_a_mapped_document(i)||this.apply_price_list(i,!0)}toggle_conversion_factor(e){this.frm.get_field("items").grid.fields_map.conversion_factor&&this.frm.fields_dict.items.grid.toggle_enable("conversion_factor",e.uom!=e.stock_uom&&!frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype,"conversion_factor").read_only)}qty(e,t,a){let i=frappe.get_doc(t,a);this.is_a_mapped_document(i)||frappe.run_serially([()=>this.remove_pricing_rule_for_item(i),()=>this.conversion_factor(e,t,a,!0),()=>this.apply_price_list(i,!0),()=>this.calculate_stock_uom_rate(e,t,a),()=>this.apply_pricing_rule(i,!0)])}stock_qty(e,t,a){let i=frappe.get_doc(t,a);i.conversion_factor=1,i.stock_qty&&(i.conversion_factor=flt(i.stock_qty)/flt(i.qty)),refresh_field("conversion_factor",i.name,i.parentfield)}calculate_stock_uom_rate(e,t,a){let i=frappe.get_doc(t,a);i!=null&&i.rate&&(i.stock_uom_rate=flt(i.rate)/flt(i.conversion_factor),refresh_field("stock_uom_rate",i.name,i.parentfield))}service_stop_date(e,t,a){var i=locals[t][a];if(i.service_stop_date){let s=Date.parse(i.service_start_date),n=Date.parse(i.service_end_date),o=Date.parse(i.service_stop_date);o<s?(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be before Service Start Date"))):o>n&&(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be after Service End Date")))}}service_start_date(e,t,a){var i=locals[t][a];i.service_start_date&&frappe.call({method:"erpnext.stock.get_item_details.calculate_service_end_date",args:{args:i},callback:function(s){frappe.model.set_value(t,a,"service_end_date",s.message.service_end_date)}})}process_item_removal(){this.frm.trigger("calculate_taxes_and_totals"),this.frm.trigger("calculate_net_weight")}calculate_net_weight(){var e=this;this.frm.doc.total_net_weight=0,$.each(this.frm.doc.items||[],function(t,a){e.frm.doc.total_net_weight+=flt(a.total_weight)}),refresh_field("total_net_weight"),this.shipping_rule()}set_dynamic_labels(){this.frm.toggle_reqd("plc_conversion_rate",!!(this.frm.doc.price_list_name&&this.frm.doc.price_list_currency));var e=this.get_company_currency();this.change_form_labels(e),this.change_grid_labels(e),this.frm.refresh_fields()}change_form_labels(e){let t=this;this.frm.set_currency_labels(["base_total","base_net_total","base_total_taxes_and_charges","base_discount_amount","base_grand_total","base_rounded_total","base_in_words","base_taxes_and_charges_added","base_taxes_and_charges_deducted","total_amount_to_pay","base_paid_amount","base_write_off_amount","base_change_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],e),this.frm.set_currency_labels(["total","net_total","total_taxes_and_charges","discount_amount","grand_total","taxes_and_charges_added","taxes_and_charges_deducted","tax_withholding_net_total","rounded_total","in_words","paid_amount","write_off_amount","operating_cost","scrap_material_cost","rounding_adjustment","raw_material_cost","total_cost"],this.frm.doc.currency),this.frm.set_currency_labels(["outstanding_amount","total_advance"],this.frm.doc.party_account_currency),this.frm.set_df_property("conversion_rate","description","1 "+this.frm.doc.currency+" = [?] "+e),this.frm.doc.price_list_currency&&this.frm.doc.price_list_currency!=e&&this.frm.set_df_property("plc_conversion_rate","description","1 "+this.frm.doc.price_list_currency+" = [?] "+e),this.frm.toggle_display(["conversion_rate","base_total","base_net_total","base_tax_withholding_net_total","base_total_taxes_and_charges","base_taxes_and_charges_added","base_taxes_and_charges_deducted","base_grand_total","base_rounded_total","base_in_words","base_discount_amount","base_paid_amount","base_write_off_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],this.frm.doc.currency!=e),this.frm.toggle_display(["plc_conversion_rate","price_list_currency"],this.frm.doc.price_list_currency!=e);let a=cint(this.frm.doc.discount_amount)||(this.frm.doc.taxes||[]).filter(function(i){return i.included_in_print_rate===1}).length;this.frm.doc.doctype&&frappe.meta.get_docfield(this.frm.doc.doctype,"net_total")&&this.frm.toggle_display("net_total",a),this.frm.doc.doctype&&frappe.meta.get_docfield(this.frm.doc.doctype,"base_net_total")&&this.frm.toggle_display("base_net_total",a&&t.frm.doc.currency!=e)}change_grid_labels(e){var t=this;if(this.update_item_grid_labels(e),this.toggle_item_grid_columns(e),this.frm.doc.operations&&this.frm.doc.operations.length>0){this.frm.set_currency_labels(["operating_cost","hour_rate"],this.frm.doc.currency,"operations"),this.frm.set_currency_labels(["base_operating_cost","base_hour_rate"],e,"operations");var a=this.frm.fields_dict.operations.grid;$.each(["base_operating_cost","base_hour_rate"],function(i,s){frappe.meta.get_docfield(a.doctype,s)&&a.set_column_disp(s,t.frm.doc.currency!=e)})}if(this.frm.doc.scrap_items&&this.frm.doc.scrap_items.length>0){this.frm.set_currency_labels(["rate","amount"],this.frm.doc.currency,"scrap_items"),this.frm.set_currency_labels(["base_rate","base_amount"],e,"scrap_items");var a=this.frm.fields_dict.scrap_items.grid;$.each(["base_rate","base_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,t.frm.doc.currency!=e)})}this.frm.doc.taxes&&this.frm.doc.taxes.length>0&&(this.frm.set_currency_labels(["tax_amount","total","tax_amount_after_discount"],this.frm.doc.currency,"taxes"),this.frm.set_currency_labels(["base_tax_amount","base_total","base_tax_amount_after_discount"],e,"taxes")),this.frm.doc.advances&&this.frm.doc.advances.length>0&&this.frm.set_currency_labels(["advance_amount","allocated_amount"],this.frm.doc.party_account_currency,"advances"),this.update_payment_schedule_grid_labels(e)}update_item_grid_labels(e){this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount","base_rate_with_margin"],e,"items"),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount","net_amount","stock_uom_rate","rate_with_margin"],this.frm.doc.currency,"items")}update_payment_schedule_grid_labels(e){let t=this;if(this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length>0){this.frm.set_currency_labels(["base_payment_amount","base_outstanding","base_paid_amount"],e,"payment_schedule"),this.frm.set_currency_labels(["payment_amount","outstanding","paid_amount"],this.frm.doc.currency,"payment_schedule");var a=this.frm.fields_dict.payment_schedule.grid;$.each(["base_payment_amount","base_outstanding","base_paid_amount"],function(i,s){frappe.meta.get_docfield(a.doctype,s)&&a.set_column_disp(s,t.frm.doc.currency!=e)})}}batch_no(e,t,a){let i=locals[t][a];if(i.use_serial_batch_fields&&i.batch_no){var s=this._get_args(i);s.batch_no=i.batch_no,s.uom=i.uom,frappe.call({method:"erpnext.stock.get_item_details.get_batch_based_item_price",args:{params:s,item_code:i.item_code},callback:function(n){!n.exc&&n.message&&(i.price_list_rate=n.message,i.rate=n.message,refresh_field("rate",i.name,i.parentfield),refresh_field("price_list_rate",i.name,i.parentfield))}})}}toggle_item_grid_columns(e){let t=this;var a=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount","base_rate_with_margin"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,t.frm.doc.currency!=e)});var i=cint(this.frm.doc.discount_amount)||(this.frm.doc.taxes||[]).filter(function(s){return s.included_in_print_rate===1}).length;$.each(["net_rate","net_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,i)}),$.each(["base_net_rate","base_net_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,i&&t.frm.doc.currency!=e)})}recalculate(){this.calculate_taxes_and_totals()}recalculate_values(){this.calculate_taxes_and_totals()}calculate_charges(){this.calculate_taxes_and_totals()}ignore_pricing_rule(){if(this.frm.doc.ignore_pricing_rule){let e=this,t=[];return $.each(this.frm.doc.items||[],function(a,i){i.item_code&&(i.is_free_item?e.frm.get_field("items").grid.grid_rows[a].remove():t.push({doctype:i.doctype,name:i.name,item_code:i.item_code,pricing_rules:i.pricing_rules,parenttype:i.parenttype,parent:i.parent,price_list_rate:i.price_list_rate}))}),this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules",args:{item_list:t},callback:function(a){!a.exc&&a.message&&(a.message.forEach(i=>{e.remove_pricing_rule(i)}),e._set_values_for_item_list(a.message),e.calculate_taxes_and_totals(),e.frm.doc.apply_discount_on&&e.frm.trigger("apply_discount_on"))}})}else this.apply_pricing_rule()}remove_pricing_rule_for_item(e){let t=e.pricing_rules;if(e.pricing_rules){let a=this;return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rule_for_item",args:{pricing_rules:e.pricing_rules,item_details:{doctype:e.doctype,name:e.name,item_code:e.item_code,pricing_rules:e.pricing_rules,parenttype:e.parenttype,parent:e.parent,price_list_rate:e.price_list_rate},item_code:e.item_code,rate:e.price_list_rate},callback:function(i){!i.exc&&i.message&&(a.remove_pricing_rule(i.message,t),a.calculate_taxes_and_totals(),a.frm.doc.apply_discount_on&&a.frm.trigger("apply_discount_on"))}})}}apply_pricing_rule(e,t){var s;var a=this,i=this._get_args(e);if(!(i.items&&i.items.length)){t&&a.calculate_taxes_and_totals();return}if((s=this.frm.doc.__onload)!=null&&s.load_after_mapping){t&&a.calculate_taxes_and_totals();return}return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule",args:{args:i,doc:a.frm.doc},callback:function(n){!n.exc&&n.message&&(a._set_values_for_item_list(n.message),e&&a.set_gross_profit(e),a.frm.doc.apply_discount_on&&a.frm.trigger("apply_discount_on"))}})}_get_args(e){var t=this;return{items:this._get_item_list(e),customer:t.frm.doc.customer||t.frm.doc.party_name,quotation_to:t.frm.doc.quotation_to,customer_group:t.frm.doc.customer_group,territory:t.frm.doc.territory,supplier:t.frm.doc.supplier,supplier_group:t.frm.doc.supplier_group,currency:t.frm.doc.currency,conversion_rate:t.frm.doc.conversion_rate,price_list:t.frm.doc.selling_price_list||t.frm.doc.buying_price_list,price_list_currency:t.frm.doc.price_list_currency,plc_conversion_rate:t.frm.doc.plc_conversion_rate,company:t.frm.doc.company,transaction_date:t.frm.doc.transaction_date||t.frm.doc.posting_date,campaign:t.frm.doc.campaign,sales_partner:t.frm.doc.sales_partner,ignore_pricing_rule:t.frm.doc.ignore_pricing_rule,doctype:t.frm.doc.doctype,name:t.frm.doc.name,is_return:cint(t.frm.doc.is_return),update_stock:["Sales Invoice","Purchase Invoice"].includes(t.frm.doc.doctype)?cint(t.frm.doc.update_stock):0,conversion_factor:t.frm.doc.conversion_factor,pos_profile:t.frm.doc.doctype=="Sales Invoice"?t.frm.doc.pos_profile:"",coupon_code:t.frm.doc.coupon_code,is_internal_supplier:t.frm.doc.is_internal_supplier,is_internal_customer:t.frm.doc.is_internal_customer}}_get_item_list(e){var t=[],a=function(i){i.item_code&&(t.push({doctype:i.doctype,name:i.name,child_docname:i.name,item_code:i.item_code,item_group:i.item_group,brand:i.brand,qty:i.qty,stock_qty:i.stock_qty,uom:i.uom,stock_uom:i.stock_uom,parenttype:i.parenttype,parent:i.parent,pricing_rules:i.pricing_rules,is_free_item:i.is_free_item,warehouse:i.warehouse,serial_no:i.serial_no,batch_no:i.batch_no,price_list_rate:i.price_list_rate,conversion_factor:i.conversion_factor||1}),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item"]),i.doctype&&(t[0].margin_type=i.margin_type,t[0].margin_rate_or_amount=i.margin_rate_or_amount))};return e?a(e):$.each(this.frm.doc.items||[],function(i,s){a(s)}),t}_set_values_for_item_list(e){let t={};for(let a of e){let i=frappe.model.get_value(a.doctype,a.name,"pricing_rules");for(let[s,n]of Object.entries(a))if(!["doctype","name"].includes(s)&&(s==="price_list_rate"&&frappe.model.set_value(a.doctype,a.name,"rate",n),s==="pricing_rules"&&frappe.model.set_value(a.doctype,a.name,s,n),s!=="free_item_data")){if(a.apply_rule_on_other_items&&JSON.parse(a.apply_rule_on_other_items).length&&!in_list(JSON.parse(a.apply_rule_on_other_items),a.item_code))continue;frappe.model.set_value(a.doctype,a.name,s,n)}frappe.model.round_floats_in(frappe.get_doc(a.doctype,a.name),["price_list_rate","discount_percentage"]),!this.frm.doc.ignore_pricing_rule&&i&&!a.pricing_rules?this.apply_price_list(frappe.get_doc(a.doctype,a.name)):a.pricing_rules||this.remove_pricing_rule(frappe.get_doc(a.doctype,a.name)),a.free_item_data&&a.free_item_data.length>0&&this.apply_product_discount(a),a.apply_rule_on_other_items&&JSON.parse(a.apply_rule_on_other_items).length&&(t[a.name]=a)}this.apply_rule_on_other_items(t),this.calculate_taxes_and_totals()}apply_rule_on_other_items(e){let t=this,a=["discount_percentage","pricing_rules","discount_amount","rate"];for(var i in e){let s=e[i];s&&s.apply_rule_on_other_items&&JSON.parse(s.apply_rule_on_other_items)&&t.frm.doc.items.forEach(n=>{if(in_list(JSON.parse(s.apply_rule_on_other_items),n[s.apply_rule_on])&&n.item_code===s.item_code)for(var o in s)s.pricing_rule_for=="Discount Percentage"&&s.apply_rule_on_other_items&&o=="discount_amount"||in_list(a,o)&&s[o]&&(s.price_or_product_discount==="Price"||o==="pricing_rules")&&frappe.model.set_value(n.doctype,n.name,o,s[o])})}}apply_product_discount(e){let t=this.frm.doc.items.filter(i=>i.is_free_item)||[],a=t.map(i=>({item_code:i.item_code,pricing_rules:i.pricing_rules}));e.free_item_data.forEach(i=>{let s={};!t||!a.filter(n=>n.item_code==i.item_code&&n.pricing_rules==i.pricing_rules).length?s=frappe.model.add_child(this.frm.doc,this.frm.doc.doctype+" Item","items"):t&&(s=t.filter(n=>n.item_code===i.item_code&&n.pricing_rules===i.pricing_rules)[0]);for(let n in i)s[n]=i[n];this.frm.script_manager.copy_from_first_row("items",s,["expense_account","income_account"])}),e.free_item_data="",refresh_field("items")}apply_price_list(e,t){if(this.frm.doc.doctype==="Material Request")return;t||this.frm.set_value("plc_conversion_rate","");let a=this,i=this._get_args(e);if(!!(i.items&&i.items.length||i.price_list)&&a.in_apply_price_list!=!0)return a.in_apply_price_list=!0,this.frm.call({method:"erpnext.stock.get_item_details.apply_price_list",args:{args:i,doc:a.frm.doc},callback:function(s){s.exc?a.in_apply_price_list=!1:frappe.run_serially([()=>{s.message.parent.price_list_currency&&a.frm.set_value("price_list_currency",s.message.parent.price_list_currency)},()=>{s.message.parent.plc_conversion_rate&&a.frm.set_value("plc_conversion_rate",s.message.parent.plc_conversion_rate)},()=>{i.items.length&&(a._set_values_for_item_list(s.message.children),$.each(s.message.children||[],function(n,o){a.apply_discount_on_item(o,o.doctype,o.name,"discount_percentage")}))},()=>{a.in_apply_price_list=!1}])}}).always(()=>{a.in_apply_price_list=!1})}remove_pricing_rule(e,t){let a=this,i=["discount_percentage","discount_amount","margin_rate_or_amount","rate_with_margin"];if(!!e){if(e.remove_free_item){let s=[];a.frm.doc.items.forEach(n=>{(n.item_code!=e.remove_free_item||!n.is_free_item||!(t!=null&&t.includes(n.pricing_rules)))&&s.push(n)}),a.frm.doc.items=s,refresh_field("items")}else if(e.applied_on_items&&e.apply_on){let s=e.applied_on_items.split(",");a.frm.doc.items.forEach(n=>{s.includes(n[e.apply_on])&&(i.forEach(o=>{n[o]=0}),["pricing_rules","margin_type"].forEach(o=>{n[o]&&(n[o]="")}))}),a.trigger_price_list_rate()}}}trigger_price_list_rate(){var e=this;this.frm.doc.items.forEach(t=>{e.frm.script_manager.trigger("price_list_rate",t.doctype,t.name)})}validate_company_and_party(){var e=this,t=!0;return frappe.flags.ignore_company_party_validation||$.each(["company","customer"],function(a,i){frappe.meta.has_field(e.frm.doc.doctype,i)&&!["Purchase Order","Purchase Invoice"].includes(e.frm.doc.doctype)&&(e.frm.doc[i]||(frappe.msgprint(__("Please specify")+": "+frappe.meta.get_label(e.frm.doc.doctype,i,e.frm.doc.name)+". "+__("It is needed to fetch Item Details.")),t=!1))}),t}get_terms(){var e=this;erpnext.utils.get_terms(this.frm.doc.tc_name,this.frm.doc,function(t){t.exc||e.frm.set_value("terms",t.message)})}taxes_and_charges(){var e=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(t){if(!t.exc)if(e.frm.doc.shipping_rule&&e.frm.doc.taxes){for(let a of t.message)e.frm.add_child("taxes",a);refresh_field("taxes")}else e.frm.set_value("taxes",t.message),e.calculate_taxes_and_totals()}})}tax_category(){var e=this;e.frm.updating_party_details||frappe.run_serially([()=>this.update_item_tax_map(),()=>erpnext.utils.set_taxes(this.frm,"tax_category")])}update_item_tax_map(){let e=this,t=[],a={},i={};if(!(e.frm.doc.is_return&&e.frm.doc.return_against)&&($.each(this.frm.doc.items||[],function(s,n){n.item_code&&(t.push([n.item_code,n.name]),a[n.name]=n.base_net_rate,i[n.name]=n.item_tax_template)}),t.length))return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_info",args:{company:e.frm.doc.company,tax_category:cstr(e.frm.doc.tax_category),item_codes:t,item_rates:a,item_tax_templates:i},callback:function(s){s.exc||$.each(e.frm.doc.items||[],function(n,o){o.name&&s.message.hasOwnProperty(o.name)&&s.message[o.name].item_tax_template&&(o.item_tax_template=s.message[o.name].item_tax_template,o.item_tax_rate=s.message[o.name].item_tax_rate,e.add_taxes_from_item_tax_template(o.item_tax_rate))})}})}item_tax_template(e,t,a){var i=this;if(!i.frm.updating_party_details){var s=frappe.get_doc(t,a);if(s.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:i.frm.doc.company,item_tax_template:s.item_tax_template,as_json:!0},callback:function(n){n.exc||(s.item_tax_rate=n.message,i.add_taxes_from_item_tax_template(s.item_tax_rate),i.calculate_taxes_and_totals())}});s.item_tax_rate="{}",i.calculate_taxes_and_totals()}}is_recurring(){if(this.frm.doc.is_recurring&&this.frm.doc.__islocal){frappe.msgprint(__("Please set recurring after saving")),this.frm.set_value("is_recurring",0);return}if(this.frm.doc.is_recurring){this.frm.doc.recurring_id||this.frm.set_value("recurring_id",this.frm.doc.name);var e=this.frm.doc.owner=="Administrator"?frappe.user_info("Administrator").email:this.frm.doc.owner;this.frm.doc.notification_email_address=$.map([cstr(e),cstr(this.frm.doc.contact_email)],function(t){return t||null}).join(", "),this.frm.doc.repeat_on_day_of_month=frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate()}refresh_many(["notification_email_address","repeat_on_day_of_month"])}from_date(){if(this.frm.doc.from_date){var e={Monthly:1,Quarterly:3,"Half-yearly":6,Yearly:12},t=e[this.frm.doc.recurring_type];if(t){var a=frappe.datetime.add_months(this.frm.doc.from_date,t);this.frm.doc.to_date=frappe.datetime.add_days(a,-1),refresh_field("to_date")}}}set_gross_profit(e){if(["Sales Order","Quotation"].includes(this.frm.doc.doctype)&&e.valuation_rate){var t=flt(e.rate)*flt(this.frm.doc.conversion_rate||1);e.gross_profit=flt((t-e.valuation_rate)*e.stock_qty,precision("amount",e))}}setup_item_selector(){}get_advances(){if(!this.frm.is_return){var e=this;return this.frm.call({method:"set_advances",doc:this.frm.doc,callback:function(t,a){refresh_field("advances"),e.frm.dirty()}})}}make_payment_entry(){let e=this.frm.doc.__onload&&this.frm.doc.__onload.make_payment_via_journal_entry;this.has_discount_in_schedule()&&!e?this.prompt_user_for_reference_date():this.make_mapped_payment_entry()}make_mapped_payment_entry(e){var t=this;return e=e||{dt:this.frm.doc.doctype,dn:this.frm.doc.name},frappe.call({method:t.get_method_for_payment(),args:e,callback:function(a){var i=frappe.model.sync(a.message);frappe.set_route("Form",i[0].doctype,i[0].name)}})}prompt_user_for_reference_date(){let e=this;frappe.prompt({label:__("Cheque/Reference Date"),fieldname:"reference_date",fieldtype:"Date",reqd:1},t=>{let a={dt:e.frm.doc.doctype,dn:e.frm.doc.name,reference_date:t.reference_date};e.make_mapped_payment_entry(a)},__("Reference Date for Early Payment Discount"),__("Continue"))}has_discount_in_schedule(){let e=in_list(["Sales Order","Sales Invoice","Purchase Order","Purchase Invoice"],this.frm.doctype),t=this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length;return!e||!t?!1:this.frm.doc.payment_schedule.some(i=>i.discount)}make_quality_inspection(){let e=[],t=[{label:"Items",fieldtype:"Table",fieldname:"items",cannot_add_rows:!0,in_place_edit:!0,data:e,get_data:()=>e,fields:[{fieldtype:"Data",fieldname:"docname",hidden:!0},{fieldtype:"Read Only",fieldname:"item_code",label:__("Item Code"),in_list_view:!0},{fieldtype:"Read Only",fieldname:"item_name",label:__("Item Name"),in_list_view:!0},{fieldtype:"Float",fieldname:"qty",label:__("Accepted Quantity"),in_list_view:!0,read_only:!0},{fieldtype:"Float",fieldname:"sample_size",label:__("Sample Size"),reqd:!0,in_list_view:!0},{fieldtype:"Data",fieldname:"description",label:__("Description"),hidden:!0},{fieldtype:"Data",fieldname:"serial_no",label:__("Serial No"),hidden:!0},{fieldtype:"Data",fieldname:"batch_no",label:__("Batch No"),hidden:!0}]}],a=this,i=new frappe.ui.Dialog({title:__("Select Items for Quality Inspection"),size:"extra-large",fields:t,primary_action:function(){let s=i.get_values();frappe.call({method:"erpnext.controllers.stock_controller.make_quality_inspections",args:{doctype:a.frm.doc.doctype,docname:a.frm.doc.name,items:s.items},freeze:!0,callback:function(n){n.message.length>0&&(n.message.length===1?frappe.set_route("Form","Quality Inspection",n.message[0]):(frappe.route_options={reference_type:a.frm.doc.doctype,reference_name:a.frm.doc.name},frappe.set_route("List","Quality Inspection"))),i.hide()}})},primary_action_label:__("Create")});this.frm.doc.items.forEach(s=>{if(this.has_inspection_required(s)){let n=i.fields_dict.items;n.df.data.push({docname:s.name,item_code:s.item_code,item_name:s.item_name,qty:s.qty,description:s.description,serial_no:s.serial_no,batch_no:s.batch_no,sample_size:s.sample_quantity}),n.grid.refresh()}}),e=i.fields_dict.items.df.data,e.length?i.show():frappe.msgprint(__("All items in this document already have a linked Quality Inspection."))}has_inspection_required(e){if(this.frm.doc.doctype==="Stock Entry"&&this.frm.doc.purpose=="Manufacture"){if(e.is_finished_item&&!e.quality_inspection)return!0}else if(!e.quality_inspection)return!0}get_method_for_payment(){var e="erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry";return cur_frm.doc.__onload&&cur_frm.doc.__onload.make_payment_via_journal_entry&&(["Sales Invoice","Purchase Invoice"].includes(cur_frm.doc.doctype)?e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice":e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order"),e}set_query_for_batch(e,t,a){var i=this,s=frappe.get_doc(t,a);if(!s.item_code)frappe.throw(__("Please enter Item Code to get batch no"));else{if(e.doctype=="Purchase Receipt"||e.doctype=="Purchase Invoice"&&e.update_stock)return{filters:{item:s.item_code}};{let n={item_code:s.item_code,posting_date:i.frm.doc.posting_date||frappe.datetime.nowdate()};return e.is_return&&(n.is_return=1,["Sales Invoice","Delivery Note"].includes(e.doctype)&&(n.is_inward=1)),s.warehouse&&(n.warehouse=s.warehouse),{query:"erpnext.controllers.queries.get_batch_no",filters:n}}}}set_query_for_item_tax_template(e,t,a){var i=frappe.get_doc(t,a);if(i.item_code){let s={item_code:i.item_code,valid_from:["<=",e.transaction_date||e.bill_date||e.posting_date],item_group:i.item_group};return e.tax_category&&(s.tax_category=e.tax_category),e.company&&(s.company=e.company),{query:"erpnext.controllers.queries.get_tax_template",filters:s}}else return e.company?{filters:{company:e.company}}:{}}payment_terms_template(){var e=this;let t=this.frm.doc;if(t.payment_terms_template&&t.doctype!=="Delivery Note"&&!t.is_return){var a=t.posting_date||t.transaction_date;frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_terms",args:{terms_template:t.payment_terms_template,posting_date:a,grand_total:t.rounded_total||t.grand_total,base_grand_total:t.base_rounded_total||t.base_grand_total,bill_date:t.bill_date},callback:function(i){if(i.message&&!i.exc){e.frm.set_value("payment_schedule",i.message);let s=e.get_company_currency();e.update_payment_schedule_grid_labels(s)}}})}}payment_term(e,t,a){let i=this;var s=locals[t][a];s.payment_term&&frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_term_details",args:{term:s.payment_term,bill_date:this.frm.doc.bill_date,posting_date:this.frm.doc.posting_date||this.frm.doc.transaction_date,grand_total:this.frm.doc.rounded_total||this.frm.doc.grand_total,base_grand_total:this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total},callback:function(n){if(n.message&&!n.exc)for(var o in n.message){frappe.model.set_value(t,a,o,n.message[o]);let l=i.get_company_currency();i.update_payment_schedule_grid_labels(l)}}})}against_blanket_order(e,t,a){var i=locals[t][a];i.against_blanket_order||(frappe.model.set_value(this.frm.doctype+" Item",i.name,"blanket_order",null),frappe.model.set_value(this.frm.doctype+" Item",i.name,"blanket_order_rate",0))}blanket_order(e,t,a){var i=this,s=locals[t][a];s.blanket_order&&(s.parenttype=="Sales Order"||s.parenttype=="Purchase Order")&&frappe.call({method:"erpnext.stock.get_item_details.get_blanket_order_details",args:{args:{item_code:s.item_code,customer:e.customer,supplier:e.supplier,company:e.company,transaction_date:e.transaction_date,blanket_order:s.blanket_order}},callback:function(n){n.message?frappe.run_serially([()=>frappe.model.set_value(t,a,"blanket_order_rate",n.message.blanket_order_rate),()=>i.frm.script_manager.trigger("price_list_rate",t,a)]):frappe.throw(__("Invalid Blanket Order for the selected Customer and Item"))}})}set_reserve_warehouse(){this.autofill_warehouse(this.frm.doc.supplied_items,"reserve_warehouse",this.frm.doc.set_reserve_warehouse)}set_warehouse(){this.autofill_warehouse(this.frm.doc.items,"warehouse",this.frm.doc.set_warehouse)}set_target_warehouse(){this.autofill_warehouse(this.frm.doc.items,"target_warehouse",this.frm.doc.set_target_warehouse)}set_from_warehouse(){this.autofill_warehouse(this.frm.doc.items,"from_warehouse",this.frm.doc.set_from_warehouse)}autofill_warehouse(e,t,a){if(a&&e&&e.length){let i=e[0].doctype;$.each(e||[],function(s,n){frappe.model.set_value(i,n.name,t,a)})}}coupon_code(){if(this.frm.doc.coupon_code||this.frm._last_coupon_code){let e=this.frm.doc.ignore_pricing_rule;return frappe.run_serially([()=>this.frm.doc.ignore_pricing_rule=1,()=>this.frm.trigger("ignore_pricing_rule"),()=>this.frm.doc.ignore_pricing_rule=e,()=>this.frm.trigger("apply_pricing_rule"),()=>this.frm._last_coupon_code=this.frm.doc.coupon_code])}}};erpnext.show_serial_batch_selector=function(r,e,t,a,i){let s,n,o,l="warehouse";r.doc.is_return?["Purchase Receipt","Purchase Invoice"].includes(r.doc.doctype)?(o=!0,s=e.warehouse):["Delivery Note","Sales Invoice"].includes(r.doc.doctype)&&(n=!0):r.doc.doctype=="Stock Entry"?(r.doc.purpose=="Material Receipt"?n=!0:(o=!0,s=e.s_warehouse),in_list(["Material Transfer","Send to Subcontractor","Material Issue","Material Consumption for Manufacture","Material Transfer for Manufacture"],r.doc.purpose)?l="s_warehouse":l="t_warehouse"):(o=!0,s=e.warehouse),s||(n?s=["like",""]:o&&(s=["!=",""])),["Sales Invoice","Delivery Note"].includes(r.doc.doctype)?e.type_of_transaction=r.doc.is_return?"Inward":"Outward":e.type_of_transaction=r.doc.is_return?"Outward":"Inward",new erpnext.SerialBatchPackageSelector(r,e,c=>{if(c){let d={serial_and_batch_bundle:c.name,qty:Math.abs(c.total_qty)};c.warehouse&&(d[l]=c.warehouse),frappe.model.set_value(e.doctype,e.name,d)}})};erpnext.apply_putaway_rule=(r,e=null)=>{r.doc.company||frappe.throw({message:__("Please select a Company first."),title:__("Mandatory")}),r.doc.items.length&&frappe.call({method:"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule",args:{doctype:r.doctype,items:r.doc.items,company:r.doc.company,sync:!0,purpose:e},callback:t=>{!t.exc&&t.message&&(r.clear_table("items"),t.message.forEach(i=>{delete i.name;let s=r.add_child("items");Object.assign(s,i),r.script_manager.trigger("qty",s.doctype,s.name)}),r.get_field("items").grid.refresh())}})};frappe.templates.item_selector=`<div class="app-listing item-list image-view-container item-selector">
{% for (var i=0; i < data.length; i++) { var item = data[i]; %}
	{% if (i % 4 === 0) { %}<div class="image-view-row">{% } %}
	<div class="image-view-item" data-name="{{ item.name }}">
		<div class="image-view-header doclist-row">
			<div class="list-value">
				<a class="grey list-id" data-name="{{item.name}}"
					title="{{ item.item_name || item.name}}">
					{{item.item_name || item.name}}</a>
			</div>
		</div>
		<div class="image-view-body">
			<a  data-item-code="{{ item.name }}"
				title="{{ item.item_name || item.name }}"
			>
				<div class="image-field"
					style="
					{% if (!item.image) { %}
						background-color: #fafbfc;
					{% } %}
					border: 0px;"
				>
					{% if (!item.image) { %}
					<span class="placeholder-text">
						{%= frappe.get_abbr(item.item_name || item.name) %}
					</span>
					{% } %}
					{% if (item.image) { %}
					<img src="{{ item.image }}" alt="{{item.item_name || item.name}}">
					{% } %}
				</div>
			</a>
		</div>
	</div>
	{% if ((i % 4 === 3) || (i===data.length - 1)) { %}</div>{% } %}
{% endfor %}
</div>
`;erpnext.ItemSelector=class{constructor(e){$.extend(this,e),this.item_field||(this.item_field="item_code"),this.item_query||(this.item_query=erpnext.queries.item().query),this.grid=this.frm.get_field("items").grid,this.setup()}setup(){var e=this;this.grid.add_items_button||(this.grid.add_items_button=this.grid.add_custom_button(__("Add Items"),function(){e.dialog||e.make_dialog(),e.dialog.show(),e.render_items(),setTimeout(function(){e.dialog.input.focus()},1e3)}))}make_dialog(){this.dialog=new frappe.ui.Dialog({title:__("Add Items")});var e=$(this.dialog.body);e.html('<div><p><input type="text" class="form-control"></p>			<br><div class="results"></div></div>'),this.dialog.input=e.find(".form-control"),this.dialog.results=e.find(".results");var t=this;this.dialog.results.on("click",".image-view-item",function(){t.add_item($(this).attr("data-name"))}),this.dialog.input.on("keyup",function(){t.timeout_id&&clearTimeout(t.timeout_id),t.timeout_id=setTimeout(function(){t.render_items(),t.timeout_id=void 0},500)})}add_item(e){var t=!1;if($.each(this.frm.doc.items||[],(i,s)=>{if(s[this.item_field]===e)return frappe.model.set_value(s.doctype,s.name,"qty",s.qty+1),frappe.show_alert({message:__("Added {0} ({1})",[e,s.qty]),indicator:"green"}),t=!0,!1}),!t){var a=null;frappe.run_serially([()=>{a=this.grid.add_new_row()},()=>frappe.model.set_value(a.doctype,a.name,this.item_field,e),()=>frappe.timeout(.1),()=>{frappe.model.set_value(a.doctype,a.name,"qty",1),frappe.show_alert({message:__("Added {0} ({1})",[e,1]),indicator:"green"})}])}}render_items(){let e={query:this.item_query,filters:{}};e.txt=this.dialog.input.val(),e.as_dict=1,this.get_filters&&$.extend(e.filters,this.get_filters()||{});var t=this;frappe.link_search("Item",e,function(a){$.each(a,function(i,s){s.image||(s.abbr=frappe.get_abbr(s.item_name),s.color=frappe.get_palette(s.item_name))}),t.dialog.results.html(frappe.render_template("item_selector",{data:a}))})}};frappe.provide("frappe.help.help_links");var _="https://erpnext.com/docs/";frappe.help.help_links["Form/Rename Tool"]=[{label:"Bulk Rename",url:_+"user/manual/en/transactions-bulk-rename"}];frappe.help.help_links["List/User"]=[{label:"New User",url:_+"user/manual/en/adding-users"},{label:"Rename User",url:_+"user/manual/en/renaming-documents"}];frappe.help.help_links["permission-manager"]=[{label:"Role Based Permissions",url:_+"user/manual/en/role-based-permissions"},{label:"Managing Perm Level in Permissions Manager",url:_+"user/manual/en/managing-perm-level"},{label:"User Permissions",url:_+"user/manual/en/user-permissions"},{label:"Sharing",url:_+"user/manual/en/sharing"},{label:"Password",url:_+"user/manual/en/change-password"}];frappe.help.help_links["Form/System Settings"]=[{label:"System Settings",url:_+"user/manual/en/system-settings"}];frappe.help.help_links["Form/Data Import"]=[{label:"Importing and Exporting Data",url:_+"user/manual/en/data-import"}];frappe.help.help_links["List/Data Import"]=[{label:"Importing and Exporting Data",url:_+"user/manual/en/data-import"}];frappe.help.help_links.module_setup=[{label:"Role Permissions Manager",url:_+"user/manual/en/role-based-permissions"}];frappe.help.help_links["Form/Document Naming Settings"]=[{label:"Naming Series",url:_+"user/manual/en/document-naming-settings"}];frappe.help.help_links["Form/Global Defaults"]=[{label:"Global Settings",url:_+"user/manual/en/global-defaults"}];frappe.help.help_links["List/Print Heading"]=[{label:"Print Heading",url:_+"user/manual/en/print-headings"}];frappe.help.help_links["Form/Print Heading"]=[{label:"Print Heading",url:_+"user/manual/en/print-headings"}];frappe.help.help_links["List/Letter Head"]=[{label:"Letter Head",url:_+"user/manual/en/letter-head"}];frappe.help.help_links["List/Address Template"]=[{label:"Address Template",url:_+"user/manual/en/address-template"}];frappe.help.help_links["List/Terms and Conditions"]=[{label:"Terms and Conditions",url:_+"user/manual/en/terms-and-conditions"}];frappe.help.help_links["List/Cheque Print Template"]=[{label:"Cheque Print Template",url:_+"user/manual/en/cheque-print-template"}];frappe.help.help_links["List/Email Account"]=[{label:"Email Account",url:_+"user/manual/en/email-account"}];frappe.help.help_links["List/Notification"]=[{label:"Notification",url:_+"user/manual/en/notifications"}];frappe.help.help_links["Form/Notification"]=[{label:"Notification",url:_+"user/manual/en/notifications"}];frappe.help.help_links["Form/Email Digest"]=[{label:"Email Digest",url:_+"user/manual/en/email-digest"}];frappe.help.help_links["Form/Email Digest"]=[{label:"Email Digest",url:_+"user/manual/en/email-digest"}];frappe.help.help_links["List/Auto Email Report"]=[{label:"Auto Email Reports",url:_+"user/manual/en/auto-email-reports"}];frappe.help.help_links["Form/Print Settings"]=[{label:"Print Settings",url:_+"user/manual/en/print-settings"}];frappe.help.help_links["print-format-builder"]=[{label:"Print Format Builder",url:_+"user/manual/en/print-format-builder"}];frappe.help.help_links["Form/PayPal Settings"]=[{label:"PayPal Settings",url:_+"user/manual/en/paypal-integration"}];frappe.help.help_links["Form/Razorpay Settings"]=[{label:"Razorpay Settings",url:_+"user/manual/en/razorpay-integration"}];frappe.help.help_links["Form/Dropbox Settings"]=[{label:"Dropbox Settings",url:_+"user/manual/en/dropbox-backup"}];frappe.help.help_links["Form/LDAP Settings"]=[{label:"LDAP Settings",url:_+"user/manual/en/ldap-integration"}];frappe.help.help_links["Form/Stripe Settings"]=[{label:"Stripe Settings",url:_+"user/manual/en/stripe-integration"}];frappe.help.help_links["Form/Quotation"]=[{label:"Quotation",url:_+"user/manual/en/quotation"},{label:"Applying Discount",url:_+"user/manual/en/applying-discount"},{label:"Sales Person",url:_+"user/manual/en/sales-persons-in-the-sales-transactions"},{label:"Applying Margin",url:_+"user/manual/en/adding-margin"}];frappe.help.help_links["List/Customer"]=[{label:"Customer",url:_+"user/manual/en/customer"},{label:"Credit Limit",url:_+"user/manual/en/credit-limit"}];frappe.help.help_links["Form/Customer"]=[{label:"Customer",url:_+"user/manual/en/customer"},{label:"Credit Limit",url:_+"user/manual/en/credit-limit"}];frappe.help.help_links["List/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:_+"user/manual/en/setting-up-taxes"}];frappe.help.help_links["Form/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:_+"user/manual/en/setting-up-taxes"}];frappe.help.help_links["List/Sales Order"]=[{label:"Sales Order",url:_+"user/manual/en/sales-order"},{label:"Recurring Sales Order",url:_+"user/manual/en/auto-repeat"},{label:"Applying Discount",url:_+"user/manual/en/applying-discount"}];frappe.help.help_links["Form/Sales Order"]=[{label:"Sales Order",url:_+"user/manual/en/sales-order"},{label:"Recurring Sales Order",url:_+"user/manual/en/auto-repeat"},{label:"Applying Discount",url:_+"user/manual/en/applying-discount"},{label:"Drop Shipping",url:_+"user/manual/en/drop-shipping"},{label:"Sales Person",url:_+"user/manual/en/sales-persons-in-the-sales-transactions"},{label:"Close Sales Order",url:_+"user/manual/en/close-sales-order"},{label:"Applying Margin",url:_+"user/manual/en/adding-margin"}];frappe.help.help_links["Form/Product Bundle"]=[{label:"Product Bundle",url:_+"user/manual/en/product-bundle"}];frappe.help.help_links["Form/Selling Settings"]=[{label:"Selling Settings",url:_+"user/manual/en/selling-settings"}];frappe.help.help_links["List/Supplier"]=[{label:"Supplier",url:_+"user/manual/en/supplier"}];frappe.help.help_links["Form/Supplier"]=[{label:"Supplier",url:_+"user/manual/en/supplier"}];frappe.help.help_links["Form/Request for Quotation"]=[{label:"Request for Quotation",url:_+"user/manual/en/request-for-quotation"},{label:"RFQ Video",url:_+"user/videos/learn/request-for-quotation.html"}];frappe.help.help_links["Form/Supplier Quotation"]=[{label:"Supplier Quotation",url:_+"user/manual/en/supplier-quotation"}];frappe.help.help_links["Form/Buying Settings"]=[{label:"Buying Settings",url:_+"user/manual/en/buying-settings"}];frappe.help.help_links["List/Purchase Order"]=[{label:"Purchase Order",url:_+"user/manual/en/purchase-order"},{label:"Recurring Purchase Order",url:_+"user/manual/en/auto-repeat"}];frappe.help.help_links["Form/Purchase Order"]=[{label:"Purchase Order",url:_+"user/manual/en/purchase-order"},{label:"Item UoM",url:_+"user/manual/en/purchasing-in-different-unit"},{label:"Supplier Item Code",url:_+"user/manual/en/maintaining-suppliers-part-no-in-item"},{label:"Recurring Purchase Order",url:_+"user/manual/en/auto-repeat"},{label:"Subcontracting",url:_+"user/manual/en/subcontracting"}];frappe.help.help_links["List/Purchase Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:_+"user/manual/en/setting-up-taxes"}];frappe.help.help_links["List/Price List"]=[{label:"Price List",url:_+"user/manual/en/price-lists"}];frappe.help.help_links["List/Authorization Rule"]=[{label:"Authorization Rule",url:_+"user/manual/en/authorization-rule"}];frappe.help.help_links["Form/SMS Settings"]=[{label:"SMS Settings",url:_+"user/manual/en/sms-setting"}];frappe.help.help_links["List/Stock Reconciliation"]=[{label:"Stock Reconciliation",url:_+"user/manual/en/stock-reconciliation"}];frappe.help.help_links["Tree/Territory"]=[{label:"Territory",url:_+"user/manual/en/territory"}];frappe.help.help_links["List/Workflow"]=[{label:"Workflow",url:_+"user/manual/en/workflows"}];frappe.help.help_links["List/Company"]=[{label:"Company",url:_+"user/manual/en/company-setup"},{label:"Delete All Related Transactions for a Company",url:_+"user/manual/en/delete_company_transactions"}];frappe.help.help_links["Tree/Account"]=[{label:"Chart of Accounts",url:_+"user/manual/en/chart-of-accounts"},{label:"Managing Tree Mastes",url:_+"user/manual/en/managing-tree-structure-masters"}];frappe.help.help_links["Form/Sales Invoice"]=[{label:"Sales Invoice",url:_+"user/manual/en/sales-invoice"},{label:"Accounts Opening Balance",url:_+"user/manual/en/opening-balance"},{label:"Sales Return",url:_+"user/manual/en/sales-return"},{label:"Recurring Sales Invoice",url:_+"user/manual/en/auto-repeat"}];frappe.help.help_links["List/Sales Invoice"]=[{label:"Sales Invoice",url:_+"user/manual/en/sales-invoice"},{label:"Accounts Opening Balance",url:_+"user/manual/en/opening-balance"},{label:"Sales Return",url:_+"user/manual/en/sales-return"},{label:"Recurring Sales Invoice",url:_+"user/manual/en/auto-repeat"}];frappe.help.help_links["point-of-sale"]=[{label:"Point of Sale Invoice",url:_+"user/manual/en/point-of-sales"}];frappe.help.help_links["List/POS Profile"]=[{label:"Point of Sale Profile",url:_+"user/manual/en/pos-profile"}];frappe.help.help_links["Form/POS Profile"]=[{label:"POS Profile",url:_+"user/manual/en/pos-profile"}];frappe.help.help_links["List/Purchase Invoice"]=[{label:"Purchase Invoice",url:_+"user/manual/en/purchase-invoice"},{label:"Accounts Opening Balance",url:_+"user/manual/en/opening-balance"},{label:"Recurring Purchase Invoice",url:_+"user/manual/en/auto-repeat"}];frappe.help.help_links["List/Journal Entry"]=[{label:"Journal Entry",url:_+"user/manual/en/journal-entry"},{label:"Advance Payment Entry",url:_+"user/manual/en/advance-payment-entry"},{label:"Accounts Opening Balance",url:_+"user/manual/en/opening-balance"}];frappe.help.help_links["List/Payment Entry"]=[{label:"Payment Entry",url:_+"user/manual/en/payment-entry"}];frappe.help.help_links["List/Payment Request"]=[{label:"Payment Request",url:_+"user/manual/en/payment-request"}];frappe.help.help_links["List/Asset"]=[{label:"Managing Fixed Assets",url:_+"user/manual/en/asset"}];frappe.help.help_links["List/Asset Category"]=[{label:"Asset Category",url:_+"user/manual/en/asset-category"}];frappe.help.help_links["Tree/Cost Center"]=[{label:"Budgeting",url:_+"user/manual/en/budgeting"}];frappe.help.help_links["List/Item"]=[{label:"Item",url:_+"user/manual/en/item"},{label:"Item Price",url:_+"user/manual/en/item-price"},{label:"Barcode",url:_+"user/manual/en/track-items-using-barcode"},{label:"Item Wise Taxation",url:_+"user/manual/en/item-tax-template"},{label:"Managing Fixed Assets",url:_+"user/manual/en/asset"},{label:"Item Codification",url:_+"user/manual/en/item-codification"},{label:"Item Variants",url:_+"user/manual/en/item-variants"},{label:"Item Valuation",url:_+"user/manual/en/calculation-of-valuation-rate-in-fifo-and-moving-average"}];frappe.help.help_links["Form/Item"]=[{label:"Item",url:_+"user/manual/en/item"},{label:"Item Price",url:_+"user/manual/en/item-price"},{label:"Barcode",url:_+"user/manual/en/track-items-using-barcode"},{label:"Item Wise Taxation",url:_+"user/manual/en/item-tax-template"},{label:"Managing Fixed Assets",url:_+"user/manual/en/asset"},{label:"Item Codification",url:_+"user/manual/en/item-codification"},{label:"Item Variants",url:_+"user/manual/en/item-variants"},{label:"Item Valuation",url:_+"user/manual/en/item-valuation-transactions"}];frappe.help.help_links["List/Purchase Receipt"]=[{label:"Purchase Receipt",url:_+"user/manual/en/purchase-receipt"},{label:"Barcode",url:_+"user/manual/en/track-items-using-barcode"}];frappe.help.help_links["List/Delivery Note"]=[{label:"Delivery Note",url:_+"user/manual/en/delivery-note"},{label:"Barcode",url:_+"user/manual/en/track-items-using-barcode"},{label:"Sales Return",url:_+"user/manual/en/sales-return"}];frappe.help.help_links["Form/Delivery Note"]=[{label:"Delivery Note",url:_+"user/manual/en/delivery-note"},{label:"Sales Return",url:_+"user/manual/en/sales-return"},{label:"Barcode",url:_+"user/manual/en/track-items-using-barcode"}];frappe.help.help_links["List/Installation Note"]=[{label:"Installation Note",url:_+"user/manual/en/installation-note"}];frappe.help.help_links["List/Budget"]=[{label:"Budgeting",url:_+"user/manual/en/budgeting"}];frappe.help.help_links["List/Material Request"]=[{label:"Material Request",url:_+"user/manual/en/material-request"},{label:"Auto-creation of Material Request",url:_+"user/manual/en/auto-creation-of-material-request"}];frappe.help.help_links["Form/Material Request"]=[{label:"Material Request",url:_+"user/manual/en/material-request"},{label:"Auto-creation of Material Request",url:_+"user/manual/en/auto-creation-of-material-request"}];frappe.help.help_links["Form/Stock Entry"]=[{label:"Stock Entry",url:_+"user/manual/en/stock-entry"},{label:"Stock Entry Types",url:_+"user/manual/en/stock-entry-purpose"},{label:"Repack Entry",url:_+"user/manual/en/repack-entry"},{label:"Opening Stock",url:_+"user/manual/en/opening-stock"},{label:"Subcontracting",url:_+"user/manual/en/subcontracting"}];frappe.help.help_links["List/Stock Entry"]=[{label:"Stock Entry",url:_+"user/manual/en/stock-entry"}];frappe.help.help_links["Tree/Warehouse"]=[{label:"Warehouse",url:_+"user/manual/en/warehouse"}];frappe.help.help_links["List/Serial No"]=[{label:"Serial No",url:_+"user/manual/en/serial-no"}];frappe.help.help_links["Form/Serial No"]=[{label:"Serial No",url:_+"user/manual/en/serial-no"}];frappe.help.help_links["List/Batch"]=[{label:"Batch",url:_+"user/manual/en/batch"}];frappe.help.help_links["Form/Batch"]=[{label:"Batch",url:_+"user/manual/en/batch"}];frappe.help.help_links["Form/Packing Slip"]=[{label:"Packing Slip",url:_+"user/manual/en/packing-slip"}];frappe.help.help_links["Form/Quality Inspection"]=[{label:"Quality Inspection",url:_+"user/manual/en/quality-inspection"}];frappe.help.help_links["Form/Landed Cost Voucher"]=[{label:"Landed Cost Voucher",url:_+"user/manual/en/landed-cost-voucher"}];frappe.help.help_links["Tree/Item Group"]=[{label:"Item Group",url:_+"user/manual/en/item-group"}];frappe.help.help_links["Form/Item Attribute"]=[{label:"Item Attribute",url:_+"user/manual/en/item-attribute"}];frappe.help.help_links["Form/UOM"]=[{label:"Fractions in UOM",url:_+"user/manual/en/managing-fractions-in-uom"}];frappe.help.help_links["Form/Stock Reconciliation"]=[{label:"Opening Stock Entry",url:_+"user/manual/en/stock-reconciliation"}];frappe.help.help_links["Form/Lead"]=[{label:"Lead",url:_+"user/manual/en/lead"}];frappe.help.help_links["Form/Opportunity"]=[{label:"Opportunity",url:_+"user/manual/en/opportunity"}];frappe.help.help_links["Form/Address"]=[{label:"Address",url:_+"user/manual/en/address"}];frappe.help.help_links["Form/Contact"]=[{label:"Contact",url:_+"user/manual/en/contact"}];frappe.help.help_links["Form/Newsletter"]=[{label:"Newsletter",url:_+"user/manual/en/newsletter"}];frappe.help.help_links["Form/Campaign"]=[{label:"Campaign",url:_+"user/manual/en/campaign"}];frappe.help.help_links["Tree/Sales Person"]=[{label:"Sales Person",url:_+"user/manual/en/sales-person"}];frappe.help.help_links["Form/Sales Person"]=[{label:"Sales Person Target",url:_+"user/manual/en/sales-person-target-allocation"},{label:"Sales Person in Transactions",url:_+"user/manual/en/sales-persons-in-the-sales-transactions"}];frappe.help.help_links["Form/BOM"]=[{label:"Bill of Material",url:_+"user/manual/en/bill-of-materials"},{label:"Nested BOM Structure",url:_+"user/manual/en/managing-multi-level-bom"}];frappe.help.help_links["Form/Work Order"]=[{label:"Work Order",url:_+"user/manual/en/work-order"}];frappe.help.help_links["Form/Workstation"]=[{label:"Workstation",url:_+"user/manual/en/workstation"}];frappe.help.help_links["Form/Operation"]=[{label:"Operation",url:_+"user/manual/en/operation"}];frappe.help.help_links["Form/BOM Update Tool"]=[{label:"BOM Update Tool",url:_+"user/manual/en/bom-update-tool"}];frappe.help.help_links["Form/Customize Form"]=[{label:"Custom Field",url:_+"user/manual/en/custom-field"},{label:"Customize Field",url:_+"user/manual/en/customize-form"}];frappe.help.help_links["List/Custom Field"]=[{label:"Custom Field",url:_+"user/manual/en/custom-field"}];frappe.help.help_links["Form/Custom Field"]=[{label:"Custom Field",url:_+"user/manual/en/custom-field"}];frappe.templates.item_quick_entry=`<div class="h6 uppercase" style="margin-top: 30px;">{{ __("Variant Attributes") }}</div>
<div class="attributes hide-control">
</div>
`;frappe.provide("frappe.ui.form");frappe.ui.form.ContactAddressQuickEntryForm=class extends frappe.ui.form.QuickEntryForm{constructor(e,t,a,i,s){super(e,t,a,i,s),this.skip_redirect_on_error=!0}render_dialog(){this.mandatory=this.mandatory.concat(this.get_variant_fields()),super.render_dialog()}insert(){return Object.entries({email_address:"email_id",mobile_number:"mobile_no"}).forEach(([t,a])=>{this.dialog.doc[a]=this.dialog.doc[t],delete this.dialog.doc[t]}),super.insert()}get_variant_fields(){var e=[{fieldtype:"Section Break",label:__("Primary Contact Details"),collapsible:1},{label:__("Email Id"),fieldname:"email_address",fieldtype:"Data",options:"Email"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"mobile_number",fieldtype:"Data"},{fieldtype:"Section Break",label:__("Primary Address Details"),collapsible:1},{label:__("Address Line 1"),fieldname:"address_line1",fieldtype:"Data"},{label:__("Address Line 2"),fieldname:"address_line2",fieldtype:"Data"},{label:__("ZIP Code"),fieldname:"pincode",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("City"),fieldname:"city",fieldtype:"Data"},{label:__("State"),fieldname:"state",fieldtype:"Data"},{label:__("Country"),fieldname:"country",fieldtype:"Link",options:"Country"},{label:__("Customer POS Id"),fieldname:"customer_pos_id",fieldtype:"Data",hidden:1}];return e}};frappe.provide("frappe.ui.form");frappe.ui.form.CustomerQuickEntryForm=frappe.ui.form.ContactAddressQuickEntryForm;frappe.provide("frappe.ui.form");frappe.ui.form.SupplierQuickEntryForm=frappe.ui.form.ContactAddressQuickEntryForm;var m=class{constructor(e){this.caller_number=e.from,this.call_log=e,this.setup_listener(),this.make()}make(){frappe.utils.play_sound("incoming-call"),this.dialog=new frappe.ui.Dialog({static:!0,minimizable:!0}),this.dialog.get_close_btn().show(),this.setup_dialog(),this.set_call_status(),frappe.utils.bind_actions_with_object(this.dialog.$body,this),this.dialog.$wrapper.addClass("call-popup"),this.dialog.get_close_btn().unbind("click").click(this.close_modal.bind(this)),this.dialog.show()}setup_dialog(){this.setup_call_details(),this.dialog.$body.empty().append(this.caller_info)}set_indicator(e,t=!1){let a=`indicator ${e} ${t?"blink":""}`;this.dialog.header.find(".indicator").attr("class",a)}set_call_status(e){let t="";e=e||this.call_log.status,["Ringing"].includes(e)||!e?(t=__("Incoming call from {0}",[this.get_caller_name()||this.caller_number]),this.set_indicator("blue",!0)):e==="In Progress"?(t=__("Call Connected"),this.set_indicator("green")):["No Answer","Missed"].includes(e)?(this.set_indicator("yellow"),t=__("Call Missed")):["Completed","Busy","Failed"].includes(e)?(this.set_indicator("red"),t=__("Call Ended")):(this.set_indicator("blue"),t=e),this.dialog.set_title(t)}update_call_log(e,t){this.call_log=e,this.set_call_status(t?"Missed":null)}close_modal(){this.dialog.hide(),delete erpnext.call_popup}call_ended(e,t){frappe.utils.play_sound("call-disconnect"),this.update_call_log(e,t),setTimeout(()=>{this.dialog.get_value("call_summary")||this.close_modal()},6e4),this.clear_listeners()}get_caller_name(){let e=this.get_contact_link();return e.link_title||e.link_name}get_contact_link(){return this.call_log.links.find(a=>a.link_doctype==="Contact")||{}}setup_listener(){frappe.realtime.on(`call_${this.call_log.id}_ended`,e=>{this.call_ended(e)}),frappe.realtime.on(`call_${this.call_log.id}_missed`,e=>{this.call_ended(e,!0)})}clear_listeners(){frappe.realtime.off(`call_${this.call_log.id}_ended`),frappe.realtime.off(`call_${this.call_log.id}_missed`)}setup_call_details(){this.caller_info=$("<div></div>"),this.call_details=new frappe.ui.FieldGroup({fields:[{fieldname:"name",label:"Name",default:this.get_caller_name()||__("Unknown Caller"),fieldtype:"Data",read_only:1},{fieldtype:"Button",label:__("Open Contact"),click:()=>frappe.set_route("Form","Contact",this.get_contact_link().link_name),depends_on:()=>this.get_caller_name()},{fieldtype:"Button",label:__("Create New Contact"),click:this.create_new_contact.bind(this),depends_on:()=>!this.get_caller_name()},{fieldtype:"Button",label:__("Create New Customer"),click:this.create_new_customer.bind(this),depends_on:()=>!this.get_caller_name()},{fieldtype:"Button",label:__("Create New Lead"),click:()=>frappe.new_doc("Lead",{mobile_no:this.caller_number}),depends_on:()=>!this.get_caller_name()},{fieldtype:"Column Break"},{fieldname:"number",label:"Phone Number",fieldtype:"Data",default:this.caller_number,read_only:1},{fieldtype:"Section Break",hide_border:1},{fieldname:"call_type",label:"Call Type",fieldtype:"Link",options:"Telephony Call Type"},{fieldtype:"Section Break",hide_border:1},{fieldtype:"Small Text",label:__("Call Summary"),fieldname:"call_summary"},{fieldtype:"Button",label:__("Save"),click:()=>{let e=this.call_details.get_value("call_summary"),t=this.call_details.get_value("call_type");!e||frappe.xcall("erpnext.telephony.doctype.call_log.call_log.add_call_summary_and_call_type",{call_log:this.call_log.name,summary:e,call_type:t}).then(()=>{this.close_modal(),frappe.show_alert({message:`
								${__("Call Summary Saved")}
								<br>
								<a
									class="text-small text-muted"
									href="/app/call-log/${this.call_log.name}">
									${__("View call log")}
								</a>
							`,indicator:"green"})})}}],body:this.caller_info}),this.call_details.make()}is_known_caller(){return Boolean(this.get_caller_name())}create_new_customer(){let e=frappe.model.get_new_doc("Customer");e.mobile_no=this.caller_number,frappe.set_route("Form",e.doctype,e.name)}create_new_contact(){let e=frappe.model.get_new_doc("Contact"),t=frappe.model.add_child(e,"Contact Phone","phone_nos");t.phone=this.caller_number,t.is_primary_mobile_no=1,frappe.set_route("Form",e.doctype,e.name)}};$(document).on("app_ready",function(){frappe.realtime.on("show_call_popup",r=>{let e=erpnext.call_popup;e&&r.name===e.call_log.name?(e.update_call_log(r),e.dialog.show()):erpnext.call_popup=new m(r)})});window.CallPopup=m;frappe.provide("erpnext.accounts");erpnext.accounts.dimensions={setup_dimension_filters(r,e){this.accounting_dimensions=[],this.default_dimensions={},this.fetch_custom_dimensions(r,e)},fetch_custom_dimensions(r,e){let t=this;frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions",args:{with_cost_center_and_project:!0},callback:function(a){t.accounting_dimensions=a.message[0],t.accounting_dimensions=t.accounting_dimensions.filter(i=>i.document_type!="Project"),t.default_dimensions=a.message[1],t.setup_filters(r,e)}})},setup_filters(r,e){e=="Payment Entry"&&this.accounting_dimensions&&(r.dimension_filters=this.accounting_dimensions),this.accounting_dimensions&&this.accounting_dimensions.forEach(t=>{frappe.model.with_doctype(t.document_type,()=>{let a=[];frappe.meta.get_docfields(e).forEach(i=>{i.fieldtype==="Link"&&i.options==="Account"?a.push(i.fieldname):i.fieldtype==="Table"&&this.setup_child_filters(r,i.options,i.fieldname,t.fieldname),frappe.meta.has_field(e,t.fieldname)&&this.setup_account_filters(r,t.fieldname,a)})})})},setup_child_filters(r,e,t,a){let i=[];frappe.meta.has_field(e,a)&&frappe.model.with_doctype(e,()=>{frappe.meta.get_docfields(e).forEach(s=>{s.fieldtype==="Link"&&s.options==="Account"&&i.push(s.fieldname)}),r.set_query(a,t,function(s,n,o){let l=locals[n][o];return erpnext.queries.get_filtered_dimensions(l,i,a,s.company)})})},setup_account_filters(r,e,t){r.set_query(e,function(a){return erpnext.queries.get_filtered_dimensions(a,t,e,a.company)})},update_dimension(r,e){this.accounting_dimensions&&this.accounting_dimensions.forEach(t=>{if(r.is_new()&&r.doc.company&&Object.keys(this.default_dimensions||{}).length>0&&this.default_dimensions[r.doc.company]){let a=this.default_dimensions[r.doc.company][t.fieldname];a&&(frappe.meta.has_field(e,t.fieldname)&&r.set_value(t.fieldname,a),$.each(r.doc.items||r.doc.accounts||[],function(i,s){frappe.model.set_value(s.doctype,s.name,t.fieldname,a)}))}})},copy_dimension_from_first_row(r,e,t,a){frappe.meta.has_field(r.doctype,a)&&this.accounting_dimensions&&this.accounting_dimensions.forEach(i=>{let s=frappe.get_doc(e,t);r.script_manager.copy_from_first_row(a,s,[i.fieldname])})}};frappe.provide("erpnext.accounts");erpnext.accounts.ledger_preview={show_accounting_ledger_preview(r){let e=this;!r.is_new()&&r.doc.docstatus==0&&r.add_custom_button(__("Accounting Ledger"),function(){frappe.call({type:"GET",method:"erpnext.controllers.stock_controller.show_accounting_ledger_preview",args:{company:r.doc.company,doctype:r.doc.doctype,docname:r.doc.name},callback:function(t){e.make_dialog("Accounting Ledger Preview","accounting_ledger_preview_html",t.message.gl_columns,t.message.gl_data)}})},__("Preview"))},show_stock_ledger_preview(r){let e=this;!r.is_new()&&r.doc.docstatus==0&&r.add_custom_button(__("Stock Ledger"),function(){frappe.call({type:"GET",method:"erpnext.controllers.stock_controller.show_stock_ledger_preview",args:{company:r.doc.company,doctype:r.doc.doctype,docname:r.doc.name},callback:function(t){e.make_dialog("Stock Ledger Preview","stock_ledger_preview_html",t.message.sl_columns,t.message.sl_data)}})},__("Preview"))},make_dialog(r,e,t,a){let i=this,s=new frappe.ui.Dialog({size:"extra-large",title:__(r),fields:[{fieldtype:"HTML",fieldname:e}]});setTimeout(function(){i.get_datatable(t,a,s.get_field(e).wrapper)},200),s.show()},get_datatable(r,e,t){let a={columns:r,data:e,dynamicRowHeight:!0,checkboxColumn:!1,inlineFilters:!0};new frappe.DataTable(t,a)}};frappe.provide("erpnext.accounts");erpnext.accounts.unreconcile_payment={add_unreconcile_btn(r){if(r.doc.docstatus==1){if(r.doc.doctype=="Journal Entry"&&!["Journal Entry","Bank Entry","Cash Entry"].includes(r.doc.voucher_type)||!["Purchase Invoice","Sales Invoice","Journal Entry","Payment Entry"].includes(r.doc.doctype))return;frappe.call({method:"erpnext.accounts.doctype.unreconcile_payment.unreconcile_payment.doc_has_references",args:{doctype:r.doc.doctype,docname:r.doc.name},callback:function(e){e.message&&r.add_custom_button(__("UnReconcile"),function(){erpnext.accounts.unreconcile_payment.build_unreconcile_dialog(r)},__("Actions"))}})}},build_selection_map(r,e){let t=[];return["Sales Invoice","Purchase Invoice"].includes(r.doc.doctype)?t=e.map(function(a){return{company:a.company,voucher_type:a.voucher_type,voucher_no:a.voucher_no,against_voucher_type:r.doc.doctype,against_voucher_no:r.doc.name}}):["Payment Entry","Journal Entry"].includes(r.doc.doctype)&&(t=e.map(function(a){return{company:a.company,voucher_type:r.doc.doctype,voucher_no:r.doc.name,against_voucher_type:a.voucher_type,against_voucher_no:a.voucher_no}})),t},build_unreconcile_dialog(r){if(["Sales Invoice","Purchase Invoice","Payment Entry","Journal Entry"].includes(r.doc.doctype)){let e=[{label:__("Voucher Type"),fieldname:"voucher_type",fieldtype:"Link",options:"DocType",in_list_view:1,read_only:1},{label:__("Voucher No"),fieldname:"voucher_no",fieldtype:"Dynamic Link",options:"voucher_type",in_list_view:1,read_only:1},{label:__("Allocated Amount"),fieldname:"allocated_amount",fieldtype:"Currency",in_list_view:1,read_only:1,options:"account_currency"},{label:__("Currency"),fieldname:"account_currency",fieldtype:"Currency",read_only:1}],t=[{label:__("Allocations"),fieldname:"allocations",fieldtype:"Table",read_only:1,fields:e,cannot_add_rows:!0}];frappe.call({method:"erpnext.accounts.doctype.unreconcile_payment.unreconcile_payment.get_linked_payments_for_doc",args:{company:r.doc.company,doctype:r.doc.doctype,docname:r.doc.name},callback:function(a){if(a.message){t[0].data=a.message,t[0].get_data=function(){return a.message};let i=new frappe.ui.Dialog({title:"UnReconcile Allocations",fields:t,size:"large",primary_action_label:"UnReconcile",primary_action(s){let n=s.allocations.filter(o=>o.__checked);if(n.length>0){let o=erpnext.accounts.unreconcile_payment.build_selection_map(r,n);erpnext.accounts.unreconcile_payment.create_unreconcile_docs(o),i.hide()}else frappe.msgprint("No Selection")}});i.show()}}})}},create_unreconcile_docs(r){frappe.call({method:"erpnext.accounts.doctype.unreconcile_payment.unreconcile_payment.create_unreconcile_doc_for_selection",args:{selections:r}})}};erpnext.utils.BarcodeScanner=class{constructor(e){this.frm=e.frm,this.scan_field_name=e.scan_field_name||"scan_barcode",this.scan_barcode_field=this.frm.fields_dict[this.scan_field_name],this.barcode_field=e.barcode_field||"barcode",this.serial_no_field=e.serial_no_field||"serial_no",this.batch_no_field=e.batch_no_field||"batch_no",this.uom_field=e.uom_field||"uom",this.qty_field=e.qty_field||"qty",this.max_qty_field=e.max_qty_field,this.dont_allow_new_row=e.dont_allow_new_row,this.prompt_qty=e.prompt_qty,this.items_table_name=e.items_table_name||"items",this.items_table=this.frm.doc[this.items_table_name],this.success_sound=e.play_success_sound,this.fail_sound=e.play_fail_sound,this.scan_api=e.scan_api||"erpnext.stock.utils.scan_barcode"}process_scan(){return new Promise((e,t)=>{let a=this,i=this.scan_barcode_field.value;this.scan_barcode_field.set_value(""),i&&this.scan_api_call(i,s=>{let n=s&&s.message;if(!n||Object.keys(n).length===0){this.show_alert(__("Cannot find Item with this Barcode"),"red"),this.clean_up(),this.play_fail_sound(),t();return}a.update_table(n).then(o=>{this.play_success_sound(),e(o)}).catch(()=>{this.play_fail_sound(),t()})})})}scan_api_call(e,t){frappe.call({method:this.scan_api,args:{search_value:e}}).then(a=>{t(a)})}update_table(e){return new Promise((t,a)=>{let i=this.frm.fields_dict[this.items_table_name].grid;frappe.flags.trigger_from_barcode_scanner=!0;let{item_code:s,barcode:n,batch_no:o,serial_no:l,uom:c}=e,d=this.get_row_to_modify_on_scan(s,o,c,n);if(this.is_new_row=!1,!d){if(this.dont_allow_new_row){this.show_alert(__("Maximum quantity scanned for item {0}.",[s]),"red"),this.clean_up(),a();return}this.is_new_row=!0,d=frappe.model.add_child(this.frm.doc,i.doctype,this.items_table_name),this.frm.script_manager.trigger(`${this.items_table_name}_add`,d.doctype,d.name),this.frm.has_items=!1}if(this.is_duplicate_serial_no(d,l)){this.clean_up(),a();return}frappe.run_serially([()=>this.set_selector_trigger_flag(e),()=>this.set_item(d,s,n,o,l).then(p=>{this.show_scan_message(d.idx,d.item_code,p)}),()=>this.set_barcode_uom(d,c),()=>this.set_serial_no(d,l),()=>this.set_batch_no(d,o),()=>this.set_barcode(d,n),()=>this.clean_up(),()=>this.revert_selector_flag(),()=>t(d)])})}set_selector_trigger_flag(e){let{batch_no:t,serial_no:a,has_batch_no:i,has_serial_no:s}=e;i&&!t||s&&!a||(frappe.flags.hide_serial_batch_dialog=!0)}revert_selector_flag(){frappe.flags.hide_serial_batch_dialog=!1,frappe.flags.trigger_from_barcode_scanner=!1}set_item(e,t,a,i,s){return new Promise(n=>{let o=async(l=1)=>{let c={item_code:t,use_serial_batch_fields:1};return frappe.flags.trigger_from_barcode_scanner=!0,c[this.qty_field]=Number(e[this.qty_field]||0)+Number(l),await frappe.model.set_value(e.doctype,e.name,c),l};this.prompt_qty?frappe.prompt(__("Please enter quantity for item {0}",[t]),({value:l})=>{o(l).then(c=>n(c))}):this.frm.has_items?this.prepare_item_for_scan(e,t,a,i,s):o().then(l=>n(l))})}prepare_item_for_scan(e,t,a,i,s){var n=this;this.dialog=new frappe.ui.Dialog({title:__("Scan barcode for item {0}",[t]),fields:n.get_fields_for_dialog(e,t,a,i,s)}),this.dialog.set_primary_action(__("Update"),()=>{let o={item_code:t};o[this.qty_field]=this.dialog.get_value("scanned_qty"),o.has_item_scanned=1,this.remaining_qty=flt(this.dialog.get_value("qty"))-flt(this.dialog.get_value("scanned_qty")),frappe.model.set_value(e.doctype,e.name,o),frappe.run_serially([()=>this.set_batch_no(e,this.dialog.get_value("batch_no")),()=>this.set_barcode(e,this.dialog.get_value("barcode")),()=>this.set_serial_no(e,this.dialog.get_value("serial_no")),()=>this.add_child_for_remaining_qty(e),()=>this.clean_up()]),this.dialog.hide()}),this.dialog.show(),this.$scan_btn=this.dialog.$wrapper.find(".link-btn"),this.$scan_btn.css("display","inline")}get_fields_for_dialog(e,t,a,i,s){let n=[{fieldtype:"Data",fieldname:"barcode_scanner",options:"Barcode",label:__("Scan Barcode"),onchange:o=>{!o||o.target.value&&this.scan_api_call(o.target.value,l=>{l.message&&this.update_dialog_values(t,l)})}},{fieldtype:"Section Break"},{fieldtype:"Float",fieldname:"qty",label:__("Quantity to Scan"),default:e[this.qty_field]||1},{fieldtype:"Column Break",fieldname:"column_break_1"},{fieldtype:"Float",read_only:1,fieldname:"scanned_qty",label:__("Scanned Quantity"),default:1},{fieldtype:"Section Break"}];return i&&n.push({fieldtype:"Link",fieldname:"batch_no",options:"Batch No",label:__("Batch No"),default:i,read_only:1,hidden:1}),s&&n.push({fieldtype:"Small Text",fieldname:"serial_no",label:__("Serial Nos"),default:s,read_only:1}),a&&n.push({fieldtype:"Data",fieldname:"barcode",options:"Barcode",label:__("Barcode"),default:a,read_only:1,hidden:1}),n}update_dialog_values(e,t){let{item_code:a,barcode:i,batch_no:s,serial_no:n}=t.message;if(this.dialog.set_value("barcode_scanner",""),a===e&&(this.dialog.get_value("barcode")===i||s||n)){if(s&&this.dialog.set_value("batch_no",s),n){this.validate_duplicate_serial_no(n);let l=this.dialog.get_value("serial_no")+`
`+n;this.dialog.set_value("serial_no",l)}let o=flt(this.dialog.get_value("scanned_qty"))+1;this.dialog.set_value("scanned_qty",o)}}validate_duplicate_serial_no(e){let t=this.dialog.get_value("serial_no")?this.dialog.get_value("serial_no").split(`
`):[];in_list(t,e)&&frappe.throw(__("Serial No {0} already scanned",[e]))}add_child_for_remaining_qty(e){if(this.remaining_qty&&this.remaining_qty>0){let t=this.frm.fields_dict[this.items_table_name].grid,a=frappe.model.add_child(this.frm.doc,t.doctype,this.items_table_name),i=["name","idx","batch_no","barcode","received_qty","serial_no","has_item_scanned"];for(let s in e)in_list(i,s)||(a[s]=e[s]);a[this.qty_field]=this.remaining_qty,this.qty_field=="qty"&&frappe.meta.has_field(a.doctype,"stock_qty")&&(a.stock_qty=this.remaining_qty*a.conversion_factor),this.frm.script_manager.trigger("item_code",a.doctype,a.name)}}async set_serial_no(e,t){if(t&&frappe.meta.has_field(e.doctype,this.serial_no_field)){let a=e[this.serial_no_field],i="";a?i=a+`
`+t:i=t,await frappe.model.set_value(e.doctype,e.name,this.serial_no_field,i)}}async set_barcode_uom(e,t){t&&frappe.meta.has_field(e.doctype,this.uom_field)&&await frappe.model.set_value(e.doctype,e.name,this.uom_field,t)}async set_batch_no(e,t){t&&frappe.meta.has_field(e.doctype,this.batch_no_field)&&await frappe.model.set_value(e.doctype,e.name,this.batch_no_field,t)}async set_barcode(e,t){t&&frappe.meta.has_field(e.doctype,this.barcode_field)&&await frappe.model.set_value(e.doctype,e.name,this.barcode_field,t)}show_scan_message(e,t=null,a=1){t?this.show_alert(__("Row #{0}: Qty increased by {1}",[e,a]),"green"):this.show_alert(__("Row #{0}: Item added",[e]),"green")}is_duplicate_serial_no(e,t){var i;let a=(i=e[this.serial_no_field])==null?void 0:i.includes(t);return a&&this.show_alert(__("Serial No {0} is already added",[t]),"orange"),a}get_row_to_modify_on_scan(e,t,a,i){let s=this.frm.fields_dict[this.items_table_name].grid,n=t&&frappe.meta.has_field(s.doctype,this.batch_no_field),o=this.max_qty_field&&frappe.meta.has_field(s.doctype,this.max_qty_field),l=c=>{let d=c.item_code==e,p=!c[this.batch_no_field]||c[this.batch_no_field]==t,u=!a||c[this.uom_field]==a,x=flt(c[this.qty_field])<flt(c[this.max_qty_field]),w=c.has_item_scanned;return d&&u&&!w&&(!n||p)&&(!o||x)};return this.items_table.find(l)||this.get_existing_blank_row()}get_existing_blank_row(){return this.items_table.find(e=>!e.item_code)}play_success_sound(){this.success_sound&&frappe.utils.play_sound(this.success_sound)}play_fail_sound(){this.fail_sound&&frappe.utils.play_sound(this.fail_sound)}clean_up(){this.scan_barcode_field.set_value(""),refresh_field(this.items_table_name)}show_alert(e,t,a=3){frappe.show_alert({message:e,indicator:t},a)}};frappe.ui.form.ControlData=class extends frappe.ui.form.ControlData{make_input(){super.make_input(),this.df.options=="Phone"&&this.setup_phone(),this.frm&&this.frm.fields_dict&&Object.values(this.frm.fields_dict).forEach(function(e){e.df.read_only===1&&e.df.options==="Phone"&&e.disp_area.style[0]!="display"&&!e.has_icon&&(e.setup_phone&&e.setup_phone(),e.has_icon=!0)})}setup_phone(){if(frappe.phone_call.handler){let e=this.df.read_only?".control-value":".control-input";this.$wrapper.find(e).append(`
					<span class="phone-btn">
						<a class="btn-open no-decoration" title="${__("Make a call")}">
							${frappe.utils.icon("call")}
					</span>
				`).find(".phone-btn").click(()=>{frappe.phone_call.handler(this.get_value(),this.frm)})}}};frappe.templates.call_link=`<div class="call-detail-wrapper">
	<div class="head flex justify-between">
		<div>
			<span class="bold"> {{ type }} Call</span>
			{% if (duration) %}
			<span class="text-muted"> \u2022 {{ frappe.format(duration, { fieldtype: "Duration" }) }}</span>
			{% endif %}
			<span class="text-muted"> \u2022 {{ comment_when(creation) }}</span>
		</div>
		<span>
			<a class="action-btn" href="/app/call-log/{{ name }}" title="{{ __("Open Call Log") }}">
				<svg class="icon icon-sm">
					<use href="#icon-link-url" class="like-icon"></use>
				</svg>
			</a>
		</span>
	</div>


	<div class="body pt-3">
		{% if (type === "Incoming") { %}
			<span> Incoming call from {{ from }}, received by {{ to }}</span>
		{% } else { %}
			<span> Outgoing Call made by {{ from }} to {{ to }}</span>
		{% } %}
		<div class="summary pt-3">
		{% if (summary) { %}
			<i>{{ summary }}</i>
		{% } else { %}
			<i class="text-muted">{{ __("No Summary") }}</i>
		{% } %}
		</div>
		{% if (recording_url) { %}
		<div class="margin-top">
				<audio
					controls
					src="{{ recording_url }}">
				</audio>
		</div>
		{% } %}
	</div>
</div>
`;frappe.provide("erpnext.bulk_transaction_processing");$.extend(erpnext.bulk_transaction_processing,{create:function(r,e,t){let a=r.get_checked_items(),i=[];a.forEach(n=>{n.docstatus==0&&i.push(n.name)});let s=a.length;frappe.confirm(__("Create {0} {1} ?",[s,__(t)]),()=>{i.length==0?(frappe.call({method:"erpnext.utilities.bulk_transaction.transaction_processing",args:{data:a,from_doctype:e,to_doctype:t}}).then(()=>{}),s>10&&frappe.show_alert("Starting a background job to create {0} {1}",[s,__(t)])):frappe.msgprint(__("Selected document must be in submitted state"))})}});erpnext.utils.CRMActivities=class{constructor(e){$.extend(this,e)}refresh(){var e=this;$(this.open_activities_wrapper).empty();let t=this.form_wrapper.find(".form-footer");$(this.all_activities_wrapper).find(".form-footer").length||(this.all_activities_wrapper.empty(),$(t).appendTo(this.all_activities_wrapper),$(this.all_activities_wrapper).removeClass("frappe-control"),$(".timeline-actions").find(".btn-default").hide(),$(".comment-box").hide(),$($(".timeline-content").find(".nav-link")[0]).tab("show")),frappe.call({method:"erpnext.crm.utils.get_open_activities",args:{ref_doctype:this.frm.doc.doctype,ref_docname:this.frm.doc.name},callback:a=>{if(!a.exc){var i=frappe.render_template("crm_activities",{tasks:a.message.tasks,events:a.message.events});$(i).appendTo(e.open_activities_wrapper),$(".open-tasks").find(".completion-checkbox").on("click",function(){e.update_status(this,"ToDo")}),$(".open-events").find(".completion-checkbox").on("click",function(){e.update_status(this,"Event")}),e.create_task(),e.create_event()}}})}create_task(){let e=this,t=()=>{let a={doc:e.frm.doc,frm:e.frm,title:__("New Task")},i=new frappe.views.InteractionComposer(a);i.dialog.get_field("interaction_type").set_value("ToDo"),$(i.dialog.get_field("interaction_type").wrapper).closest(".form-column").hide(),$(i.dialog.get_field("summary").wrapper).closest(".form-section").hide()};$(".new-task-btn").click(t)}create_event(){let e=this,t=()=>{let a={doc:e.frm.doc,frm:e.frm,title:__("New Event")},i=new frappe.views.InteractionComposer(a);i.dialog.get_field("interaction_type").set_value("Event"),$(i.dialog.get_field("interaction_type").wrapper).hide()};$(".new-event-btn").click(t)}async update_status(e,t){let a=$(e).prop("checked")?1:0,i=$(e).attr("name");a&&(await frappe.db.set_value(t,i,"status","Closed"),this.refresh())}};erpnext.utils.CRMNotes=class{constructor(e){$.extend(this,e)}refresh(){var e=this;this.notes_wrapper.find(".notes-section").remove();let t=this.frm.doc.notes||[];t.sort(function(i,s){return new Date(s.added_on)-new Date(i.added_on)});let a=frappe.render_template("crm_notes",{notes:t});$(a).appendTo(this.notes_wrapper),this.add_note(),$(".notes-section").find(".edit-note-btn").on("click",function(){e.edit_note(this)}),$(".notes-section").find(".delete-note-btn").on("click",function(){e.delete_note(this)})}add_note(){let e=this,t=()=>{var a=new frappe.ui.Dialog({title:__("Add a Note"),fields:[{label:"Note",fieldname:"note",fieldtype:"Text Editor",reqd:1,enable_mentions:!0}],primary_action:function(){var i=a.get_values();frappe.call({method:"add_note",doc:e.frm.doc,args:{note:i.note},freeze:!0,callback:function(s){s.exc||(e.frm.refresh_field("notes"),e.refresh()),a.hide()}})},primary_action_label:__("Add")});a.show()};$(".new-note-btn").click(t)}edit_note(e){var t=this;let a=$(e).closest(".comment-content"),i=a.attr("name"),s=$(a).find(".content").html();if(s){var n=new frappe.ui.Dialog({title:__("Edit Note"),fields:[{label:"Note",fieldname:"note",fieldtype:"Text Editor",default:s}],primary_action:function(){var o=n.get_values();frappe.call({method:"edit_note",doc:t.frm.doc,args:{note:o.note,row_id:i},freeze:!0,callback:function(l){l.exc||(t.frm.refresh_field("notes"),t.refresh(),n.hide())}})},primary_action_label:__("Done")});n.show()}}delete_note(e){var t=this;let a=$(e).closest(".comment-content").attr("name");frappe.call({method:"delete_note",doc:t.frm.doc,args:{row_id:a},freeze:!0,callback:function(i){i.exc||(t.frm.refresh_field("notes"),t.refresh())}})}};frappe.templates.crm_activities=`<div class="open-activities">
	<div class="new-btn pb-3">
		<span>
			<button class="btn btn-sm small new-task-btn mr-1">
				<svg class="icon icon-sm">
					<use href="#icon-small-message"></use>
				</svg>
				{{ __("New Task") }}
			</button>
			<button class="btn btn-sm small new-event-btn">
				<svg class="icon icon-sm">
					<use href="#icon-calendar"></use>
				</svg>
				{{ __("New Event") }}
			</button>
		</span>
	</div>
	<div class="section-body">
		<div class="open-tasks pr-1">
			<div class="open-section-head">
				<span class="ml-2">{{ __("Open Tasks") }}</span>
			</div>
			{% if (tasks.length) { %}
				{% for(var i=0, l=tasks.length; i<l; i++) { %}
					<div class="single-activity">
						<div class="flex justify-between mb-2">
							<div class="row label-area font-md ml-1">
								<span class="mr-2">
									<svg class="icon icon-sm">
										<use href="#icon-small-message"></use>
									</svg>
								</span>
								<a href="/app/todo/{{ tasks[i].name }}" title="{{ __('Open Task') }}">
									{%= tasks[i].description %}
								</a>
							</div>
							<div class="checkbox">
								<input type="checkbox" class="completion-checkbox"
									name="{{tasks[i].name}}" title="{{ __('Mark As Closed') }}">
							</div>
						</div>
						{% if(tasks[i].date) { %}
							<div class="text-muted ml-1">
								{%= frappe.datetime.global_date_format(tasks[i].date) %}
							</div>
						{% } %}
						{% if(tasks[i].allocated_to) { %}
							<div class="text-muted  ml-1">
								{{ __("Allocated To:") }}
								{%= tasks[i].allocated_to %}
							</div>
						{% } %}
						</div>
			    {% } %}
            {% } else { %}
                <div class="single-activity no-activity text-muted">
                    {{ __("No open task") }}
                </div>
		    {% } %}
		</div>
		<div class="open-events pl-1">
			<div class="open-section-head">
				<span class="ml-2">{{ __("Open Events") }}</span>
			</div>
			{% if (events.length) { %}
                {% let icon_set = {"Sent/Received Email": "mail", "Call": "call", "Meeting": "share-people"}; %}
                {% for(var i=0, l=events.length; i<l; i++) { %}
                    <div class="single-activity">
                        <div class="flex justify-between mb-2">
                            <div class="row label-area font-md ml-1 title">
                                <span class="mr-2">
                                    <svg class="icon icon-sm">
                                        <use href="#icon-{{ icon_set[events[i].event_category] || 'calendar' }}"></use>
                                    </svg>
                                </span>
                                <a href="/app/event/{{ events[i].name }}" title="{{ __('Open Event') }}">
                                    {%= events[i].subject %}
                                </a>
                            </div>
                            <div class="checkbox">
                                <input type="checkbox" class="completion-checkbox"
                                    name="{{ events[i].name }}" title="{{ __('Mark As Closed') }}">
                            </div>
                        </div>
                        <div class="text-muted ml-1">
                            {%= frappe.datetime.global_date_format(events[i].starts_on) %}

                            {% if (events[i].ends_on) { %}
                                {% if (frappe.datetime.obj_to_user(events[i].starts_on) != frappe.datetime.obj_to_user(events[i].ends_on)) %}
                                    -
                                    {%= frappe.datetime.global_date_format(frappe.datetime.obj_to_user(events[i].ends_on)) %}
                                    {%= frappe.datetime.get_time(events[i].ends_on) %}
                                {% } else if (events[i].ends_on) { %}
                                    -
                                    {%= frappe.datetime.get_time(events[i].ends_on) %}
                                {% } %}
                            {% } %}

                        </div>
                    </div>
                {% } %}
            {% } else { %}
            <div class="single-activity no-activity text-muted">
                {{ __("No open event") }}
            </div>
		    {% } %}
		</div>
	</div>
</div>


<style>
.open-activities {
	min-height: 50px;
	padding-left: 0px;
	padding-bottom: 15px !important;
}

.open-activities .new-btn {
	text-align: right;
}

.single-activity {
	min-height: 90px;
	border: 1px solid var(--border-color);
	padding: 10px;
	border-bottom: 0;
	padding-right: 0;
}

.single-activity:last-child {
	border-bottom: 1px solid var(--border-color);
}

.single-activity:hover .completion-checkbox{
	display: block;
}

.completion-checkbox {
	vertical-align: middle;
	display: none;
}

.checkbox {
	min-width: 22px;
}

.open-tasks {
	width: 50%;
}

.open-tasks:first-child {
	border-right: 0;
}

.open-events {
	width: 50%;
}

.open-section-head {
	background-color: var(--bg-color);
	min-height: 30px;
	border-bottom: 1px solid var(--border-color);
	padding: 10px;
	font-weight: bold;
}

.no-activity {
    text-align: center;
    padding-top: 30px;
}

.form-footer {
	background-color: var(--bg-color);
}
</style>`;frappe.templates.crm_notes=`<div class="notes-section col-xs-12">
	<div class="new-btn pb-3">
		<button class="btn btn-sm small new-note-btn mr-1">
			<svg class="icon icon-sm">
				<use href="#icon-add"></use>
			</svg>
			{{ __("New Note") }}
		</button>
	</div>
	<div class="all-notes">
		{% if (notes.length) { %}
			{% for(var i=0, l=notes.length; i<l; i++) { %}
				<div class="comment-content p-3 row" name="{{ notes[i].name }}">
					<div class="mb-2 head col-xs-3">
						{% if (notes[i].added_by && notes[i].added_on) %}
						<div class="row">
							<div class="col-xs-2">
								{{ frappe.avatar(notes[i].added_by) }}
							</div>
							<div class="col-xs-10">
								<div class="mr-2 title font-weight-bold ellipsis" title="{{ strip_html(notes[i].added_by) }}">
									{{ strip_html(notes[i].added_by) }}
								</div>
								<div class="time small text-muted">
									{{ frappe.datetime.global_date_format(notes[i].added_on) }}
								</div>
							</div>
						</div>
						{% } %}
					</div>
					<div class="content col-xs-8">
						{{ notes[i].note }}
					</div>
					<div class="col-xs-1 text-right">
						<span class="edit-note-btn btn btn-link">
							<svg class="icon icon-sm"><use xlink:href="#icon-edit"></use></svg>
						</span>
						<span class="delete-note-btn  btn btn-link pl-2">
							<svg class="icon icon-xs"><use xlink:href="#icon-delete"></use></svg>
						</span>
					</div>
				</div>
			{% } %}
		{% } else { %}
            <div class="no-activity text-muted pt-6">
                {{ __("No Notes") }}
            </div>
		    {% } %}
	</div>
</div>

<style>

.comment-content {
    border: 1px solid var(--border-color);
	border-bottom: none;
}

.comment-content:last-child {
    border-bottom: 1px solid var(--border-color);
}

.new-btn {
	text-align: right;
}

.notes-section .no-activity {
	min-height: 100px;
	text-align: center;
}

.notes-section .btn {
	padding: 0.2rem 0.2rem;
}

</style>`;frappe.provide("erpnext.taxes");erpnext.accounts.taxes={setup_tax_validations:function(r){let e=this;frappe.ui.form.on(r,{setup:function(t){$(t.wrapper).on("grid-row-render",function(a,i){["Sales Taxes and Charges","Purchase Taxes and Charges"].includes(i.doc.doctype)&&e.set_conditional_mandatory_rate_or_amount(i)})},onload:function(t){t.get_field("taxes")&&(t.set_query("account_head","taxes",function(a){if(t.cscript.tax_table=="Sales Taxes and Charges")var i=["Tax","Chargeable","Expense Account"];else var i=["Tax","Chargeable","Income Account","Expenses Included In Valuation"];return{query:"erpnext.controllers.queries.tax_account_query",filters:{account_type:i,company:a.company}}}),t.set_query("cost_center","taxes",function(a){return{filters:{company:a.company,is_group:0}}}))},validate:function(t){t.get_docfield("taxes")&&(t.get_docfield("taxes","rate").reqd=0,t.get_docfield("taxes","tax_amount").reqd=0)},taxes_on_form_rendered:function(t){e.set_conditional_mandatory_rate_or_amount(t.open_grid_row())}})},set_conditional_mandatory_rate_or_amount:function(r){r&&(r.doc.charge_type==="Actual"?(r.toggle_editable("tax_amount",!0),r.toggle_reqd("tax_amount",!0),r.toggle_editable("rate",!1),r.toggle_reqd("rate",!1)):(r.toggle_editable("rate",!0),r.toggle_reqd("rate",!0),r.toggle_editable("tax_amount",!1),r.toggle_reqd("tax_amount",!1)))},validate_taxes_and_charges:function(r,e){let t=locals[r][e],a="";t.account_head&&!t.description&&(t.description=t.account_head.split(" - ").slice(0,-1).join(" - ")),!t.charge_type&&(t.row_id||t.rate||t.tax_amount)?(a=__("Please select Charge Type first"),t.row_id="",t.rate=t.tax_amount=0):(t.charge_type=="Actual"||t.charge_type=="On Net Total"||t.charge_type=="On Paid Amount")&&t.row_id?(a=__("Can refer row only if the charge type is 'On Previous Row Amount' or 'Previous Row Total'"),t.row_id=""):(t.charge_type=="On Previous Row Amount"||t.charge_type=="On Previous Row Total")&&t.row_id&&(t.idx==1?(a=__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row"),t.charge_type=""):t.row_id?t.row_id&&t.row_id>=t.idx&&(a=__("Cannot refer row number greater than or equal to current row number for this Charge type"),t.row_id=""):(a=__("Please specify a valid Row ID for row {0} in table {1}",[t.idx,__(t.doctype)]),t.row_id="")),a&&(frappe.validated=!1,refresh_field("taxes"),frappe.throw(a))},setup_tax_filters:function(r){let e=this;frappe.ui.form.on(r,{account_head:function(t,a,i){let s=locals[a][i];s.docstatus!=1&&(!s.charge_type&&s.account_head?(frappe.msgprint(__("Please select Charge Type first")),frappe.model.set_value(a,i,"account_head","")):s.account_head&&frappe.call({type:"GET",method:"erpnext.controllers.accounts_controller.get_tax_rate",args:{account_head:s.account_head},callback:function(n){s.charge_type!=="Actual"&&frappe.model.set_value(a,i,"rate",n.message.tax_rate||0),frappe.model.set_value(a,i,"description",n.message.account_name)}}))},row_id:function(t,a,i){e.validate_taxes_and_charges(a,i)},rate:function(t,a,i){e.validate_taxes_and_charges(a,i)},tax_amount:function(t,a,i){e.validate_taxes_and_charges(a,i)},charge_type:function(t,a,i){e.validate_taxes_and_charges(a,i);let s=t.open_grid_row();s?e.set_conditional_mandatory_rate_or_amount(s):e.set_conditional_mandatory_rate_or_amount(t.get_field("taxes").grid.get_row(i))},included_in_print_rate:function(t,a,i){let s=frappe.get_doc(a,i);try{e.validate_taxes_and_charges(a,i),e.validate_inclusive_tax(s,t)}catch(n){throw s.included_in_print_rate=0,refresh_field("included_in_print_rate",s.name,s.parentfield),n}}})},validate_inclusive_tax:function(r,e){this.frm=this.frm||e;let t=function(){var s=__("Actual type tax cannot be included in Item rate in row {0}",[r.idx]);frappe.throw(s)},a=function(s){var n=__("For row {0} in {1}. To include {2} in Item rate, rows {3} must also be included",[r.idx,__(r.doctype),r.charge_type,s]);frappe.throw(n)};if(cint(r.included_in_print_rate))if(r.charge_type=="Actual")t();else if(r.charge_type=="On Previous Row Amount"&&this.frm&&!cint(this.frm.doc.taxes[r.row_id-1].included_in_print_rate))a(r.row_id);else if(r.charge_type=="On Previous Row Total"&&this.frm){var i=$.map(this.frm.doc.taxes.slice(0,r.row_id),function(s){return cint(s.included_in_print_rate)?null:s});i.length>0&&a(r.row_id==1?"1":"1 - "+r.row_id)}else r.category=="Valuation"&&frappe.throw(__("Valuation type charges can not marked as Inclusive"))}};erpnext.accounts.payment_triggers={setup:function(r){frappe.ui.form.on(r,{allocate_advances_automatically(e){e.trigger("fetch_advances")},only_include_allocated_payments(e){e.trigger("fetch_advances")},fetch_advances(e){e.doc.allocate_advances_automatically&&frappe.call({doc:e.doc,method:"set_advances",callback:function(t,a){refresh_field("advances")}})}})}};erpnext.accounts.pos={setup:function(r){frappe.ui.form.on(r,{mode_of_payment:function(e,t,a){var i=locals[t][a];get_payment_mode_account(e,i.mode_of_payment,function(s){frappe.model.set_value(t,a,"account",s)})}})},get_payment_mode_account:function(r,e,t){if(r.doc.company||frappe.throw({message:__("Please select a Company first."),title:__("Mandatory")}),!!e)return frappe.call({method:"erpnext.accounts.doctype.sales_invoice.sales_invoice.get_bank_cash_account",args:{mode_of_payment:e,company:r.doc.company},callback:function(a,i){a.message&&t(a.message.account)}})}};erpnext.landed_cost_taxes_and_charges={setup_triggers:function(r){frappe.ui.form.on(r,{refresh:function(e){let t=e.doc.doctype=="Landed Cost Voucher"?"taxes":"additional_costs";e.set_query("expense_account",t,function(){return{filters:{account_type:["in",["Tax","Chargeable","Income Account","Expenses Included In Valuation","Expenses Included In Asset Valuation"]],company:e.doc.company}}})},set_account_currency:function(e,t,a){let i=locals[t][a];i.expense_account&&frappe.db.get_value("Account",i.expense_account,"account_currency",function(s){frappe.model.set_value(t,a,"account_currency",s.account_currency),e.events.set_exchange_rate(e,t,a)})},set_exchange_rate:function(e,t,a){let i=locals[t][a],s=frappe.get_doc(":Company",e.doc.company).default_currency;i.account_currency==s?(i.exchange_rate=1,e.set_df_property("taxes","hidden",1,i.name,"exchange_rate")):(!i.exchange_rate||i.exchange_rate==1)&&(e.set_df_property("taxes","hidden",0,i.name,"exchange_rate"),frappe.call({method:"erpnext.accounts.doctype.journal_entry.journal_entry.get_exchange_rate",args:{posting_date:e.doc.posting_date,account:i.expense_account,account_currency:i.account_currency,company:e.doc.company},callback:function(n){n.message&&frappe.model.set_value(t,a,"exchange_rate",n.message)}})),e.refresh_field("taxes")},set_base_amount:function(e,t,a){let i=locals[t][a];frappe.model.set_value(t,a,"base_amount",flt(flt(i.amount)*i.exchange_rate,precision("base_amount",i)))}})}};frappe.provide("erpnext.selling");erpnext.sales_common={setup_selling_controller:function(){erpnext.selling.SellingController=class extends erpnext.TransactionController{setup(){super.setup(),this.toggle_enable_for_stock_uom("allow_to_edit_stock_uom_qty_for_sales"),this.frm.email_field="contact_email"}onload(){super.onload(),this.setup_queries(),this.frm.set_query("shipping_rule",function(e){return{filters:{shipping_rule_type:"Selling",company:e.company}}}),this.frm.set_query("project",function(e){return{query:"erpnext.controllers.queries.get_project_name",filters:{customer:e.customer,company:e.company}}})}setup_queries(){var e=this;$.each([["customer","customer"],["lead","lead"]],function(t,a){e.frm.fields_dict[a[0]]&&e.frm.set_query(a[0],erpnext.queries[a[1]])}),e.frm.set_query("contact_person",erpnext.queries.contact_query),e.frm.set_query("customer_address",erpnext.queries.address_query),e.frm.set_query("shipping_address_name",erpnext.queries.address_query),e.frm.set_query("dispatch_address_name",erpnext.queries.dispatch_address_query),e.frm.set_query("company_address",erpnext.queries.company_address_query),erpnext.accounts.dimensions.setup_dimension_filters(e.frm,e.frm.doctype),this.frm.fields_dict.selling_price_list&&this.frm.set_query("selling_price_list",function(){return{filters:{selling:1}}}),this.frm.fields_dict.tc_name&&this.frm.set_query("tc_name",function(){return{filters:{selling:1}}}),this.frm.fields_dict.items&&(this.frm.fields_dict.items.grid.get_field("item_code")&&this.frm.set_query("item_code","items",function(){return{query:"erpnext.controllers.queries.item_query",filters:{is_sales_item:1,customer:e.frm.doc.customer,has_variants:0}}}),this.frm.fields_dict.packed_items&&this.frm.fields_dict.packed_items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","packed_items",function(t,a,i){return e.set_query_for_batch(t,a,i)}),this.frm.fields_dict.items.grid.get_field("item_code")&&this.frm.set_query("item_tax_template","items",function(t,a,i){return e.set_query_for_item_tax_template(t,a,i)}))}refresh(){super.refresh(),frappe.dynamic_link={doc:this.frm.doc,fieldname:"customer",doctype:"Customer"},this.frm.toggle_display("customer_name",this.frm.doc.customer_name&&this.frm.doc.customer_name!==this.frm.doc.customer),this.toggle_editable_price_list_rate()}customer(){var e=this;erpnext.utils.get_party_details(this.frm,null,null,function(){e.apply_price_list()})}customer_address(){erpnext.utils.get_address_display(this.frm,"customer_address"),erpnext.utils.set_taxes_from_address(this.frm,"customer_address","customer_address","shipping_address_name")}shipping_address_name(){erpnext.utils.get_address_display(this.frm,"shipping_address_name","shipping_address"),erpnext.utils.set_taxes_from_address(this.frm,"shipping_address_name","customer_address","shipping_address_name")}dispatch_address_name(){erpnext.utils.get_address_display(this.frm,"dispatch_address_name","dispatch_address")}sales_partner(){this.apply_pricing_rule()}campaign(){this.apply_pricing_rule()}selling_price_list(){this.apply_price_list(),this.set_dynamic_labels()}discount_percentage(e,t,a){var i=frappe.get_doc(t,a);i.discount_amount=0,this.apply_discount_on_item(e,t,a,"discount_percentage")}discount_amount(e,t,a){if(e.name!==a){var i=frappe.get_doc(t,a);i.discount_percentage=0,this.apply_discount_on_item(e,t,a,"discount_amount")}}commission_rate(){this.calculate_commission()}total_commission(){frappe.model.round_floats_in(this.frm.doc,["amount_eligible_for_commission","total_commission"]);let{amount_eligible_for_commission:e}=this.frm.doc;!e||this.frm.set_value("commission_rate",flt(this.frm.doc.total_commission*100/e))}allocated_percentage(e,t,a){var i=frappe.get_doc(t,a);i.allocated_percentage&&(i.allocated_percentage=flt(i.allocated_percentage,precision("allocated_percentage",i)),i.allocated_amount=flt(this.frm.doc.amount_eligible_for_commission*i.allocated_percentage/100,precision("allocated_amount",i)),refresh_field(["allocated_amount"],i),this.calculate_incentive(i),refresh_field(["allocated_percentage","allocated_amount","commission_rate","incentives"],i.name,i.parentfield))}sales_person(e,t,a){var i=frappe.get_doc(t,a);this.calculate_incentive(i),refresh_field("incentives",i.name,i.parentfield)}warehouse(e,t,a){e.docstatus===0&&e.is_return&&!e.return_against&&frappe.model.set_value(t,a,"incoming_rate",0),this.set_actual_qty(e,t,a)}set_actual_qty(e,t,a){let i=locals[t][a],s=["Sales Invoice","Delivery Note","Sales Order"];i.item_code&&i.warehouse&&s.includes(e.doctype)&&frappe.call({method:"erpnext.stock.get_item_details.get_bin_details",args:{item_code:i.item_code,warehouse:i.warehouse},callback(n){n.message&&frappe.model.set_value(t,a,"actual_qty",n.message.actual_qty)}})}toggle_editable_price_list_rate(){var e=frappe.meta.get_docfield(this.frm.doc.doctype+" Item","price_list_rate",this.frm.doc.name),t=cint(frappe.defaults.get_default("editable_price_list_rate"));if(e&&t){let a=frappe.meta.get_parentfield(this.frm.doc.doctype,this.frm.doc.doctype+" Item");if(!this.frm.fields_dict[a])return;this.frm.fields_dict[a].grid.update_docfield_property("price_list_rate","read_only",0)}}calculate_commission(){!this.frm.fields_dict.commission_rate||this.frm.doc.docstatus===1||(this.frm.doc.commission_rate>100&&(this.frm.set_value("commission_rate",100),frappe.throw(`${__(frappe.meta.get_label(this.frm.doc.doctype,"commission_rate",this.frm.doc.name))} ${__("cannot be greater than 100")}`)),this.frm.doc.amount_eligible_for_commission=this.frm.doc.items.reduce((e,t)=>t.grant_commission?e+t.base_net_amount:e,0),this.frm.doc.total_commission=flt(this.frm.doc.amount_eligible_for_commission*this.frm.doc.commission_rate/100,precision("total_commission")),refresh_field(["amount_eligible_for_commission","total_commission"]))}calculate_contribution(){var e=this;$.each(this.frm.doc.doctype.sales_team||[],function(t,a){frappe.model.round_floats_in(a),a.allocated_percentage&&(a.allocated_amount=flt(e.frm.doc.amount_eligible_for_commission*a.allocated_percentage/100,precision("allocated_amount",a)))})}calculate_incentive(e){e.allocated_amount&&(e.incentives=flt(e.allocated_amount*e.commission_rate/100,precision("incentives",e)))}set_dynamic_labels(){super.set_dynamic_labels(),this.set_product_bundle_help(this.frm.doc)}set_product_bundle_help(e){if(!!this.frm.fields_dict.packing_list){if((e.packed_items||[]).length){if($(this.frm.fields_dict.packing_list.row.wrapper).toggle(!0),["Delivery Note","Sales Invoice"].includes(e.doctype)){var t="<div class='alert alert-warning'>"+__("For 'Product Bundle' items, Warehouse, Serial No and Batch No will be considered from the 'Packing List' table. If Warehouse and Batch No are same for all packing items for any 'Product Bundle' item, those values can be entered in the main Item table, values will be copied to 'Packing List' table.")+"</div>";frappe.meta.get_docfield(e.doctype,"product_bundle_help",e.name).options=t}}else $(this.frm.fields_dict.packing_list.row.wrapper).toggle(!1),["Delivery Note","Sales Invoice"].includes(e.doctype)&&(frappe.meta.get_docfield(e.doctype,"product_bundle_help",e.name).options="");refresh_field("product_bundle_help")}}company_address(){var e=this;this.frm.doc.company_address?frappe.call({method:"frappe.contacts.doctype.address.address.get_address_display",args:{address_dict:this.frm.doc.company_address},callback:function(t){t.message&&e.frm.set_value("company_address_display",t.message)}}):this.frm.set_value("company_address_display","")}conversion_factor(e,t,a,i){super.conversion_factor(e,t,a,i)}qty(e,t,a){super.qty(e,t,a)}pick_serial_and_batch(e,t,a){let i=locals[t][a],s=this;frappe.db.get_value("Item",i.item_code,["has_batch_no","has_serial_no"]).then(n=>{n.message&&(n.message.has_batch_no||n.message.has_serial_no)&&(i.has_serial_no=n.message.has_serial_no,i.has_batch_no=n.message.has_batch_no,i.type_of_transaction=i.qty>0?"Outward":"Inward",i.title=i.has_serial_no?__("Select Serial No"):__("Select Batch No"),i.has_serial_no&&i.has_batch_no&&(i.title=__("Select Serial and Batch")),new erpnext.SerialBatchPackageSelector(s.frm,i,o=>{if(o){let l=Math.abs(o.total_qty);e.is_return&&(l=l*-1),frappe.model.set_value(i.doctype,i.name,{serial_and_batch_bundle:o.name,use_serial_batch_fields:0,incoming_rate:o.avg_rate,qty:l/flt(i.conversion_factor||1,precision("conversion_factor",i))})}}))})}update_auto_repeat_reference(e){e.auto_repeat&&frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.update_reference",args:{docname:e.auto_repeat,reference:e.name},callback:function(t){t.message=="success"?frappe.show_alert({message:__("Auto repeat document updated"),indicator:"green"}):frappe.show_alert({message:__("An error occurred during the update process"),indicator:"red"})}})}project(){let e=this;["Delivery Note","Sales Invoice","Sales Order"].includes(this.frm.doc.doctype)&&this.frm.doc.project&&frappe.call({method:"erpnext.projects.doctype.project.project.get_cost_center_name",args:{project:this.frm.doc.project},callback:function(t,a){t.exc||$.each(e.frm.doc.items||[],function(i,s){t.message&&(frappe.model.set_value(s.doctype,s.name,"cost_center",t.message),frappe.msgprint(__("Cost Center For Item with Item Code {0} has been Changed to {1}",[s.item_name,t.message])))})}})}coupon_code(){this.frm.set_value("discount_amount",0),this.frm.set_value("additional_discount_percentage",0)}}}};erpnext.pre_sales={set_as_lost:function(r){frappe.ui.form.on(r,{set_as_lost_dialog:function(e){var t=new frappe.ui.Dialog({title:__("Set as Lost"),fields:[{fieldtype:"Table MultiSelect",label:__("Lost Reasons"),fieldname:"lost_reason",options:e.doctype==="Opportunity"?"Opportunity Lost Reason Detail":"Quotation Lost Reason Detail",reqd:1},{fieldtype:"Table MultiSelect",label:__("Competitors"),fieldname:"competitors",options:"Competitor Detail"},{fieldtype:"Small Text",label:__("Detailed Reason"),fieldname:"detailed_reason"}],primary_action:function(){let a=t.get_values();e.call({doc:e.doc,method:"declare_enquiry_lost",args:{lost_reasons_list:a.lost_reason,competitors:a.competitors?a.competitors:[],detailed_reason:a.detailed_reason},callback:function(i){t.hide(),e.reload_doc()}})},primary_action_label:__("Declare Lost")});t.show()}})}};frappe.provide("erpnext.buying");erpnext.buying={setup_buying_controller:function(){erpnext.buying.BuyingController=class extends erpnext.TransactionController{setup(){super.setup(),this.toggle_enable_for_stock_uom("allow_to_edit_stock_uom_qty_for_purchase"),this.frm.email_field="contact_email"}onload(e,t,a){if(this.setup_queries(e,t,a),super.onload(),this.frm.set_query("shipping_rule",function(){return{filters:{shipping_rule_type:"Buying"}}}),this.frm.doc.__islocal&&frappe.meta.has_field(this.frm.doc.doctype,"disable_rounded_total")){var i=frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total"),s=cint(i.default)||cint(frappe.sys_defaults.disable_rounded_total);this.frm.set_value("disable_rounded_total",s)}this.frm.get_field("shipping_address")&&this.frm.set_query("shipping_address",()=>this.frm.doc.customer?{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:"Customer",link_name:this.frm.doc.customer}}:erpnext.queries.company_address_query(this.frm.doc))}setup_queries(e,t,a){var i=this;this.frm.fields_dict.buying_price_list&&this.frm.set_query("buying_price_list",function(){return{filters:{buying:1}}}),this.frm.fields_dict.tc_name&&this.frm.set_query("tc_name",function(){return{filters:{buying:1}}}),i.frm.set_query("supplier",erpnext.queries.supplier),i.frm.set_query("contact_person",erpnext.queries.contact_query),i.frm.set_query("supplier_address",erpnext.queries.address_query),i.frm.set_query("billing_address",erpnext.queries.company_address_query),erpnext.accounts.dimensions.setup_dimension_filters(i.frm,i.frm.doctype),this.frm.set_query("item_code","items",function(){if(i.frm.doc.is_subcontracted){var s={supplier:i.frm.doc.supplier};return i.frm.doc.is_old_subcontracting_flow?s.is_sub_contracted_item=1:s.is_stock_item=0,{query:"erpnext.controllers.queries.item_query",filters:s}}else return{query:"erpnext.controllers.queries.item_query",filters:{supplier:i.frm.doc.supplier,is_purchase_item:1,has_variants:0}}}),this.frm.set_query("manufacturer","items",function(s,n,o){let l=locals[n][o];return{query:"erpnext.controllers.queries.item_manufacturer_query",filters:{item_code:l.item_code}}}),this.frm.fields_dict.items.grid.get_field("item_code")&&this.frm.set_query("item_tax_template","items",function(s,n,o){return i.set_query_for_item_tax_template(s,n,o)})}refresh(e){frappe.dynamic_link={doc:this.frm.doc,fieldname:"supplier",doctype:"Supplier"},this.frm.toggle_display("supplier_name",this.frm.doc.supplier_name&&this.frm.doc.supplier_name!==this.frm.doc.supplier),this.frm.doc.docstatus==0&&(this.frm.doctype==="Purchase Order"||this.frm.doctype==="Material Request")&&this.set_from_product_bundle(),this.toggle_subcontracting_fields(),super.refresh()}toggle_subcontracting_fields(){["Purchase Receipt","Purchase Invoice"].includes(this.frm.doc.doctype)&&(this.frm.fields_dict.supplied_items.grid.update_docfield_property("consumed_qty","read_only",this.frm.doc.__onload&&this.frm.doc.__onload.backflush_based_on==="BOM"),this.frm.set_df_property("supplied_items","cannot_add_rows",1),this.frm.set_df_property("supplied_items","cannot_delete_rows",1))}supplier(){var e=this;erpnext.utils.get_party_details(this.frm,null,null,function(){e.apply_price_list()})}supplier_address(){erpnext.utils.get_address_display(this.frm),erpnext.utils.set_taxes_from_address(this.frm,"supplier_address","supplier_address","supplier_address")}buying_price_list(){this.apply_price_list()}discount_percentage(e,t,a){var i=frappe.get_doc(t,a);i.discount_amount=0,this.price_list_rate(e,t,a)}discount_amount(e,t,a){var i=frappe.get_doc(t,a);i.discount_percentage=0,this.price_list_rate(e,t,a)}qty(e,t,a){(e.doctype=="Purchase Receipt"||e.doctype=="Purchase Invoice"&&(e.update_stock||e.is_return))&&this.calculate_received_qty(e,t,a),super.qty(e,t,a)}rejected_qty(e,t,a){this.calculate_received_qty(e,t,a)}calculate_received_qty(e,t,a){var i=frappe.get_doc(t,a);if(frappe.model.round_floats_in(i,["qty","rejected_qty"]),!e.is_return&&this.validate_negative_quantity(t,a,i,["qty","rejected_qty"]))return;let s=flt(i.qty+i.rejected_qty,precision("received_qty",i)),n=flt(i.conversion_factor,precision("conversion_factor",i))*flt(s);frappe.model.set_value(t,a,"received_qty",s),frappe.model.set_value(t,a,"received_stock_qty",n)}batch_no(e,t,a){super.batch_no(e,t,a)}validate_negative_quantity(e,t,a,i){if(!(!a||!i)){for(var s=!1,n=0;n<i.length;n++)if(a[i[n]]<0){frappe.msgprint(__("Row #{0}: {1} can not be negative for item {2}",[a.idx,__(frappe.meta.get_label(e,i[n],t)),a.item_code])),s=!0;break}return s}}warehouse(e,t,a){var i=frappe.get_doc(t,a);if(i.item_code&&i.warehouse)return this.frm.call({method:"erpnext.stock.get_item_details.get_bin_details",child:i,args:{item_code:i.item_code,warehouse:i.warehouse,company:e.company,include_child_warehouses:!0}})}project(e,t,a){var i=frappe.get_doc(t,a);i.project&&$.each(this.frm.doc.items||[],function(s,n){n.project||(n.project=i.project,refresh_field("project",n.name,n.parentfield))})}rejected_warehouse(e,t){["Purchase Invoice","Purchase Receipt"].includes(t)&&this.autofill_warehouse(e.items,"rejected_warehouse",e.rejected_warehouse)}category(e,t,a){t!=e.doctype&&this.calculate_taxes_and_totals()}add_deduct_tax(e,t,a){this.calculate_taxes_and_totals()}set_from_product_bundle(){var e=this;this.frm.add_custom_button(__("Product Bundle"),function(){erpnext.buying.get_items_from_product_bundle(e.frm)},__("Get Items From"))}shipping_address(){var e=this;erpnext.utils.get_address_display(this.frm,"shipping_address","shipping_address_display",!0)}billing_address(){erpnext.utils.get_address_display(this.frm,"billing_address","billing_address_display",!0)}tc_name(){this.get_terms()}update_auto_repeat_reference(e){e.auto_repeat&&frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.update_reference",args:{docname:e.auto_repeat,reference:e.name},callback:function(t){t.message=="success"?frappe.show_alert({message:__("Auto repeat document updated"),indicator:"green"}):frappe.show_alert({message:__("An error occurred during the update process"),indicator:"red"})}})}manufacturer(e,t,a){let i=locals[t][a];i.manufacturer&&frappe.call({method:"erpnext.stock.doctype.item_manufacturer.item_manufacturer.get_item_manufacturer_part_no",args:{item_code:i.item_code,manufacturer:i.manufacturer},callback:function(s){s.message&&frappe.model.set_value(t,a,"manufacturer_part_no",s.message)}})}manufacturer_part_no(e,t,a){let i=locals[t][a];i.manufacturer_part_no&&frappe.model.get_value("Item Manufacturer",{item_code:i.item_code,manufacturer:i.manufacturer,manufacturer_part_no:i.manufacturer_part_no},"name",function(s){if(!s){let n={message:__("Manufacturer Part Number <b>{0}</b> is invalid",[i.manufacturer_part_no]),title:__("Invalid Part Number")};frappe.throw(n)}})}add_serial_batch_bundle(e,t,a){let i=locals[t][a],s=this,n=["has_batch_no","has_serial_no"];frappe.db.get_value("Item",i.item_code,n).then(o=>{o.message&&(o.message.has_batch_no||o.message.has_serial_no)&&(n.forEach(l=>{i[l]=o.message[l]}),i.type_of_transaction=i.qty>0?"Inward":"Outward",i.is_rejected=!1,new erpnext.SerialBatchPackageSelector(s.frm,i,l=>{if(l){let c=Math.abs(l.total_qty);e.is_return&&(c=c*-1);let d={serial_and_batch_bundle:l.name,use_serial_batch_fields:0,qty:c/flt(i.conversion_factor||1,precision("conversion_factor",i))};l.warehouse&&(d.warehouse=l.warehouse),frappe.model.set_value(i.doctype,i.name,d)}}))})}add_serial_batch_for_rejected_qty(e,t,a){let i=locals[t][a],s=this,n=["has_batch_no","has_serial_no"];frappe.db.get_value("Item",i.item_code,n).then(o=>{o.message&&(o.message.has_batch_no||o.message.has_serial_no)&&(n.forEach(l=>{i[l]=o.message[l]}),i.type_of_transaction=!e.is_return>0?"Inward":"Outward",i.is_rejected=!0,new erpnext.SerialBatchPackageSelector(s.frm,i,l=>{if(l){let c=Math.abs(l.total_qty);e.is_return&&(c=c*-1);let d={rejected_serial_and_batch_bundle:l.name,use_serial_batch_fields:0,rejected_qty:c/flt(i.conversion_factor||1,precision("conversion_factor",i))};l.warehouse&&(d.rejected_warehouse=l.warehouse),frappe.model.set_value(i.doctype,i.name,d)}}))})}}}};erpnext.buying.link_to_mrs=function(r){frappe.call({method:"erpnext.buying.utils.get_linked_material_requests",args:{items:r.doc.items.map(e=>e.item_code)},callback:function(e){(!e.message||e.message.length==0)&&frappe.throw({message:__("No pending Material Requests found to link for the given items."),title:__("Note")});var t=r.doc.items.length;for(let i of r.doc.items){var a=i.qty;(e.message[0]||[]).forEach(function(s){if(s.qty>0&&a>0&&i.item_code==s.item_code&&!i.material_request_item){i.material_request=s.mr_name,i.material_request_item=s.mr_item;var n=Math.min(a,s.qty);if(a=a-n,s.qty=s.qty-n,i.stock_qty=n*i.conversion_factor,i.qty=n,frappe.msgprint("Assigning "+s.mr_name+" to "+s.item_code+" (row "+i.idx+")"),a>0){frappe.msgprint("Splitting "+a+" units of "+s.item_code);var o=frappe.model.add_child(r.doc,i.doctype,"items");t++;for(var l in i)o[l]=i[l];o.idx=t,o.stock_qty=o.conversion_factor*a,o.qty=a,o.material_request="",o.material_request_item=""}}})}refresh_field("items")}})};erpnext.buying.get_default_bom=function(r){$.each(r.doc.items||[],function(e,t){if(t.item_code&&t.bom==="")return frappe.call({type:"GET",method:"erpnext.stock.get_item_details.get_default_bom",args:{item_code:t.item_code},callback:function(a){a&&frappe.model.set_value(t.doctype,t.name,"bom",a.message)}})})};erpnext.buying.get_items_from_product_bundle=function(r){var e=new frappe.ui.Dialog({title:__("Get Items from Product Bundle"),fields:[{fieldtype:"Link",label:__("Product Bundle"),fieldname:"product_bundle",options:"Product Bundle",reqd:1},{fieldtype:"Currency",label:__("Quantity"),fieldname:"quantity",reqd:1,default:1}],primary_action_label:"Get Items",primary_action(t){if(!!t)return e.hide(),frappe.call({type:"GET",method:"erpnext.stock.doctype.packed_item.packed_item.get_items_from_product_bundle",args:{row:{item_code:t.product_bundle,quantity:t.quantity,parenttype:r.doc.doctype,parent:r.doc.name,supplier:r.doc.supplier,currency:r.doc.currency,conversion_rate:r.doc.conversion_rate,price_list:r.doc.buying_price_list,price_list_currency:r.doc.price_list_currency,plc_conversion_rate:r.doc.plc_conversion_rate,company:r.doc.company,is_subcontracted:r.doc.is_subcontracted,transaction_date:r.doc.transaction_date||r.doc.posting_date,ignore_pricing_rule:r.doc.ignore_pricing_rule,doctype:r.doc.doctype}},freeze:!0,callback:function(a){let i=function(d){return $.isArray(d)&&d.length>0?!d[0].item_code:!1},s=function(d){i(d.doc.items)&&(d.doc.items=d.doc.items.splice(1))};if(!a.exc&&a.message){s(r);for(var n=0;n<a.message.length;n++){var o=r.add_child("items"),l=a.message[n];for(var c in l)!is_null(l[c])&&c!=="doctype"&&(o[c]=l[c]);frappe.meta.get_docfield(o.doctype,"price_list_rate",o.name)&&r.script_manager.trigger("price_list_rate",o.doctype,o.name)}r.refresh_field("items")}}})}});e.show()};frappe.provide("erpnext.demo");$(document).on("toolbar_setup",function(){frappe.boot.sysdefaults.demo_company&&q()});function q(){$(`<a class="dropdown-item" onclick="return erpnext.demo.clear_demo()">
			${__("Clear Demo Data")}
		</a>`).appendTo($("#toolbar-user"))}erpnext.demo.clear_demo=function(){frappe.confirm(__("Are you sure you want to clear all demo data?"),()=>{frappe.call({method:"erpnext.setup.demo.clear_demo_data",freeze:!0,freeze_message:__("Clearing Demo Data..."),callback:function(r){frappe.ui.toolbar.clear_cache(),frappe.show_alert({message:__("Demo data cleared"),indicator:"green"})}})})};frappe.provide("erpnext.financial_statements");erpnext.financial_statements={filters:v(),baseData:null,formatter:function(r,e,t,a,i,s){if(frappe.query_report.get_filter_value("selected_view")=="Growth"&&a&&t.colIndex>=3){let o=e[t.colIndex-1].content,l=a[t.fieldname];if(l==null)return"NA";let c=0;o==0&&l>0?c=1:o>0&&(c=(l-o)/o);let d=Math.round(c*1e4)/100;return r=$(`<span>${(d>=0?"+":"")+d+"%"}</span>`),d<0?r=$(r).addClass("text-danger"):r=$(r).addClass("text-success"),r=$(r).wrap("<p></p>").parent().html(),r}else if(frappe.query_report.get_filter_value("selected_view")=="Margin"&&a&&(t.fieldname=="account"&&a.account_name==__("Income")&&(this.baseData=e),t.colIndex>=2)){let o=a[t.fieldname],l=this.baseData[t.colIndex].content;if(o==null||l<=0)return"NA";let c=Math.round(o/l*1e4)/100;return r=$(`<span>${c+"%"}</span>`),c<0?r=$(r).addClass("text-danger"):r=$(r).addClass("text-success"),r=$(r).wrap("<p></p>").parent().html(),r}if(a&&t.fieldname=="account"){if(r=a.account_name||r,s&&(s==null?void 0:s.text)&&(s==null?void 0:s.type)=="contains"&&!r.toLowerCase().includes(s.text))return r;a.account&&(t.link_onclick="erpnext.financial_statements.open_general_ledger("+JSON.stringify(a)+")"),t.is_tree=!0}if(r=i(r,e,t,a),a&&!a.parent_account){r=$(`<span>${r}</span>`);var n=$(r).css("font-weight","bold");a.warn_if_negative&&a[t.fieldname]<0&&n.addClass("text-danger"),r=n.wrap("<p></p>").parent().html()}return r},open_general_ledger:function(r){if(!r.account)return;let e=$.grep(frappe.query_report.filters,function(a){return a.df.fieldname=="project"});frappe.route_options={account:r.account,company:frappe.query_report.get_filter_value("company"),from_date:r.from_date||r.year_start_date,to_date:r.to_date||r.year_end_date,project:e&&e.length>0?e[0].$input.val():""};let t="General Ledger";["Payable","Receivable"].includes(r.account_type)&&(t=r.account_type=="Payable"?"Accounts Payable":"Accounts Receivable",frappe.route_options.party_account=r.account,frappe.route_options.report_date=r.year_end_date),frappe.set_route("query-report",t)},tree:!0,name_field:"account",parent_field:"parent_account",initial_depth:3,onload:function(r){erpnext.financial_statements.filters=v();let e=erpnext.utils.get_fiscal_year(frappe.datetime.get_today());var t=r.get_values();if((!t.period_start_date||!t.period_end_date)&&frappe.model.with_doc("Fiscal Year",e,function(a){var i=frappe.model.get_doc("Fiscal Year",e);frappe.query_report.set_filter_value({period_start_date:i.year_start_date,period_end_date:i.year_end_date})}),r.page){let a=r.page.add_custom_button_group(__("Financial Statements"));r.page.add_custom_menu_item(a,__("Balance Sheet"),function(){var i=r.get_values();frappe.set_route("query-report","Balance Sheet",{company:i.company})}),r.page.add_custom_menu_item(a,__("Profit and Loss"),function(){var i=r.get_values();frappe.set_route("query-report","Profit and Loss Statement",{company:i.company})}),r.page.add_custom_menu_item(a,__("Cash Flow Statement"),function(){var i=r.get_values();frappe.set_route("query-report","Cash Flow",{company:i.company})})}}};function v(){let r=[{fieldname:"company",label:__("Company"),fieldtype:"Link",options:"Company",default:frappe.defaults.get_user_default("Company"),reqd:1},{fieldname:"finance_book",label:__("Finance Book"),fieldtype:"Link",options:"Finance Book"},{fieldname:"filter_based_on",label:__("Filter Based On"),fieldtype:"Select",options:["Fiscal Year","Date Range"],default:["Fiscal Year"],reqd:1,on_change:function(){let a=frappe.query_report.get_filter_value("filter_based_on");frappe.query_report.toggle_filter_display("from_fiscal_year",a==="Date Range"),frappe.query_report.toggle_filter_display("to_fiscal_year",a==="Date Range"),frappe.query_report.toggle_filter_display("period_start_date",a==="Fiscal Year"),frappe.query_report.toggle_filter_display("period_end_date",a==="Fiscal Year"),frappe.query_report.refresh()}},{fieldname:"period_start_date",label:__("Start Date"),fieldtype:"Date",reqd:1,depends_on:"eval:doc.filter_based_on == 'Date Range'"},{fieldname:"period_end_date",label:__("End Date"),fieldtype:"Date",reqd:1,depends_on:"eval:doc.filter_based_on == 'Date Range'"},{fieldname:"from_fiscal_year",label:__("Start Year"),fieldtype:"Link",options:"Fiscal Year",reqd:1,depends_on:"eval:doc.filter_based_on == 'Fiscal Year'"},{fieldname:"to_fiscal_year",label:__("End Year"),fieldtype:"Link",options:"Fiscal Year",reqd:1,depends_on:"eval:doc.filter_based_on == 'Fiscal Year'"},{fieldname:"periodicity",label:__("Periodicity"),fieldtype:"Select",options:[{value:"Monthly",label:__("Monthly")},{value:"Quarterly",label:__("Quarterly")},{value:"Half-Yearly",label:__("Half-Yearly")},{value:"Yearly",label:__("Yearly")}],default:"Yearly",reqd:1},{fieldname:"presentation_currency",label:__("Currency"),fieldtype:"Select",options:erpnext.get_presentation_currency_list()},{fieldname:"cost_center",label:__("Cost Center"),fieldtype:"MultiSelectList",get_data:function(a){return frappe.db.get_link_options("Cost Center",a,{company:frappe.query_report.get_filter_value("company")})}},{fieldname:"project",label:__("Project"),fieldtype:"MultiSelectList",get_data:function(a){return frappe.db.get_link_options("Project",a,{company:frappe.query_report.get_filter_value("company")})}}],e=r.filter(a=>["from_fiscal_year","to_fiscal_year"].includes(a.fieldname));if(erpnext.utils.get_fiscal_year(frappe.datetime.get_today(),!1,!0)){let a=erpnext.utils.get_fiscal_year(frappe.datetime.get_today(),!1,!1);e.forEach(i=>{i.default=a})}return r}erpnext.sales_trends_filters={filters:[{fieldname:"period",label:__("Period"),fieldtype:"Select",options:[{value:"Monthly",label:__("Monthly")},{value:"Quarterly",label:__("Quarterly")},{value:"Half-Yearly",label:__("Half-Yearly")},{value:"Yearly",label:__("Yearly")}],default:"Monthly"},{fieldname:"based_on",label:__("Based On"),fieldtype:"Select",options:[{value:"Item",label:__("Item")},{value:"Item Group",label:__("Item Group")},{value:"Customer",label:__("Customer")},{value:"Customer Group",label:__("Customer Group")},{value:"Territory",label:__("Territory")},{value:"Project",label:__("Project")}],default:"Item",dashboard_config:{read_only:1}},{fieldname:"group_by",label:__("Group By"),fieldtype:"Select",options:["",{value:"Item",label:__("Item")},{value:"Customer",label:__("Customer")}],default:""},{fieldname:"fiscal_year",label:__("Fiscal Year"),fieldtype:"Link",options:"Fiscal Year",default:erpnext.utils.get_fiscal_year(frappe.datetime.get_today())},{fieldname:"company",label:__("Company"),fieldtype:"Link",options:"Company",default:frappe.defaults.get_user_default("Company")}]};erpnext.purchase_trends_filters={filters:[{fieldname:"company",label:__("Company"),fieldtype:"Link",options:"Company",reqd:1,default:frappe.defaults.get_user_default("Company")},{fieldname:"period",label:__("Period"),fieldtype:"Select",options:[{value:"Monthly",label:__("Monthly")},{value:"Quarterly",label:__("Quarterly")},{value:"Half-Yearly",label:__("Half-Yearly")},{value:"Yearly",label:__("Yearly")}],default:"Monthly"},{fieldname:"fiscal_year",label:__("Fiscal Year"),fieldtype:"Link",options:"Fiscal Year",default:erpnext.utils.get_fiscal_year(frappe.datetime.get_today())},{fieldname:"period_based_on",label:__("Period based On"),fieldtype:"Select",options:[{value:"posting_date",label:__("Posting Date")},{value:"bill_date",label:__("Billing Date")}],default:"posting_date"},{fieldname:"based_on",label:__("Based On"),fieldtype:"Select",options:[{value:"Item",label:__("Item")},{value:"Item Group",label:__("Item Group")},{value:"Supplier",label:__("Supplier")},{value:"Supplier Group",label:__("Supplier Group")},{value:"Project",label:__("Project")}],default:"Item",dashboard_config:{read_only:1}},{fieldname:"group_by",label:__("Group By"),fieldtype:"Select",options:["",{value:"Item",label:__("Item")},{value:"Supplier",label:__("Supplier")}],default:""}]};})();
//# sourceMappingURL=erpnext.bundle.YXCJUNOB.js.map
