(()=>{var P=Object.create;var f=Object.defineProperty,x=Object.defineProperties,S=Object.getOwnPropertyDescriptor,q=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertyNames,y=Object.getOwnPropertySymbols,T=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var b=(e,t,i)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t)=>{for(var i in t||(t={}))w.call(t,i)&&b(e,i,t[i]);if(y)for(var i of y(t))D.call(t,i)&&b(e,i,t[i]);return e},h=(e,t)=>x(e,q(t));var L=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var E=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of O(t))!w.call(e,n)&&n!==i&&f(e,n,{get:()=>t[n],enumerable:!(s=S(t,n))||s.enumerable});return e};var I=(e,t,i)=>(i=e!=null?P(T(e)):{},E(t||!e||!e.__esModule?f(i,"default",{value:e,enumerable:!0}):i,e));var k=L((v,g)=>{(function(e,t){typeof v=="object"&&typeof g!="undefined"?g.exports=t():typeof define=="function"&&define.amd?define(t()):e.onScan=t()})(v,function(){var e={attachTo:function(t,i){if(t.scannerDetectionData!==void 0)throw new Error("onScan.js is already initialized for DOM element "+t);var s={onScan:function(n,a){},onScanError:function(n){},onKeyProcess:function(n,a){},onKeyDetect:function(n,a){},onPaste:function(n,a){},keyCodeMapper:function(n){return e.decodeKeyEvent(n)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1};return i=this._mergeOptions(s,i),t.scannerDetectionData={options:i,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste,i.captureEvents),i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp,i.captureEvents),(i.reactToKeydown===!0||i.scanButtonKeyCode!==!1)&&t.addEventListener("keydown",this._handleKeyDown,i.captureEvents),this},detachFrom:function(t){t.scannerDetectionData.options.reactToPaste&&t.removeEventListener("paste",this._handlePaste),t.scannerDetectionData.options.scanButtonKeyCode!==!1&&t.removeEventListener("keyup",this._handleKeyUp),t.removeEventListener("keydown",this._handleKeyDown),t.scannerDetectionData=void 0},getOptions:function(t){return t.scannerDetectionData.options},setOptions:function(t,i){switch(t.scannerDetectionData.options.reactToPaste){case!0:i.reactToPaste===!1&&t.removeEventListener("paste",this._handlePaste);break;case!1:i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste);break}switch(t.scannerDetectionData.options.scanButtonKeyCode){case!1:i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp);break;default:i.scanButtonKeyCode===!1&&t.removeEventListener("keyup",this._handleKeyUp);break}return t.scannerDetectionData.options=this._mergeOptions(t.scannerDetectionData.options,i),this._reinitialize(t),this},decodeKeyEvent:function(t){var i=this._getNormalizedKeyNum(t);switch(!0){case(i>=48&&i<=90):case(i>=106&&i<=111):if(t.key!==void 0&&t.key!=="")return t.key;var s=String.fromCharCode(i);switch(t.shiftKey){case!1:s=s.toLowerCase();break;case!0:s=s.toUpperCase();break}return s;case(i>=96&&i<=105):return 0+(i-96)}return""},simulate:function(t,i){return this._reinitialize(t),Array.isArray(i)?i.forEach(function(s){var n={};(typeof s=="object"||typeof s=="function")&&s!==null?n=s:n.keyCode=parseInt(s);var a=new KeyboardEvent("keydown",n);document.dispatchEvent(a)}):this._validateScanCode(t,i),this},_reinitialize:function(t){var i=t.scannerDetectionData.vars;i.firstCharTime=0,i.lastCharTime=0,i.accumulatedString=""},_isFocusOnIgnoredElement:function(t){var i=t.scannerDetectionData.options.ignoreIfFocusOn;if(!i)return!1;var s=document.activeElement;if(Array.isArray(i)){for(var n=0;n<i.length;n++)if(s.matches(i[n])===!0)return!0}else if(s.matches(i))return!0;return!1},_validateScanCode:function(t,i){var s=t.scannerDetectionData,n=s.options,a=s.options.singleScanQty,o=s.vars.firstCharTime,r=s.vars.lastCharTime,c={},_;switch(!0){case i.length<n.minLength:c={message:"Receieved code is shorter then minimal length"};break;case r-o>i.length*n.avgTimeByChar:c={message:"Receieved code was not entered in time"};break;default:return n.onScan.call(t,i,a),_=new CustomEvent("scan",{detail:{scanCode:i,qty:a}}),t.dispatchEvent(_),e._reinitialize(t),!0}return c.scanCode=i,c.scanDuration=r-o,c.avgTimeByChar=n.avgTimeByChar,c.minLength=n.minLength,n.onScanError.call(t,c),_=new CustomEvent("scanError",{detail:c}),t.dispatchEvent(_),e._reinitialize(t),!1},_mergeOptions:function(t,i){var s={},n;for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n]);for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n]);return s},_getNormalizedKeyNum:function(t){return t.which||t.keyCode},_handleKeyDown:function(t){var i=e._getNormalizedKeyNum(t),s=this.scannerDetectionData.options,n=this.scannerDetectionData.vars,a=!1;if(s.onKeyDetect.call(this,i,t)!==!1&&!e._isFocusOnIgnoredElement(this)){if(s.scanButtonKeyCode!==!1&&i==s.scanButtonKeyCode){n.longPressed||(n.longPressTimer=setTimeout(s.onScanButtonLongPress,s.scanButtonLongPressTime,this),n.longPressed=!0);return}switch(!0){case(n.firstCharTime&&s.suffixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),a=!0;break;case(!n.firstCharTime&&s.prefixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),a=!1;break;default:var o=s.keyCodeMapper.call(this,t);if(o===null)return;n.accumulatedString+=o,s.preventDefault&&t.preventDefault(),s.stopPropagation&&t.stopImmediatePropagation(),a=!1;break}n.firstCharTime||(n.firstCharTime=Date.now()),n.lastCharTime=Date.now(),n.testTimer&&clearTimeout(n.testTimer),a?(e._validateScanCode(this,n.accumulatedString),n.testTimer=!1):n.testTimer=setTimeout(e._validateScanCode,s.timeBeforeScanTest,this,n.accumulatedString),s.onKeyProcess.call(this,o,t)}},_handlePaste:function(t){var i=this.scannerDetectionData.options,s=this.scannerDetectionData.vars,n=(event.clipboardData||window.clipboardData).getData("text");e._isFocusOnIgnoredElement(this)||(t.preventDefault(),i.stopPropagation&&t.stopImmediatePropagation(),i.onPaste.call(this,n,event),s.firstCharTime=0,s.lastCharTime=0,e._validateScanCode(this,n))},_handleKeyUp:function(t){if(!e._isFocusOnIgnoredElement(this)){var i=e._getNormalizedKeyNum(t);i==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)}},isScanInProgressFor:function(t){return t.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(t){return t.scannerDetectionData!==void 0}};return e})});var u=I(k());erpnext.PointOfSale.ItemSelector=class{constructor({frm:e,wrapper:t,events:i,pos_profile:s,settings:n}){this.wrapper=t,this.events=i,this.pos_profile=s,this.hide_images=n.hide_images,this.auto_add_item=n.auto_add_item_to_cart,this.inti_component()}inti_component(){this.prepare_dom(),this.make_search_bar(),this.load_items_data(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="items-selector">
				<div class="filter-section">
					<div class="label">${__("All Items")}</div>
					<div class="search-field"></div>
					<div class="item-group-field"></div>
				</div>
				<div class="items-container"></div>
			</section>`),this.$component=this.wrapper.find(".items-selector"),this.$items_container=this.$component.find(".items-container")}async load_items_data(){if(!this.item_group){let e=await frappe.db.get_value("Item Group",{lft:1,is_group:1},"name");this.parent_item_group=e.message.name}if(!this.price_list){let e=await frappe.db.get_value("POS Profile",this.pos_profile,"selling_price_list");this.price_list=e.message.selling_price_list}this.get_items({}).then(({message:e})=>{this.render_item_list(e.items)})}get_items({start:e=0,page_length:t=40,search_term:i=""}){let s=this.events.get_frm().doc,n=s&&s.selling_price_list||this.price_list,{item_group:a,pos_profile:o}=this;return!a&&(a=this.parent_item_group),frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.get_items",freeze:!0,args:{start:e,page_length:t,price_list:n,item_group:a,search_term:i,pos_profile:o}})}render_item_list(e){this.$items_container.html(""),e.forEach(t=>{let i=this.get_item_html(t);this.$items_container.append(i)})}get_item_html(e){let t=this,{item_image:i,serial_no:s,batch_no:n,barcode:a,actual_qty:o,uom:r,price_list_rate:c}=e,_=flt(c,2)%1!=0?2:0,l,d=o;e.is_stock_item?(l=o>10?"green":o<=0?"red":"orange",Math.round(d)>999&&(d=Math.round(d)/1e3,d=d.toFixed(1)+"K")):(l="",d="");function p(){return!t.hide_images&&i?`<div class="item-qty-pill">
							<span class="indicator-pill whitespace-nowrap ${l}">${d}</span>
						</div>
						<div class="flex items-center justify-center border-b-grey text-6xl text-grey-100" style="height:8rem; min-height:8rem">
							<img
								onerror="cur_pos.item_selector.handle_broken_image(this)"
								class="h-full item-img" src="${i}"
								alt="${frappe.get_abbr(e.item_name)}"
							>
						</div>`:`<div class="item-qty-pill">
							<span class="indicator-pill whitespace-nowrap ${l}">${d}</span>
						</div>
						<div class="item-display abbr">${frappe.get_abbr(e.item_name)}</div>`}return`<div class="item-wrapper"
				data-item-code="${escape(e.item_code)}" data-serial-no="${escape(s)}"
				data-batch-no="${escape(n)}" data-uom="${escape(r)}"
				data-rate="${escape(c||0)}"
				title="${e.item_name}">

				${p()}

				<div class="item-detail">
					<div class="item-name">
						${frappe.ellipsis(e.item_name,18)}
					</div>
					<div class="item-rate">${format_currency(c,e.currency,_)||0} / ${r}</div>
				</div>
			</div>`}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-display abbr">${t}</div>`)}make_search_bar(){let e=this;this.$component.find(".search-field").html(""),this.$component.find(".item-group-field").html(""),this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by item code, serial number or barcode")},parent:this.$component.find(".search-field"),render_input:!0}),this.item_group_field=frappe.ui.form.make_control({df:{label:__("Item Group"),fieldtype:"Link",options:"Item Group",placeholder:__("Select item group"),onchange:function(){e.item_group=this.value,!e.item_group&&(e.item_group=e.parent_item_group),e.filter_items()},get_query:function(){let t=e.events.get_frm().doc;return{query:"erpnext.selling.page.point_of_sale.point_of_sale.item_group_query",filters:{pos_profile:t?t.pos_profile:""}}}},parent:this.$component.find(".item-group-field"),render_input:!0}),this.search_field.toggle_label(!1),this.item_group_field.toggle_label(!1),this.attach_clear_btn()}attach_clear_btn(){this.search_field.$wrapper.find(".control-input").append(`<span class="link-btn" style="top: 2px;">
				<a class="btn-open no-decoration" title="${__("Clear")}">
					${frappe.utils.icon("close","sm")}
				</a>
			</span>`),this.$clear_search_btn=this.search_field.$wrapper.find(".link-btn"),this.$clear_search_btn.on("click","a",()=>{this.set_search_value(""),this.search_field.set_focus()})}set_search_value(e){$(this.search_field.$input[0]).val(e).trigger("input")}bind_events(){let e=this;window.onScan=u.default,u.default.decodeKeyEvent=function(t){var i=this._getNormalizedKeyNum(t);switch(!0){case(i>=48&&i<=90):case(i>=106&&i<=111):case(i>=160&&i<=164||i==170):case(i>=186&&i<=194):case(i>=219&&i<=222):case i==32:if(t.key!==void 0&&t.key!=="")return t.key;var s=String.fromCharCode(i);switch(t.shiftKey){case!1:s=s.toLowerCase();break;case!0:s=s.toUpperCase();break}return s;case(i>=96&&i<=105):return 0+(i-96)}return""},u.default.attachTo(document,{onScan:t=>{this.search_field&&this.$component.is(":visible")&&(this.search_field.set_focus(),this.set_search_value(t),this.barcode_scanned=!0)}}),this.$component.on("click",".item-wrapper",function(){let t=$(this),i=unescape(t.attr("data-item-code")),s=unescape(t.attr("data-batch-no")),n=unescape(t.attr("data-serial-no")),a=unescape(t.attr("data-uom")),o=unescape(t.attr("data-rate"));s=s==="undefined"?void 0:s,n=n==="undefined"?void 0:n,a=a==="undefined"?void 0:a,o=o==="undefined"?void 0:o,e.events.item_selected({field:"qty",value:"+1",item:{item_code:i,batch_no:s,serial_no:n,uom:a,rate:o}}),e.search_field.set_focus()}),this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.filter_items({search_term:i})},300),this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))}),this.search_field.$input.on("focus",()=>{this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))})}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.search_field.parent.attr("title",`${e}+I`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+i",action:()=>this.search_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on search input"),ignore_inputs:!0,page:cur_page.page.page}),this.item_group_field.parent.attr("title",`${e}+G`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+g",action:()=>this.item_group_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on Item Group filter"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("enter",()=>{!this.$component.is(":visible")||this.search_field.get_value()===""||(this.items.length==1?(this.$items_container.find(".item-wrapper").click(),frappe.utils.play_sound("submit"),this.set_search_value("")):this.items.length==0&&this.barcode_scanned&&(frappe.show_alert({message:__("No items found. Scan barcode again."),indicator:"orange"}),frappe.utils.play_sound("error"),this.barcode_scanned=!1,this.set_search_value("")))})}filter_items({search_term:e=""}={}){if(e&&(e=e.toLowerCase(),this.search_index=this.search_index||{},this.search_index[e])){let t=this.search_index[e];this.items=t,this.render_item_list(t),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart();return}this.get_items({search_term:e}).then(({message:t})=>{let{items:i,serial_no:s,batch_no:n,barcode:a}=t;e&&!a&&(this.search_index[e]=i),this.items=i,this.render_item_list(i),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart()})}add_filtered_item_to_cart(){this.$items_container.find(".item-wrapper").click(),this.set_search_value("")}resize_selector(e){e?this.$component.find(".filter-section").css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$component.find(".filter-section").css("grid-template-columns","repeat(12, minmax(0, 1fr))"),e?this.$component.find(".search-field").css("margin","var(--margin-sm) 0px"):this.$component.find(".search-field").css("margin","0px var(--margin-sm)"),e?this.$component.css("grid-column","span 2 / span 2"):this.$component.css("grid-column","span 6 / span 6"),e?this.$items_container.css("grid-template-columns","repeat(1, minmax(0, 1fr))"):this.$items_container.css("grid-template-columns","repeat(4, minmax(0, 1fr))")}toggle_component(e){this.set_search_value(""),this.$component.css("display",e?"flex":"none")}};erpnext.PointOfSale.ItemCart=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.customer_info=void 0,this.hide_images=i.hide_images,this.allowed_customer_groups=i.customer_groups,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="customer-cart-container"></section>'),this.$component=this.wrapper.find(".customer-cart-container")}init_child_components(){this.init_customer_selector(),this.init_cart_components()}init_customer_selector(){this.$component.append('<div class="customer-section"></div>'),this.$customer_section=this.$component.find(".customer-section"),this.make_customer_selector()}reset_customer_selector(){this.events.get_frm().set_value("customer",""),this.make_customer_selector(),this.customer_field.set_focus()}init_cart_components(){this.$component.append(`<div class="cart-container">
				<div class="abs-cart-container">
					<div class="cart-label">${__("Item Cart")}</div>
					<div class="cart-header">
						<div class="name-header">${__("Item")}</div>
						<div class="qty-header">${__("Quantity")}</div>
						<div class="rate-amount-header">${__("Amount")}</div>
					</div>
					<div class="cart-items-section"></div>
					<div class="cart-totals-section"></div>
					<div class="numpad-section"></div>
				</div>
			</div>`),this.$cart_container=this.$component.find(".cart-container"),this.make_cart_totals_section(),this.make_cart_items_section(),this.make_cart_numpad()}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section"),this.make_no_items_placeholder()}make_no_items_placeholder(){this.$cart_header.css("display","none"),this.$cart_items_wrapper.html(`<div class="no-item-wrapper">${__("No items in cart")}</div>`)}get_discount_icon(){return`<svg class="discount-icon" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>`}make_cart_totals_section(){this.$totals_section=this.$component.find(".cart-totals-section"),this.$totals_section.append(`<div class="add-discount-wrapper">
				${this.get_discount_icon()} ${__("Add Discount")}
			</div>
			<div class="item-qty-total-container">
				<div class="item-qty-total-label">${__("Total Items")}</div>
				<div class="item-qty-total-value">0.00</div>
			</div>
			<div class="net-total-container">
				<div class="net-total-label">${__("Net Total")}</div>
				<div class="net-total-value">0.00</div>
			</div>
			<div class="taxes-container"></div>
			<div class="grand-total-container">
				<div>${__("Grand Total")}</div>
				<div>0.00</div>
			</div>
			<div class="checkout-btn">${__("Checkout")}</div>
			<div class="edit-cart-btn">${__("Edit Cart")}</div>`),this.$add_discount_elem=this.$component.find(".add-discount-wrapper")}make_cart_numpad(){this.$numpad_section=this.$component.find(".numpad-section"),this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad_section,events:{numpad_event:this.on_numpad_event.bind(this)},cols:5,keys:[[1,2,3,"Quantity"],[4,5,6,"Discount"],[7,8,9,"Rate"],[".",0,"Delete","Remove"]],css_classes:[["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2 remove-btn"]],fieldnames_map:{Quantity:"qty",Discount:"discount_percentage"}}),this.$numpad_section.prepend(`<div class="numpad-totals">
			<span class="numpad-item-qty-total"></span>
				<span class="numpad-net-total"></span>
				<span class="numpad-grand-total"></span>
			</div>`),this.$numpad_section.append(`<div class="numpad-btn checkout-btn" data-button-value="checkout">${__("Checkout")}</div>`)}bind_events(){let e=this;this.$customer_section.on("click",".reset-customer-btn",function(){e.reset_customer_selector()}),this.$customer_section.on("click",".close-details-btn",function(){e.toggle_customer_info(!1)}),this.$customer_section.on("click",".customer-display",function(t){if($(t.target).closest(".reset-customer-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_customer_info(i)}),this.$cart_items_wrapper.on("click",".cart-item-wrapper",function(){let t=$(this);e.toggle_item_highlight(this),!e.$totals_section.find(".edit-cart-btn").is(":visible")||e.$totals_section.find(".edit-cart-btn").click();let s=unescape(t.attr("data-row-name"));e.events.cart_item_clicked({name:s}),this.numpad_value=""}),this.$component.on("click",".checkout-btn",async function(){$(this).attr("style").indexOf("--blue-500")!=-1&&(await e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none"))}),this.$totals_section.on("click",".edit-cart-btn",()=>{this.events.edit_cart(),this.toggle_checkout_btn(!0)}),this.$component.on("click",".add-discount-wrapper",()=>{let t=this.$add_discount_elem.find(".edit-discount-btn").length;(!this.discount_field||t)&&this.show_discount_control()}),frappe.ui.form.on("POS Invoice","paid_amount",t=>{this.update_totals_section(t)})}attach_shortcuts(){for(let t of this.number_pad.keys)for(let i of t){if(typeof i!="string")continue;let s=`ctrl+${frappe.scrub(String(i))[0]}`;i==="Delete"&&(s="ctrl+backspace"),i==="Remove"&&(s="shift+ctrl+backspace"),i==="."&&(s="ctrl+>");let n=this.number_pad.fieldnames[i]?this.number_pad.fieldnames[i]:typeof i=="string"?frappe.scrub(i):i,a=s.split("+").map(frappe.utils.to_title_case).join("+");a=frappe.utils.is_mac()?a.replace("Ctrl","\u2318"):a,this.$numpad_section.find(`.numpad-btn[data-button-value="${n}"]`).attr("title",a),frappe.ui.keys.on(`${s}`,()=>{this.$component.is(":visible")&&this.item_is_selected&&this.$numpad_section.is(":visible")&&this.$numpad_section.find(`.numpad-btn[data-button-value="${n}"]`).click()})}let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".checkout-btn").attr("title",`${e}+Enter`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+enter",action:()=>this.$component.find(".checkout-btn").click(),condition:()=>this.$component.is(":visible")&&!this.$totals_section.find(".edit-cart-btn").is(":visible"),description:__("Checkout Order / Submit Order / New Order"),ignore_inputs:!0,page:cur_page.page.page}),this.$component.find(".edit-cart-btn").attr("title",`${e}+E`),frappe.ui.keys.on("ctrl+e",()=>{let t=this.$component.is(":visible"),i=!this.$totals_section.find(".checkout-btn").is("visible");t&&i&&this.$component.find(".edit-cart-btn").click()}),this.$component.find(".add-discount-wrapper").attr("title",`${e}+D`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+d",action:()=>this.$component.find(".add-discount-wrapper").click(),condition:()=>this.$add_discount_elem.is(":visible"),description:__("Add Order Discount"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.discount_field&&this.discount_field.parent.is(":visible")&&this.discount_field.set_value(0)})}toggle_item_highlight(e){let t=$(e),i=t.attr("style")=="background-color:var(--gray-50);";!e||i?(this.item_is_selected=!1,this.$cart_container.find(".cart-item-wrapper").css("background-color","")):(t.css("background-color","var(--control-bg)"),this.item_is_selected=!0,this.$cart_container.find(".cart-item-wrapper").not(e).css("background-color",""))}make_customer_selector(){this.$customer_section.html(`
			<div class="customer-field"></div>
		`);let e=this,t=this.allowed_customer_groups||[],i={};t.length&&(i={customer_group:["in",t]}),this.customer_field=frappe.ui.form.make_control({df:{label:__("Customer"),fieldtype:"Link",options:"Customer",placeholder:__("Search by customer name, phone, email."),get_query:function(){return{filters:i}},onchange:function(){if(this.value){let s=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(s.doc.doctype,s.doc.name,"customer",this.value),s.script_manager.trigger("customer",s.doc.doctype,s.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(this.value),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>e.update_totals_section(),()=>frappe.dom.unfreeze()])})}}},parent:this.$customer_section.find(".customer-field"),render_input:!0}),this.customer_field.toggle_label(!1)}fetch_customer_details(e){return e?new Promise(t=>{frappe.db.get_value("Customer",e,["email_id","mobile_no","image","loyalty_program"]).then(({message:i})=>{let{loyalty_program:s}=i;s?frappe.call({method:"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points",args:{customer:e,loyalty_program:s,silent:!0},callback:n=>{let{loyalty_points:a,conversion_factor:o}=n.message;n.exc||(this.customer_info=h(m({},i),{customer:e,loyalty_points:a,conversion_factor:o}),t())}}):(this.customer_info=h(m({},i),{customer:e}),t())})}):new Promise(t=>{this.customer_info={},t()})}show_discount_control(){this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>');let e=this,t=e.events.get_frm(),i=t.doc.additional_discount_percentage;this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i?i+"%":__("Enter discount percentage."),input_class:"input-xs",onchange:function(){this.value=flt(this.value),frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",flt(this.value)),e.hide_discount_control(this.value)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}),this.discount_field.toggle_label(!1),this.discount_field.set_focus()}hide_discount_control(e){flt(e)?(this.$add_discount_elem.css({border:"1px dashed var(--dark-green-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.$add_discount_elem.html(`<div class="edit-discount-btn">
					${this.get_discount_icon()} ${__("Additional")}&nbsp;${String(e).bold()}% ${__("discount applied")}
				</div>`)):(this.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.$add_discount_elem.html(`${this.get_discount_icon()} ${__("Add Discount")}`),this.discount_field=void 0)}update_customer_section(){let e=this,{customer:t,email_id:i="",mobile_no:s="",image:n}=this.customer_info||{};t?this.$customer_section.html(`<div class="customer-details">
					<div class="customer-display">
						${this.get_customer_image()}
						<div class="customer-name-desc">
							<div class="customer-name">${t}</div>
							${a()}
						</div>
						<div class="reset-customer-btn" data-customer="${escape(t)}">
							<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
								<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
							</svg>
						</div>
					</div>
				</div>`):this.reset_customer_selector();function a(){return!i&&!s?`<div class="customer-desc">${__("Click to add email / phone")}</div>`:i&&!s?`<div class="customer-desc">${i}</div>`:s&&!i?`<div class="customer-desc">${s}</div>`:`<div class="customer-desc">${i} - ${s}</div>`}}get_customer_image(){let{customer:e,image:t}=this.customer_info||{};return t?`<div class="customer-image"><img src="${t}" alt="${t}""></div>`:`<div class="customer-image customer-abbr">${frappe.get_abbr(e)}</div>`}update_totals_section(e){e||(e=this.events.get_frm()),this.render_net_total(e.doc.net_total),this.render_total_item_qty(e.doc.items);let t=cint(frappe.sys_defaults.disable_rounded_total)?e.doc.grand_total:e.doc.rounded_total;this.render_grand_total(t),this.render_taxes(e.doc.taxes)}render_net_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".net-total-container").html(`<div>${__("Net Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-net-total").html(`<div>${__("Net Total")}: <span>${format_currency(e,t)}</span></div>`)}render_total_item_qty(e){var t=0;e.map(i=>{t=t+i.qty}),this.$totals_section.find(".item-qty-total-container").html(`<div>${__("Total Quantity")}</div><div>${t}</div>`),this.$numpad_section.find(".numpad-item-qty-total").html(`<div>${__("Total Quantity")}: <span>${t}</span></div>`)}render_grand_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".grand-total-container").html(`<div>${__("Grand Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-grand-total").html(`<div>${__("Grand Total")}: <span>${format_currency(e,t)}</span></div>`)}render_taxes(e){if(e&&e.length){let t=this.events.get_frm().doc.currency,i=e.map(s=>s.tax_amount_after_discount_amount==0?void 0:`<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(s.description)?s.description:s.rate!=0?`${s.description} @ ${s.rate}%`:s.description}</div>
					<div class="tax-value">${format_currency(s.tax_amount_after_discount_amount,t)}</div>
				</div>`).join("");this.$totals_section.find(".taxes-container").css("display","flex").html(i)}else this.$totals_section.find(".taxes-container").css("display","none").html("")}get_cart_item({name:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}get_item_from_frm(e){return this.events.get_frm().doc.items.find(i=>i.name==e.name)}update_item_html(e,t){let i=this.get_cart_item(e);if(t)i&&i.next().remove()&&i.remove();else{let n=this.get_item_from_frm(e);this.render_cart_item(n,i)}let s=this.$cart_items_wrapper.find(".cart-item-wrapper").length;this.highlight_checkout_btn(s>0),this.update_empty_cart_section(s)}render_cart_item(e,t){let i=this.events.get_frm().doc.currency,s=this;t.length||(this.$cart_items_wrapper.append(`<div class="cart-item-wrapper" data-row-name="${escape(e.name)}"></div>
				<div class="seperator"></div>`),t=this.get_cart_item(e)),t.html(`${r()}
			<div class="item-name-desc">
				<div class="item-name">
					${e.item_name}
				</div>
				${o()}
			</div>
			${a()}`),n();function n(){let c=Array.from(s.$cart_items_wrapper.find(".item-rate-amount"));s.$cart_header.find(".rate-amount-header").css("width",""),s.$cart_items_wrapper.find(".item-rate-amount").css("width","");let _=c.reduce((l,d)=>($(d).width()>l&&(l=$(d).width()),l),0);_+=1,_==1&&(_=""),s.$cart_header.find(".rate-amount-header").css("width",_),s.$cart_items_wrapper.find(".item-rate-amount").css("width",_)}function a(){return e.rate&&e.amount&&e.rate!==e.amount?`
					<div class="item-qty-rate">
						<div class="item-qty"><span>${e.qty||0} ${e.uom}</span></div>
						<div class="item-rate-amount">
							<div class="item-rate">${format_currency(e.amount,i)}</div>
							<div class="item-amount">${format_currency(e.rate,i)}</div>
						</div>
					</div>`:`
					<div class="item-qty-rate">
						<div class="item-qty"><span>${e.qty||0} ${e.uom}</span></div>
						<div class="item-rate-amount">
							<div class="item-rate">${format_currency(e.rate,i)}</div>
						</div>
					</div>`}function o(){if(e.description){if(e.description.indexOf("<div>")!=-1)try{e.description=$(e.description).text()}catch(c){e.description=e.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return e.description=frappe.ellipsis(e.description,45),`<div class="item-desc">${e.description}</div>`}return""}function r(){let{image:c,item_name:_}=e;return!s.hide_images&&c?`
					<div class="item-image">
						<img
							onerror="cur_pos.cart.handle_broken_image(this)"
							src="${c}" alt="${frappe.get_abbr(_)}"">
					</div>`:`<div class="item-image item-abbr">${frappe.get_abbr(_)}</div>`}}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-image item-abbr">${t}</div>`)}update_selector_value_in_cart_item(e,t,i){this.get_cart_item(i).attr(`data-${e}`,escape(t))}toggle_checkout_btn(e){e?(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","flex"))}highlight_checkout_btn(e){e?(this.$add_discount_elem.css("display","flex"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-500)"})):(this.$add_discount_elem.css("display","none"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-200)"}))}update_empty_cart_section(e){let t=this.$cart_items_wrapper.find(".no-item-wrapper");e>0&&t&&t.remove()&&this.$cart_header.css("display","flex"),e===0&&!t.length&&this.make_no_items_placeholder()}on_numpad_event(e){let t=e.attr("data-button-value"),i=["qty","discount_percentage","rate"].includes(t),s=i?t=="rate"&&this.allow_rate_change||t=="discount_percentage"&&this.allow_discount_change||t=="qty":!0,n=this.prev_action===t,a=!this.prev_action,o=this.prev_action&&this.prev_action!=t;if(i){if(!s){let c=t=="rate"?"Rate".bold():"Discount".bold(),_=__("Editing {0} is not allowed as per POS Profile settings",[c]);frappe.show_alert({indicator:"red",message:_}),frappe.utils.play_sound("error");return}a||o?this.prev_action=t:n&&(this.prev_action=void 0),this.numpad_value=""}else if(t==="checkout"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else if(t==="remove"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.numpad_value=this.numpad_value||0;if(!i&&a){frappe.show_alert({indicator:"red",message:__("Please select a field to edit from numpad")}),frappe.utils.play_sound("error");return}flt(this.numpad_value)>100&&this.prev_action==="discount_percentage"&&(frappe.show_alert({message:__("Discount cannot be greater than 100%"),indicator:"orange"}),frappe.utils.play_sound("error"),this.numpad_value=t),this.highlight_numpad_btn(e,t),this.events.numpad_event(this.numpad_value,this.prev_action)}highlight_numpad_btn(e,t){let i=e.hasClass("highlighted-numpad-btn"),s=["qty","discount_percentage","rate","done"].includes(t);i||e.addClass("highlighted-numpad-btn"),this.prev_action===t&&i&&e.removeClass("highlighted-numpad-btn"),this.prev_action&&this.prev_action!==t&&s&&$(`[data-button-value='${this.prev_action}']`).removeClass("highlighted-numpad-btn"),(!s||t==="done")&&setTimeout(()=>{e.removeClass("highlighted-numpad-btn")},200)}toggle_numpad(e){e?(this.$totals_section.css("display","none"),this.$numpad_section.css("display","flex")):(this.$totals_section.css("display","flex"),this.$numpad_section.css("display","none")),this.reset_numpad()}reset_numpad(){this.numpad_value="",this.prev_action=void 0,this.$numpad_section.find(".highlighted-numpad-btn").removeClass("highlighted-numpad-btn")}toggle_numpad_field_edit(e){["qty","discount_percentage","rate"].includes(e)&&this.$numpad_section.find(`[data-button-value="${e}"]`).click()}toggle_customer_info(e){if(e){let{customer:t}=this.customer_info||{};this.$cart_container.css("display","none"),this.$customer_section.css({height:"100%","padding-top":"0px"}),this.$customer_section.find(".customer-details").html(`<div class="header">
					<div class="label">${__("Contact Details")}</div>
					<div class="close-details-btn">
						<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
							<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
						</svg>
					</div>
				</div>
				<div class="customer-display">
					${this.get_customer_image()}
					<div class="customer-name-desc">
						<div class="customer-name">${t}</div>
						<div class="customer-desc"></div>
					</div>
				</div>
				<div class="customer-fields-container">
					<div class="email_id-field"></div>
					<div class="mobile_no-field"></div>
					<div class="loyalty_program-field"></div>
					<div class="loyalty_points-field"></div>
				</div>
				<div class="transactions-label">${__("Recent Transactions")}</div>`),this.$customer_section.append('<div class="customer-transactions"></div>'),this.render_customer_fields(),this.fetch_customer_transactions()}else this.$cart_container.css("display","flex"),this.$customer_section.css({height:"","padding-top":""}),this.update_customer_section()}render_customer_fields(){let e=this.$customer_section.find(".customer-fields-container"),t=[{fieldname:"email_id",label:__("Email"),fieldtype:"Data",options:"email",placeholder:__("Enter customer's email")},{fieldname:"mobile_no",label:__("Phone Number"),fieldtype:"Data",placeholder:__("Enter customer's phone number")},{fieldname:"loyalty_program",label:__("Loyalty Program"),fieldtype:"Link",options:"Loyalty Program",placeholder:__("Select Loyalty Program")},{fieldname:"loyalty_points",label:__("Loyalty Points"),fieldtype:"Data",read_only:1}],i=this;t.forEach(n=>{this[`customer_${n.fieldname}_field`]=frappe.ui.form.make_control({df:h(m({},n),{onchange:s}),parent:e.find(`.${n.fieldname}-field`),render_input:!0}),this[`customer_${n.fieldname}_field`].set_value(this.customer_info[n.fieldname])});function s(){let n=i.customer_info[this.df.fieldname],a=i.customer_info.customer;this.value&&n!=this.value&&this.df.fieldname!="loyalty_points"&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.set_customer_info",args:{fieldname:this.df.fieldname,customer:a,value:this.value},callback:o=>{o.exc||(i.customer_info[this.df.fieldname]=this.value,frappe.show_alert({message:__("Customer contact updated successfully."),indicator:"green"}),frappe.utils.play_sound("submit"))}})}}fetch_customer_transactions(){frappe.db.get_list("POS Invoice",{filters:{customer:this.customer_info.customer,docstatus:1},fields:["name","grand_total","status","posting_date","posting_time","currency"],limit:20}).then(e=>{let t=this.$customer_section.find(".customer-transactions");if(!e.length){t.html('<div class="no-transactions-placeholder">No recent transactions found</div>');return}let i=moment(e[0].posting_date+" "+e[0].posting_time).fromNow();this.$customer_section.find(".customer-desc").html(`Last transacted ${i}`),e.forEach(s=>{let n=moment(s.posting_date+" "+s.posting_time).format("Do MMMM, h:mma"),a={Paid:"green",Draft:"red",Return:"gray",Consolidated:"blue"};t.append(`<div class="invoice-wrapper" data-invoice-name="${escape(s.name)}">
						<div class="invoice-name-date">
							<div class="invoice-name">${s.name}</div>
							<div class="invoice-date">${n}</div>
						</div>
						<div class="invoice-total-status">
							<div class="invoice-total">
								${format_currency(s.grand_total,s.currency,0)||0}
							</div>
							<div class="invoice-status">
								<span class="indicator-pill whitespace-nowrap ${a[s.status]}">
									<span>${s.status}</span>
								</span>
							</div>
						</div>
					</div>
					<div class="seperator"></div>`)})})}attach_refresh_field_event(e){$(e.wrapper).off("refresh-fields"),$(e.wrapper).on("refresh-fields",()=>{e.doc.items.length&&(this.$cart_items_wrapper.html(""),e.doc.items.forEach(t=>{this.update_item_html(t)})),this.update_totals_section(e)})}load_invoice(){let e=this.events.get_frm();this.attach_refresh_field_event(e),this.fetch_customer_details(e.doc.customer).then(()=>{this.events.customer_details_updated(this.customer_info),this.update_customer_section()}),this.$cart_items_wrapper.html(""),e.doc.items.length?e.doc.items.forEach(t=>{this.update_item_html(t)}):(this.make_no_items_placeholder(),this.highlight_checkout_btn(!1)),this.hide_discount_control(e.doc.additional_discount_percentage),this.update_totals_section(e),e.doc.docstatus===1?(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")),this.toggle_component(!0)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};erpnext.PointOfSale.ItemDetails=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.hide_images=i.hide_images,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.current_item={},this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="item-details-container"></section>'),this.$component=this.wrapper.find(".item-details-container")}init_child_components(){this.$component.html(`<div class="item-details-header">
				<div class="label">${__("Item Details")}</div>
				<div class="close-btn">
					<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
						<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
					</svg>
				</div>
			</div>
			<div class="item-display">
				<div class="item-name-desc-price">
					<div class="item-name"></div>
					<div class="item-desc"></div>
					<div class="item-price"></div>
				</div>
				<div class="item-image"></div>
			</div>
			<div class="discount-section"></div>
			<div class="form-container"></div>
			<div class="serial-batch-container"></div>`),this.$item_name=this.$component.find(".item-name"),this.$item_description=this.$component.find(".item-desc"),this.$item_price=this.$component.find(".item-price"),this.$item_image=this.$component.find(".item-image"),this.$form_container=this.$component.find(".form-container"),this.$dicount_section=this.$component.find(".discount-section"),this.$serial_batch_container=this.$component.find(".serial-batch-container")}compare_with_current_item(e){return e&&e.name==this.current_item.name}async toggle_item_details_section(e){let t=!this.compare_with_current_item(e),i=!Boolean(e)||!t;(!i&&t||i)&&await this.validate_serial_batch_item(),this.events.toggle_item_selector(!i),this.toggle_component(!i),e&&t?(this.doctype=e.doctype,this.item_meta=frappe.get_meta(this.doctype),this.name=e.name,this.item_row=e,this.currency=this.events.get_frm().doc.currency,this.current_item=e,this.render_dom(e),this.render_discount_dom(e),this.render_form(e),this.events.highlight_cart_item(e)):this.current_item={}}validate_serial_batch_item(){let t=this.events.get_frm().doc.items.find(a=>a.name===this.name);if(!t)return;let i=t.has_serial_no,s=t.has_batch_no,n=!t.serial_and_batch_bundle&&!t.serial_no&&!t.batch_no;if(i&&n||s&&n)return frappe.show_alert({message:__("Item is removed since no serial / batch no selected."),indicator:"orange"}),frappe.utils.play_sound("cancel"),this.events.remove_item_from_cart()}render_dom(e){let{item_name:t,description:i,image:s,price_list_rate:n}=e;function a(){return i?(i=i.indexOf("...")===-1&&i.length>140?i.substr(0,139)+"...":i,i):""}this.$item_name.html(t),this.$item_description.html(a()),this.$item_price.html(format_currency(n,this.currency)),!this.hide_images&&s?this.$item_image.html(`<img
					onerror="cur_pos.item_details.handle_broken_image(this)"
					class="h-full" src="${s}"
					alt="${frappe.get_abbr(t)}"
					style="object-fit: cover;">`):this.$item_image.html(`<div class="item-abbr">${frappe.get_abbr(t)}</div>`)}handle_broken_image(e){let t=$(e).attr("alt");$(e).replaceWith(`<div class="item-abbr">${t}</div>`)}render_discount_dom(e){e.discount_percentage?(this.$dicount_section.html(`<div class="item-rate">${format_currency(e.price_list_rate,this.currency)}</div>
				<div class="item-discount">${e.discount_percentage}% off</div>`),this.$item_price.html(format_currency(e.rate,this.currency))):this.$dicount_section.html("")}render_form(e){let t=this.get_form_fields(e);this.$form_container.html(""),t.forEach((i,s)=>{this.$form_container.append(`<div class="${i}-control" data-fieldname="${i}"></div>`);let n=this.item_meta.fields.find(o=>o.fieldname===i);i==="discount_percentage"&&(n.label=__("Discount (%)"));let a=this;this[`${i}_control`]=frappe.ui.form.make_control({df:h(m({},n),{onchange:function(){a.events.form_updated(a.current_item,i,this.value)}}),parent:this.$form_container.find(`.${i}-control`),render_input:!0}),this[`${i}_control`].set_value(e[i])}),this.make_auto_serial_selection_btn(e),this.bind_custom_control_change_event()}get_form_fields(e){let t=["qty","uom","rate","conversion_factor","discount_percentage","warehouse","actual_qty","price_list_rate"];return e.has_serial_no&&t.push("serial_no"),e.has_batch_no&&t.push("batch_no"),t}make_auto_serial_selection_btn(e){if(e.has_serial_no||e.has_batch_no){let t=e.has_serial_no?__("Select Serial No"):__("Select Batch No");this.$form_container.append(`<div class="btn btn-sm btn-secondary auto-fetch-btn">${t}</div>`),this.$form_container.find(".serial_no-control").find("textarea").css("height","6rem")}}bind_custom_control_change_event(){let e=this;this.rate_control&&(this.rate_control.df.onchange=function(){(this.value||flt(this.value)===0)&&e.events.form_updated(e.current_item,"rate",this.value).then(()=>{let t=frappe.get_doc(e.doctype,e.name),i=e.events.get_frm().doc;e.$item_price.html(format_currency(t.rate,i.currency)),e.render_discount_dom(t)})},this.rate_control.df.read_only=!this.allow_rate_change,this.rate_control.refresh()),this.discount_percentage_control&&!this.allow_discount_change&&(this.discount_percentage_control.df.read_only=1,this.discount_percentage_control.refresh()),this.warehouse_control&&(this.warehouse_control.df.reqd=1,this.warehouse_control.df.onchange=function(){this.value&&e.events.form_updated(e.current_item,"warehouse",this.value).then(()=>{e.item_stock_map=e.events.get_item_stock_map();let t=e.item_stock_map[e.item_row.item_code][this.value][0],i=Boolean(e.item_stock_map[e.item_row.item_code][this.value][1]);if(t===void 0)e.events.get_available_stock(e.item_row.item_code,this.value).then(()=>{e.warehouse_control.set_value(this.value)});else if(t===0&&i){e.warehouse_control.set_value("");let s=e.item_row.item_code.bold(),n=this.value.bold();frappe.throw(__("Item Code: {0} is not available under warehouse {1}.",[s,n]))}e.actual_qty_control.set_value(t)})},this.warehouse_control.df.get_query=()=>({filters:{company:this.events.get_frm().doc.company,is_group:0}}),this.warehouse_control.refresh()),this.serial_no_control&&(this.serial_no_control.df.reqd=1,this.serial_no_control.df.onchange=async function(){!e.current_item.batch_no&&await e.auto_update_batch_no(),e.events.form_updated(e.current_item,"serial_no",this.value)},this.serial_no_control.refresh()),this.batch_no_control&&(this.batch_no_control.df.reqd=1,this.batch_no_control.df.get_query=()=>({query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:e.item_row.item_code,warehouse:e.item_row.warehouse,posting_date:e.events.get_frm().doc.posting_date}}),this.batch_no_control.refresh()),this.uom_control&&(this.uom_control.df.onchange=function(){e.events.form_updated(e.current_item,"uom",this.value);let t=frappe.get_doc(e.doctype,e.name);e.conversion_factor_control.df.read_only=t.stock_uom==this.value,e.conversion_factor_control.refresh()}),frappe.model.on("POS Invoice Item","*",(t,i,s)=>{let n=this[`${t}_control`];this.compare_with_current_item(s)&&n&&n.get_value()!==i&&(n.set_value(i),cur_pos.update_cart_html(s))})}async auto_update_batch_no(){if(this.serial_no_control&&this.batch_no_control){let e=this.serial_no_control.get_value().split(`
`).filter(r=>r);if(!e.length)return;let i=(await frappe.db.get_list("Serial No",{filters:{name:["in",e]},fields:["batch_no","name"]})).reduce((r,c)=>(r[c.batch_no]||(r[c.batch_no]=[]),r[c.batch_no]=[...r[c.batch_no],c.name],r),{}),s=Object.keys(i)[0],n=i[s].join(`
`),a=e.length!==i[s].length;this.batch_no_control.get_value()!=s&&await this.batch_no_control.set_value(s),a&&(this.serial_no_control.set_value(n),this.qty_control.set_value(i[s].length),delete i[s],this.events.clone_new_batch_item_in_frm(i,this.current_item))}}bind_events(){this.bind_auto_serial_fetch_event(),this.bind_fields_to_numpad_fields(),this.$component.on("click",".close-btn",()=>{this.events.close_item_details()})}attach_shortcuts(){this.wrapper.find(".close-btn").attr("title","Esc"),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.events.close_item_details()})}bind_fields_to_numpad_fields(){let e=this;this.$form_container.on("click",".input-with-feedback",function(){let t=$(this).attr("data-fieldname");this.last_field_focused!=t&&(e.events.item_field_focused(t),this.last_field_focused=t)})}bind_auto_serial_fetch_event(){this.$form_container.on("click",".auto-fetch-btn",()=>{let e=this.events.get_frm(),t=this.item_row;t.type_of_transaction="Outward",new erpnext.SerialBatchPackageSelector(e,t,i=>{i&&frappe.model.set_value(t.doctype,t.name,{serial_and_batch_bundle:i.name,qty:Math.abs(i.total_qty),use_serial_batch_fields:0})})})}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};erpnext.PointOfSale.NumberPad=class{constructor({wrapper:e,events:t,cols:i,keys:s,css_classes:n,fieldnames_map:a}){this.wrapper=e,this.events=t,this.cols=i,this.keys=s,this.css_classes=n||[],this.fieldnames=a||{},this.init_component()}init_component(){this.prepare_dom(),this.bind_events()}prepare_dom(){let{cols:e,keys:t,css_classes:i,fieldnames:s}=this;function n(){return t.reduce((a,o,r)=>a+o.reduce((c,_,l)=>{let d=i&&i[r]?i[r][l]:"",p=s&&s[_]?s[_]:typeof _=="string"?frappe.scrub(_):_;return c+`<div class="numpad-btn ${d}" data-button-value="${p}">${__(_)}</div>`},""),"")}this.wrapper.html(`<div class="numpad-container">
				${n()}
			</div>`)}bind_events(){let e=this;this.wrapper.on("click",".numpad-btn",function(){let t=$(this);e.events.numpad_event(t)})}};erpnext.PointOfSale.Payment=class{constructor({events:e,wrapper:t}){this.wrapper=t,this.events=e,this.init_component()}init_component(){this.prepare_dom(),this.initialize_numpad(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="payment-container">
				<div class="section-label payment-section">${__("Payment Method")}</div>
				<div class="payment-modes"></div>
				<div class="fields-numpad-container">
					<div class="fields-section">
						<div class="section-label">${__("Additional Information")}</div>
						<div class="invoice-fields"></div>
					</div>
					<div class="number-pad"></div>
				</div>
				<div class="totals-section">
					<div class="totals"></div>
				</div>
				<div class="submit-order-btn">${__("Complete Order")}</div>
			</section>`),this.$component=this.wrapper.find(".payment-container"),this.$payment_modes=this.$component.find(".payment-modes"),this.$totals_section=this.$component.find(".totals-section"),this.$totals=this.$component.find(".totals"),this.$numpad=this.$component.find(".number-pad"),this.$invoice_fields_section=this.$component.find(".fields-section")}make_invoice_fields_control(){frappe.db.get_doc("POS Settings",void 0).then(e=>{let t=e.invoice_fields;if(!t.length)return;this.$invoice_fields=this.$invoice_fields_section.find(".invoice-fields"),this.$invoice_fields.html("");let i=this.events.get_frm();t.forEach(s=>{this.$invoice_fields.append(`<div class="invoice_detail_field ${s.fieldname}-field" data-fieldname="${s.fieldname}"></div>`);let n={onchange:function(){i.set_value(this.df.fieldname,this.get_value())}};s.fieldtype=="Button"&&(n={click:function(){i.script_manager.has_handlers(s.fieldname,i.doc.doctype)&&i.script_manager.trigger(s.fieldname,i.doc.doctype,i.doc.docname)}}),this[`${s.fieldname}_field`]=frappe.ui.form.make_control({df:m(m({},s),n),parent:this.$invoice_fields.find(`.${s.fieldname}-field`),render_input:!0}),this[`${s.fieldname}_field`].set_value(i.doc[s.fieldname])})})}initialize_numpad(){let e=this;this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad,events:{numpad_event:function(t){e.on_numpad_clicked(t)}},cols:3,keys:[[1,2,3],[4,5,6],[7,8,9],[".",0,"Delete"]]}),this.numpad_value=""}on_numpad_clicked(e){let t=e.attr("data-button-value");i(e),this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.selected_mode.$input.get(0).focus(),this.selected_mode.set_value(this.numpad_value);function i(s){s.addClass("shadow-base-inner bg-selected"),setTimeout(()=>{s.removeClass("shadow-base-inner bg-selected")},100)}}bind_events(){let e=this;this.$payment_modes.on("click",".mode-of-payment",function(t){let i=$(this);if(!$(t.target).is(i))return;let s=i.offset().left-e.$payment_modes.offset().left+e.$payment_modes.scrollLeft();e.$payment_modes.animate({scrollLeft:s});let n=i.attr("data-mode");$(".mode-of-payment-control").css("display","none"),$(".cash-shortcuts").css("display","none"),e.$payment_modes.find(".pay-amount").css("display","inline"),e.$payment_modes.find(".loyalty-amount-name").css("display","none"),$(".mode-of-payment").removeClass("border-primary"),i.hasClass("border-primary")?(i.removeClass("border-primary"),e.selected_mode=""):(i.addClass("border-primary"),i.find(".mode-of-payment-control").css("display","flex"),i.find(".cash-shortcuts").css("display","grid"),e.$payment_modes.find(`.${n}-amount`).css("display","none"),e.$payment_modes.find(`.${n}-name`).css("display","inline"),e.selected_mode=e[`${n}_control`],e.selected_mode&&e.selected_mode.$input.get(0).focus(),e.auto_set_remaining_amount())}),frappe.ui.form.on("POS Invoice","contact_mobile",t=>{var n;let i=t.doc.contact_mobile,s=$((n=this.request_for_payment_field)==null?void 0:n.$input[0]);i?s.removeClass("btn-default").addClass("btn-primary"):s.removeClass("btn-primary").addClass("btn-default")}),frappe.ui.form.on("POS Invoice","coupon_code",t=>{t.doc.coupon_code&&!t.applying_pos_coupon_code&&(t.doc.ignore_pricing_rule?t.doc.ignore_pricing_rule&&frappe.show_alert({message:__("Ignore Pricing Rule is enabled. Cannot apply coupon code."),indicator:"orange"}):(t.applying_pos_coupon_code=!0,frappe.run_serially([()=>t.doc.ignore_pricing_rule=1,()=>t.trigger("ignore_pricing_rule"),()=>t.doc.ignore_pricing_rule=0,()=>t.trigger("apply_pricing_rule"),()=>t.save(),()=>this.update_totals_section(t.doc),()=>t.applying_pos_coupon_code=!1])))}),this.setup_listener_for_payments(),this.$payment_modes.on("click",".shortcut",function(){let t=$(this).attr("data-value");e.selected_mode.set_value(t)}),this.$component.on("click",".submit-order-btn",()=>{let t=this.events.get_frm().doc,i=t.paid_amount,s=t.items;if(i==0||!s.length){let n=s.length?__("You cannot submit the order without payment."):__("You cannot submit empty order.");frappe.show_alert({message:n,indicator:"orange"}),frappe.utils.play_sound("error");return}this.events.submit_invoice()}),frappe.ui.form.on("POS Invoice","paid_amount",t=>{this.update_totals_section(t.doc);let i=!this.$payment_modes.find(".cash-shortcuts").is(":visible");this.attach_cash_shortcuts(t.doc),!i&&this.$payment_modes.find(".cash-shortcuts").css("display","grid"),this.render_payment_mode_dom()}),frappe.ui.form.on("POS Invoice","loyalty_amount",t=>{let i=format_currency(t.doc.loyalty_amount,t.doc.currency);this.$payment_modes.find(".loyalty-amount-amount").html(i)}),frappe.ui.form.on("Sales Invoice Payment","amount",(t,i,s)=>{let n=locals[i][s],a=n.mode_of_payment.replace(/ +/g,"_").toLowerCase();this[`${a}_control`]&&this[`${a}_control`].get_value()!=n.amount&&this[`${a}_control`].set_value(n.amount)})}setup_listener_for_payments(){frappe.realtime.on("process_phone_payment",e=>{let t=this.events.get_frm().doc,{response:i,amount:s,success:n,failure_message:a}=e,o,r;if(n){r=__("Payment Received");let c=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total;s>=c?(frappe.dom.unfreeze(),o=__("Payment of {0} received successfully.",[format_currency(s,t.currency,0)]),this.events.submit_invoice(),cur_frm.reload_doc()):o=__("Payment of {0} received successfully. Waiting for other requests to complete...",[format_currency(s,t.currency,0)])}else a&&(o=a,r=__("Payment Failed"));frappe.msgprint({message:o,title:r})})}auto_set_remaining_amount(){let e=this.events.get_frm().doc,i=(cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total)-e.paid_amount;!(this.selected_mode?this.selected_mode.get_value():void 0)&&i>0&&this.selected_mode&&this.selected_mode.set_value(i)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".submit-order-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");t&&i.length&&this.$component.find(".submit-order-btn").click()}),frappe.ui.keys.add_shortcut({shortcut:"tab",action:()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");if(i=i.length?i.attr("data-mode"):void 0,!i)return;let s=Array.from(this.$payment_modes.find(".mode-of-payment")).map(r=>$(r).attr("data-mode")),n=s.indexOf(i),a=(n+1)%s.length,o=this.$payment_modes.find(`.mode-of-payment[data-mode="${s[a]}"]`);t&&n!=a&&o.click()},condition:()=>this.$component.is(":visible")&&this.$payment_modes.find(".border-primary").length,description:__("Switch Between Payment Modes"),ignore_inputs:!0,page:cur_page.page.page})}toggle_numpad(){}render_payment_section(){this.render_payment_mode_dom(),this.make_invoice_fields_control(),this.update_totals_section(),this.focus_on_default_mop()}after_render(){let e=this.events.get_frm();e.script_manager.trigger("after_payment_render",e.doc.doctype,e.doc.docname)}edit_cart(){this.events.toggle_other_sections(!1),this.toggle_component(!1)}checkout(){let e=this.events.get_frm();e.cscript.calculate_outstanding_amount(),e.refresh_field("outstanding_amount"),e.refresh_field("paid_amount"),e.refresh_field("base_paid_amount"),this.events.toggle_other_sections(!0),this.toggle_component(!0),this.render_payment_section(),this.after_render()}toggle_remarks_control(){this.$remarks.find(".frappe-control").length?this.$remarks.html("+ Add Remark"):(this.$remarks.html(""),this.remark_control=frappe.ui.form.make_control({df:{label:__("Remark"),fieldtype:"Data",onchange:function(){}},parent:this.$totals_section.find(".remarks"),render_input:!0}),this.remark_control.set_value(""))}render_payment_mode_dom(){let e=this.events.get_frm().doc,t=e.payments,i=e.currency;this.$payment_modes.html(`${t.map((s,n)=>{let a=s.mode_of_payment.replace(/ +/g,"_").toLowerCase(),o=s.type,r=n%2===0?"pr-2":"pl-2",c=s.amount>0?format_currency(s.amount,i):"";return`
					<div class="payment-mode-wrapper">
						<div class="mode-of-payment" data-mode="${a}" data-payment-type="${o}">
							${s.mode_of_payment}
							<div class="${a}-amount pay-amount">${c}</div>
							<div class="${a} mode-of-payment-control"></div>
						</div>
					</div>
				`}).join("")}`),t.forEach(s=>{let n=s.mode_of_payment.replace(/ +/g,"_").toLowerCase(),a=this;this[`${n}_control`]=frappe.ui.form.make_control({df:{label:s.mode_of_payment,fieldtype:"Currency",placeholder:__("Enter {0} amount.",[s.mode_of_payment]),onchange:function(){if(frappe.model.get_value(s.doctype,s.name,"amount")!=this.value){frappe.model.set_value(s.doctype,s.name,"amount",flt(this.value)).then(()=>a.update_totals_section());let r=format_currency(this.value,i);a.$payment_modes.find(`.${n}-amount`).html(r)}}},parent:this.$payment_modes.find(`.${n}.mode-of-payment-control`),render_input:!0}),this[`${n}_control`].toggle_label(!1),this[`${n}_control`].set_value(s.amount)}),this.render_loyalty_points_payment_mode(),this.attach_cash_shortcuts(e)}focus_on_default_mop(){this.events.get_frm().doc.payments.forEach(i=>{let s=i.mode_of_payment.replace(/ +/g,"_").toLowerCase();i.default&&setTimeout(()=>{this.$payment_modes.find(`.${s}.mode-of-payment-control`).parent().click()},500)})}attach_cash_shortcuts(e){let t=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,i=e.currency,s=this.get_cash_shortcuts(flt(t));this.$payment_modes.find(".cash-shortcuts").remove();let n=s.map(a=>`<div class="shortcut" data-value="${a}">${format_currency(a,i,0)}</div>`).join("");this.$payment_modes.find('[data-payment-type="Cash"]').find(".mode-of-payment-control").after(`<div class="cash-shortcuts">${n}</div>`)}get_cash_shortcuts(e){let t=[1,5,10],i=String(Math.round(e)).length;t=t.map(n=>n*10**(i-2));let s=(n,a)=>{let o=Math.ceil(n/a)*a;return o===n?o+a:o};return t.reduce((n,a)=>{let o=s(e,a);return o=n.indexOf(o)!=-1?o+a:o,[...n,o]},[])}render_loyalty_points_payment_mode(){let e=this,t=this.events.get_frm().doc,{loyalty_program:i,loyalty_points:s,conversion_factor:n}=this.events.get_customer_details();if(this.$payment_modes.find('.mode-of-payment[data-mode="loyalty-amount"]').parent().remove(),!i)return;let a,o,r;s?(r=flt(flt(s)*flt(n),precision("loyalty_amount",t)),a=__("You can redeem upto {0}.",[format_currency(r)]),o=!1):(a=__("You don't have enough points to redeem."),o=!0);let c=this.$payment_modes.children().length%2===0?"pr-2":"pl-2",_=t.loyalty_amount>0?format_currency(t.loyalty_amount,t.currency):"";this.$payment_modes.append(`<div class="payment-mode-wrapper">
				<div class="mode-of-payment loyalty-card" data-mode="loyalty-amount" data-payment-type="loyalty-amount">
					Redeem Loyalty Points
					<div class="loyalty-amount-amount pay-amount">${_}</div>
					<div class="loyalty-amount-name">${i}</div>
					<div class="loyalty-amount mode-of-payment-control"></div>
				</div>
			</div>`),this["loyalty-amount_control"]=frappe.ui.form.make_control({df:{label:__("Redeem Loyalty Points"),fieldtype:"Currency",placeholder:__("Enter amount to be redeemed."),options:"company:currency",read_only:o,onchange:async function(){if(!s)return;if(this.value>r){frappe.show_alert({message:__("You cannot redeem more than {0}.",[format_currency(r)]),indicator:"red"}),frappe.utils.play_sound("submit"),e["loyalty-amount_control"].set_value(0);return}let l=this.value>0?1:0;await frappe.model.set_value(t.doctype,t.name,"redeem_loyalty_points",l),frappe.model.set_value(t.doctype,t.name,"loyalty_points",parseInt(this.value/n))},description:a},parent:this.$payment_modes.find(".loyalty-amount.mode-of-payment-control"),render_input:!0}),this["loyalty-amount_control"].toggle_label(!1)}render_add_payment_method_dom(){this.events.get_frm().doc.docstatus===0&&this.$payment_modes.append(`<div class="w-full pr-2">
					<div class="add-mode-of-payment w-half text-grey mb-4 no-select pointer">+ Add Payment Method</div>
				</div>`)}update_totals_section(e){e||(e=this.events.get_frm().doc);let t=e.paid_amount,i=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,s=i-e.paid_amount,n=e.change_amount||s<=0?-1*s:void 0,a=e.currency,o=n?__("Change"):__("To Be Paid");this.$totals.html(`<div class="col">
				<div class="total-label">${__("Grand Total")}</div>
				<div class="value">${format_currency(i,a)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${__("Paid Amount")}</div>
				<div class="value">${format_currency(t,a)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${o}</div>
				<div class="value">${format_currency(n||s,a)}</div>
			</div>`)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};erpnext.PointOfSale.PastOrderList=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.init_component()}init_component(){this.prepare_dom(),this.make_filter_section(),this.bind_events()}prepare_dom(){this.wrapper.append(`<section class="past-order-list">
				<div class="filter-section">
					<div class="label">${__("Recent Orders")}</div>
					<div class="search-field"></div>
					<div class="status-field"></div>
				</div>
				<div class="invoices-container"></div>
			</section>`),this.$component=this.wrapper.find(".past-order-list"),this.$invoices_container=this.$component.find(".invoices-container")}bind_events(){this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.refresh_list(i,this.status_field.get_value())},300)});let e=this;this.$invoices_container.on("click",".invoice-wrapper",function(){let t=unescape($(this).attr("data-invoice-name"));e.events.open_invoice_data(t)})}make_filter_section(){let e=this;this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by invoice id or customer name")},parent:this.$component.find(".search-field"),render_input:!0}),this.status_field=frappe.ui.form.make_control({df:{label:__("Invoice Status"),fieldtype:"Select",options:`Draft
Paid
Consolidated
Return`,placeholder:__("Filter by invoice status"),onchange:function(){e.$component.is(":visible")&&e.refresh_list()}},parent:this.$component.find(".status-field"),render_input:!0}),this.search_field.toggle_label(!1),this.status_field.toggle_label(!1),this.status_field.set_value("Draft")}refresh_list(){frappe.dom.freeze(),this.events.reset_summary();let e=this.search_field.get_value(),t=this.status_field.get_value();return this.$invoices_container.html(""),frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.get_past_order_list",freeze:!0,args:{search_term:e,status:t},callback:i=>{frappe.dom.unfreeze(),i.message.forEach(s=>{let n=this.get_invoice_html(s);this.$invoices_container.append(n)})}})}get_invoice_html(e){let t=moment(e.posting_date+" "+e.posting_time).format("Do MMMM, h:mma");return`<div class="invoice-wrapper" data-invoice-name="${escape(e.name)}">
				<div class="invoice-name-date">
					<div class="invoice-name">${e.name}</div>
					<div class="invoice-date">
						<svg class="mr-2" width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
						</svg>
						${frappe.ellipsis(e.customer,20)}
					</div>
				</div>
				<div class="invoice-total-status">
					<div class="invoice-total">${format_currency(e.grand_total,e.currency,0)||0}</div>
					<div class="invoice-date">${t}</div>
				</div>
			</div>
			<div class="seperator"></div>`}toggle_component(e){e?this.$component.css("display","flex")&&this.refresh_list():this.$component.css("display","none")}};erpnext.PointOfSale.PastOrderSummary=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.init_component()}init_component(){this.prepare_dom(),this.init_email_print_dialog(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="past-order-summary">
				<div class="no-summary-placeholder">
					${__("Select an invoice to load summary data")}
				</div>
				<div class="invoice-summary-wrapper">
					<div class="abs-container">
						<div class="upper-section"></div>
						<div class="label">${__("Items")}</div>
						<div class="items-container summary-container"></div>
						<div class="label">${__("Totals")}</div>
						<div class="totals-container summary-container"></div>
						<div class="label">${__("Payments")}</div>
						<div class="payments-container summary-container"></div>
						<div class="summary-btns"></div>
					</div>
				</div>
			</section>`),this.$component=this.wrapper.find(".past-order-summary"),this.$summary_wrapper=this.$component.find(".invoice-summary-wrapper"),this.$summary_container=this.$component.find(".abs-container"),this.$upper_section=this.$summary_container.find(".upper-section"),this.$items_container=this.$summary_container.find(".items-container"),this.$totals_container=this.$summary_container.find(".totals-container"),this.$payment_container=this.$summary_container.find(".payments-container"),this.$summary_btns=this.$summary_container.find(".summary-btns")}init_email_print_dialog(){let e=new frappe.ui.Dialog({title:"Email Receipt",fields:[{fieldname:"email_id",fieldtype:"Data",options:"Email",label:"Email ID",reqd:1},{fieldname:"content",fieldtype:"Small Text",label:"Message (if any)"}],primary_action:()=>{this.send_email()},primary_action_label:__("Send")});this.email_dialog=e;let t=new frappe.ui.Dialog({title:"Print Receipt",fields:[{fieldname:"print",fieldtype:"Data",label:"Print Preview"}],primary_action:()=>{this.print_receipt()},primary_action_label:__("Print")});this.print_dialog=t}get_upper_section_html(e){let{status:t}=e,i="";return["Paid","Consolidated"].includes(t)&&(i="green"),t==="Draft"&&(i="red"),t==="Return"&&(i="grey"),`<div class="left-section">
					<div class="customer-name">${e.customer}</div>
					<div class="customer-email">${this.customer_email}</div>
					<div class="cashier">${__("Sold by")}: ${e.owner}</div>
				</div>
				<div class="right-section">
					<div class="paid-amount">${format_currency(e.paid_amount,e.currency)}</div>
					<div class="invoice-name">${e.name}</div>
					<span class="indicator-pill whitespace-nowrap ${i}"><span>${e.status}</span></span>
				</div>`}get_item_html(e,t){return`<div class="item-row-wrapper">
					<div class="item-name">${t.item_name}</div>
					<div class="item-qty">${t.qty||0} ${t.uom}</div>
					<div class="item-rate-disc">${i()}</div>
				</div>`;function i(){return t.rate&&t.price_list_rate&&t.rate!==t.price_list_rate?`<span class="item-disc">(${t.discount_percentage}% off)</span>
						<div class="item-rate">${format_currency(t.rate,e.currency)}</div>`:`<div class="item-rate">${format_currency(t.price_list_rate||t.rate,e.currency)}</div>`}}get_discount_html(e){return e.discount_amount?`<div class="summary-row-wrapper">
						<div>Discount (${e.additional_discount_percentage} %)</div>
						<div>${format_currency(e.discount_amount,e.currency)}</div>
					</div>`:""}get_net_total_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Net Total")}</div>
					<div>${format_currency(e.net_total,e.currency)}</div>
				</div>`}get_taxes_html(e){return e.taxes.length?`<div class="taxes-wrapper">${e.taxes.map(i=>`
				<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(i.description)?i.description:i.rate!=0?`${i.description} @ ${i.rate}%`:i.description}</div>
					<div class="tax-value">${format_currency(i.tax_amount_after_discount_amount,e.currency)}</div>
				</div>
			`).join("")}</div>`:""}get_grand_total_html(e){return`<div class="summary-row-wrapper grand-total">
					<div>${__("Grand Total")}</div>
					<div>${format_currency(e.grand_total,e.currency)}</div>
				</div>`}get_payment_html(e,t){return`<div class="summary-row-wrapper payments">
					<div>${__(t.mode_of_payment)}</div>
					<div>${format_currency(t.amount,e.currency)}</div>
				</div>`}bind_events(){this.$summary_container.on("click",".return-btn",()=>{this.events.process_return(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".edit-btn",()=>{this.events.edit_order(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".new-btn",()=>{this.events.new_order(),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".email-btn",()=>{this.email_dialog.fields_dict.email_id.set_value(this.customer_email),this.email_dialog.show()}),this.$summary_container.on("click",".print-btn",()=>{this.print_receipt()})}print_receipt(){let e=this.events.get_frm();frappe.utils.print(this.doc.doctype,this.doc.name,e.pos_print_format,this.doc.letter_head,this.doc.language||frappe.boot.lang)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$summary_container.find(".print-btn").attr("title",`${e}+P`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:()=>this.$summary_container.find(".print-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".print-btn").is(":visible"),description:__("Print Receipt"),page:cur_page.page.page}),this.$summary_container.find(".new-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{this.$component.is(":visible")&&this.$summary_container.find(".new-btn").is(":visible")&&this.$summary_container.find(".new-btn").click()}),this.$summary_container.find(".edit-btn").attr("title",`${e}+E`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Receipt"),page:cur_page.page.page})}send_email(){let e=this.events.get_frm(),t=this.email_dialog.get_values().email_id,i=this.email_dialog.get_values().content,s=this.doc||e.doc,n=e.pos_print_format;frappe.call({method:"frappe.core.doctype.communication.email.make",args:{recipients:t,subject:__(e.meta.name)+": "+s.name,content:i||__(e.meta.name)+": "+s.name,doctype:s.doctype,name:s.name,send_email:1,print_format:n,sender_full_name:frappe.user.full_name(),_lang:s.language},callback:a=>{a.exc?frappe.msgprint(__("There were errors while sending email. Please try again.")):(frappe.utils.play_sound("email"),a.message.emails_not_sent_to?frappe.msgprint(__("Email not sent to {0} (unsubscribed / disabled)",[frappe.utils.escape_html(a.message.emails_not_sent_to)])):frappe.show_alert({message:__("Email sent successfully."),indicator:"green"}),this.email_dialog.hide())}})}add_summary_btns(e){this.$summary_btns.html(""),e.forEach(t=>{t.condition&&t.visible_btns.forEach(i=>{let s=i.split(" ")[0].toLowerCase(),n=__(i);this.$summary_btns.append(`<div class="summary-btn btn btn-default ${s}-btn">${n}</div>`)})}),this.$summary_btns.children().last().removeClass("mr-4")}toggle_summary_placeholder(e){e?(this.$summary_wrapper.css("display","none"),this.$component.find(".no-summary-placeholder").css("display","flex")):(this.$summary_wrapper.css("display","flex"),this.$component.find(".no-summary-placeholder").css("display","none"))}get_condition_btn_map(e){return e?[{condition:!0,visible_btns:["Print Receipt","Email Receipt","New Order"]}]:[{condition:this.doc.docstatus===0,visible_btns:["Edit Order","Delete Order"]},{condition:!this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt","Return"]},{condition:this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt"]}]}load_summary_of(e,t=!1){t?this.$component.css("grid-column","span 10 / span 10"):this.$component.css("grid-column","span 6 / span 6"),this.toggle_summary_placeholder(!1),this.doc=e,this.attach_document_info(e),this.attach_items_info(e),this.attach_totals_info(e),this.attach_payments_info(e);let i=this.get_condition_btn_map(t);this.add_summary_btns(i)}attach_document_info(e){frappe.db.get_value("Customer",this.doc.customer,"email_id").then(({message:t})=>{this.customer_email=t.email_id||"";let i=this.get_upper_section_html(e);this.$upper_section.html(i)})}attach_items_info(e){this.$items_container.html(""),e.items.forEach(t=>{let i=this.get_item_html(e,t);this.$items_container.append(i),this.set_dynamic_rate_header_width()})}set_dynamic_rate_header_width(){let e=Array.from(this.$items_container.find(".item-rate-disc"));this.$items_container.find(".item-rate-disc").css("width","");let t=e.reduce((i,s)=>($(s).width()>i&&(i=$(s).width()),i),0);t+=1,t==1&&(t=""),this.$items_container.find(".item-rate-disc").css("width",t)}attach_payments_info(e){if(this.$payment_container.html(""),e.payments.forEach(t=>{if(t.amount){let i=this.get_payment_html(e,t);this.$payment_container.append(i)}}),e.redeem_loyalty_points&&e.loyalty_amount){let t=this.get_payment_html(e,{mode_of_payment:"Loyalty Points",amount:e.loyalty_amount});this.$payment_container.append(t)}}attach_totals_info(e){this.$totals_container.html("");let t=this.get_net_total_html(e),i=this.get_taxes_html(e),s=this.get_discount_html(e),n=this.get_grand_total_html(e);this.$totals_container.append(t),this.$totals_container.append(i),this.$totals_container.append(s),this.$totals_container.append(n)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};erpnext.PointOfSale.Controller=class{constructor(e){this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.check_opening_entry()}fetch_opening_entry(){return frappe.call("erpnext.selling.page.point_of_sale.point_of_sale.check_opening_entry",{user:frappe.session.user})}check_opening_entry(){this.fetch_opening_entry().then(e=>{e.message.length?this.prepare_app_defaults(e.message[0]):this.create_opening_voucher()})}create_opening_voucher(){let e=this,t=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){s.fields_dict.balance_details.df.data.some(a=>{if(a.idx==this.doc.idx)return a.opening_amount=this.value,s.fields_dict.balance_details.grid.refresh(),!0})}}],i=()=>{let a=s.fields_dict.pos_profile.get_value();!a||frappe.db.get_doc("POS Profile",a).then(({payments:o})=>{s.fields_dict.balance_details.df.data=[],o.forEach(r=>{let{mode_of_payment:c}=r;s.fields_dict.balance_details.df.data.push({mode_of_payment:c,opening_amount:"0"})}),s.fields_dict.balance_details.grid.refresh()})},s=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>n(),onchange:()=>i()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:t}],primary_action:async function({company:a,pos_profile:o,balance_details:r}){if(!r.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");r=r.filter(l=>l.mode_of_payment);let c="erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher",_=await frappe.call({method:c,args:{pos_profile:o,company:a,balance_details:r},freeze:!0});!_.exc&&e.prepare_app_defaults(_.message),s.hide()},primary_action_label:__("Submit")});s.show();let n=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:s.fields_dict.company.get_value()}})}async prepare_app_defaults(e){this.pos_opening=e.name,this.company=e.company,this.pos_profile=e.pos_profile,this.pos_opening_time=e.period_start_date,this.item_stock_map={},this.settings={},frappe.db.get_value("Stock Settings",void 0,"allow_negative_stock").then(({message:t})=>{this.allow_negative_stock=flt(t.allow_negative_stock)||!1}),frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.get_pos_profile_data",args:{pos_profile:this.pos_profile},callback:t=>{let i=t.message;Object.assign(this.settings,i),this.settings.customer_groups=i.customer_groups.map(s=>s.name),this.make_app()}})}set_opening_entry_status(){this.page.set_title_sub(`<span class="indicator orange">
				<a class="text-muted" href="#Form/POS%20Opening%20Entry/${this.pos_opening}">
					Opened at ${moment(this.pos_opening_time).format("Do MMMM, h:mma")}
				</a>
			</span>`)}make_app(){this.prepare_dom(),this.prepare_components(),this.prepare_menu(),this.make_new_invoice()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_components(){this.init_item_selector(),this.init_item_details(),this.init_item_cart(),this.init_payments(),this.init_recent_order_list(),this.init_order_summary()}prepare_menu(){this.page.clear_menu(),this.page.add_menu_item(__("Open Form View"),this.open_form_view.bind(this),!1,"Ctrl+F"),this.page.add_menu_item(__("Toggle Recent Orders"),this.toggle_recent_order.bind(this),!1,"Ctrl+O"),this.page.add_menu_item(__("Save as Draft"),this.save_draft_invoice.bind(this),!1,"Ctrl+S"),this.page.add_menu_item(__("Close the POS"),this.close_pos.bind(this),!1,"Shift+Ctrl+C")}open_form_view(){frappe.model.sync(this.frm.doc),frappe.set_route("Form",this.frm.doc.doctype,this.frm.doc.name)}toggle_recent_order(){let e=this.recent_order_list.$component.is(":hidden");this.toggle_recent_order_list(e)}save_draft_invoice(){if(!!this.$components_wrapper.is(":visible")){if(this.frm.doc.items.length==0){frappe.show_alert({message:__("You must add atleast one item to save it as draft."),indicator:"red"}),frappe.utils.play_sound("error");return}this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error")}).then(()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>frappe.dom.unfreeze()])})}}close_pos(){if(!this.$components_wrapper.is(":visible"))return;let e=frappe.model.get_new_doc("POS Closing Entry");e.pos_profile=this.frm.doc.pos_profile,e.user=frappe.session.user,e.company=this.frm.doc.company,e.pos_opening_entry=this.pos_opening,e.period_end_date=frappe.datetime.now_datetime(),e.posting_date=frappe.datetime.now_date(),e.posting_time=frappe.datetime.now_time(),frappe.set_route("Form","POS Closing Entry",e.name)}init_item_selector(){this.item_selector=new erpnext.PointOfSale.ItemSelector({wrapper:this.$components_wrapper,pos_profile:this.pos_profile,settings:this.settings,events:{item_selected:e=>this.on_cart_update(e),get_frm:()=>this.frm||{}}})}init_item_cart(){this.cart=new erpnext.PointOfSale.ItemCart({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,cart_item_clicked:e=>{let t=this.get_item_from_frm(e);this.item_details.toggle_item_details_section(t)},numpad_event:(e,t)=>this.update_item_field(e,t),checkout:()=>this.save_and_checkout(),edit_cart:()=>this.payment.edit_cart(),customer_details_updated:e=>{this.customer_details=e,this.payment.render_loyalty_points_payment_mode()}}})}init_item_details(){this.item_details=new erpnext.PointOfSale.ItemDetails({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,toggle_item_selector:e=>{this.item_selector.resize_selector(e),this.cart.toggle_numpad(e)},form_updated:(e,t,i)=>{let s=frappe.model.get_doc(e.doctype,e.name);if(s&&s[t]!=i){let n={field:t,value:i,item:this.item_details.current_item};return this.on_cart_update(n)}return Promise.resolve()},highlight_cart_item:e=>{let t=this.cart.get_cart_item(e);this.cart.toggle_item_highlight(t)},item_field_focused:e=>{this.cart.toggle_numpad_field_edit(e)},set_value_in_current_cart_item:(e,t)=>{this.cart.update_selector_value_in_cart_item(e,t,this.item_details.current_item)},clone_new_batch_item_in_frm:(e,t)=>{Object.keys(e).forEach(i=>{let s=this.frm.doc.items.find(a=>a.name==t.name),n=this.frm.add_child("items",m({},s));n.batch_no=i,n.serial_no=e[i].join(`
`),n.qty=e[i].length,this.frm.doc.items.forEach(a=>{t.item_code===a.item_code&&this.update_cart_html(a)})})},remove_item_from_cart:()=>this.remove_item_from_cart(),get_item_stock_map:()=>this.item_stock_map,close_item_details:()=>{this.item_details.toggle_item_details_section(null),this.cart.prev_action=null,this.cart.toggle_item_highlight()},get_available_stock:(e,t)=>this.get_available_stock(e,t)}})}init_payments(){this.payment=new erpnext.PointOfSale.Payment({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm||{},get_customer_details:()=>this.customer_details||{},toggle_other_sections:e=>{e?(this.item_details.$component.is(":visible")&&this.item_details.$component.css("display","none"),this.item_selector.toggle_component(!1)):this.item_selector.toggle_component(!0)},submit_invoice:()=>{this.frm.savesubmit().then(e=>{this.toggle_components(!1),this.order_summary.toggle_component(!0),this.order_summary.load_summary_of(this.frm.doc,!0),frappe.show_alert({indicator:"green",message:__("POS invoice {0} created succesfully",[e.doc.name])})})}}})}init_recent_order_list(){this.recent_order_list=new erpnext.PointOfSale.PastOrderList({wrapper:this.$components_wrapper,events:{open_invoice_data:e=>{frappe.db.get_doc("POS Invoice",e).then(t=>{this.order_summary.load_summary_of(t)})},reset_summary:()=>this.order_summary.toggle_summary_placeholder(!0)}})}init_order_summary(){this.order_summary=new erpnext.PointOfSale.PastOrderSummary({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm,process_return:e=>{this.recent_order_list.toggle_component(!1),frappe.db.get_doc("POS Invoice",e).then(t=>{frappe.run_serially([()=>this.make_return_invoice(t),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])})},edit_order:e=>{this.recent_order_list.toggle_component(!1),frappe.run_serially([()=>this.frm.refresh(e),()=>this.frm.call("reset_mode_of_payments"),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])},delete_order:e=>{frappe.model.delete_doc(this.frm.doc.doctype,e,()=>{this.recent_order_list.refresh_list()})},new_order:()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>this.item_selector.toggle_component(!0),()=>frappe.dom.unfreeze()])}}})}toggle_recent_order_list(e){this.toggle_components(!e),this.recent_order_list.toggle_component(e),this.order_summary.toggle_component(e)}toggle_components(e){this.cart.toggle_component(e),this.item_selector.toggle_component(e),e||this.item_details.toggle_component(!1)||this.payment.toggle_component(!1)}make_new_invoice(){return frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_sales_invoice_frm(),()=>this.set_pos_profile_data(),()=>this.set_pos_profile_status(),()=>this.cart.load_invoice(),()=>frappe.dom.unfreeze()])}make_sales_invoice_frm(){let e="POS Invoice";return new Promise(t=>{this.frm?(this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],this.frm.doc.is_pos=1,t()):frappe.model.with_doctype(e,()=>{this.frm=this.get_new_frm(),this.frm.doc.items=[],this.frm.doc.is_pos=1,t()})})}get_new_frm(e){let t="POS Invoice",i=$("<div>"),s=e||new frappe.ui.form.Form(t,i,!1),n=frappe.model.make_new_doc_and_get_name(t,!0);return s.refresh(n),s}async make_return_invoice(e){return frappe.dom.freeze(),this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return",args:{source_name:e.name,target_doc:this.frm.doc},callback:t=>{frappe.model.sync(t.message),frappe.get_doc(t.message.doctype,t.message.name).__run_link_triggers=!1,this.set_pos_profile_data().then(()=>{frappe.dom.unfreeze()})}})}set_pos_profile_data(){if(this.company&&!this.frm.doc.company&&(this.frm.doc.company=this.company),(this.pos_profile&&!this.frm.doc.pos_profile)|(this.frm.doc.is_return&&this.pos_profile!=this.frm.doc.pos_profile)&&(this.frm.doc.pos_profile=this.pos_profile),!!this.frm.doc.company)return this.frm.trigger("set_pos_data")}set_pos_profile_status(){this.page.set_indicator(this.pos_profile,"blue")}async on_cart_update(e){frappe.dom.freeze(),this.frm.doc.set_warehouse!=this.settings.warehouse&&(this.frm.doc.set_warehouse=this.settings.warehouse);let t;try{let{field:i,value:s,item:n}=e;t=this.get_item_from_frm(n);let a=!$.isEmptyObject(t),o=i==="qty"&&s==="+1";if(o&&(s=flt(t.stock_qty)+flt(s)),a){if(i==="qty"&&(s=flt(s)),["qty","conversion_factor"].includes(i)&&s>0&&!this.allow_negative_stock){let r=i==="qty"?s*t.conversion_factor:t.qty*s;await this.check_stock_availability(t,r,this.frm.doc.set_warehouse)}(this.is_current_item_being_edited(t)||o)&&(await frappe.model.set_value(t.doctype,t.name,i,s),this.update_cart_html(t))}else{if(!this.frm.doc.customer)return this.raise_customer_selection_alert();let{item_code:r,batch_no:c,serial_no:_,rate:l,uom:d}=n;if(!r)return;let p={item_code:r,batch_no:c,rate:l,uom:d,[i]:s};if(_&&(await this.check_serial_no_availablilty(r,this.frm.doc.set_warehouse,_),p.serial_no=_),p.use_serial_batch_fields=1,i==="serial_no"&&(p.qty=s.split(`
`).length||0),t=this.frm.add_child("items",p),i==="qty"&&s!==0&&!this.allow_negative_stock){let C=s*t.conversion_factor;await this.check_stock_availability(t,C,this.frm.doc.set_warehouse)}await this.trigger_new_item_events(t),this.update_cart_html(t),this.item_details.$component.is(":visible")&&this.edit_item_details_of(t),this.check_serial_batch_selection_needed(t)&&!this.item_details.$component.is(":visible")&&this.edit_item_details_of(t)}}catch(i){console.log(i)}finally{return frappe.dom.unfreeze(),t}}raise_customer_selection_alert(){frappe.dom.unfreeze(),frappe.show_alert({message:__("You must select a customer before adding an item."),indicator:"orange"}),frappe.utils.play_sound("error")}get_item_from_frm({name:e,item_code:t,batch_no:i,uom:s,rate:n}){let a=null;if(e)a=this.frm.doc.items.find(o=>o.name==e);else{let o=i!=="null"&&i!==null;a=this.frm.doc.items.find(r=>r.item_code===t&&(!o||o&&r.batch_no===i)&&r.uom===s&&r.rate===flt(n))}return a||{}}edit_item_details_of(e){this.item_details.toggle_item_details_section(e)}is_current_item_being_edited(e){return e.name==this.item_details.current_item.name}update_cart_html(e,t){this.cart.update_item_html(e,t),this.cart.update_totals_section(this.frm)}check_serial_batch_selection_needed(e){let t=e.has_serial_no,i=e.has_batch_no,s=!e.serial_no,n=!e.batch_no;return!!(t&&s||i&&n||t&&i&&(n||s))}async trigger_new_item_events(e){await this.frm.script_manager.trigger("item_code",e.doctype,e.name),await this.frm.script_manager.trigger("qty",e.doctype,e.name)}async check_stock_availability(e,t,i){let s=(await this.get_available_stock(e.item_code,i)).message,n=s[0],a=s[1];frappe.dom.unfreeze();let o=e.uom.bold(),r=e.item_code.bold(),c=i.bold(),_=n.toString().bold();if(n>0)a&&n<t&&(frappe.throw({message:__("Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2} {3}.",[r,c,_,o]),indicator:"orange"}),frappe.utils.play_sound("error"));else if(a)frappe.model.clear_doc(e.doctype,e.name),frappe.throw({title:__("Not Available"),message:__("Item Code: {0} is not available under warehouse {1}.",[r,c])});else return;frappe.dom.freeze()}async check_serial_no_availablilty(e,t,i){let s="erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos",n={filters:{item_code:e,warehouse:t}};(await frappe.call({method:s,args:n})).message.includes(i)&&frappe.throw({title:__("Not Available"),message:__("Serial No: {0} has already been transacted into another POS Invoice.",[i.bold()])})}get_available_stock(e,t){let i=this;return frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability",args:{item_code:e,warehouse:t},callback(s){i.item_stock_map[e]||(i.item_stock_map[e]={}),i.item_stock_map[e][t]=s.message}})}update_item_field(e,t){if(t==="checkout")this.item_details.toggle_item_details_section(null);else if(t==="remove")this.remove_item_from_cart();else{let i=this.item_details[`${t}_control`];if(!i)return;i.set_focus(),e!=""&&i.set_value(e)}}remove_item_from_cart(){frappe.dom.freeze();let{doctype:e,name:t,current_item:i}=this.item_details;return frappe.model.set_value(e,t,"qty",0).then(()=>{frappe.model.clear_doc(e,t),this.update_cart_html(i,!0),this.item_details.toggle_item_details_section(null),frappe.dom.unfreeze()}).catch(s=>console.log(s))}async save_and_checkout(){if(this.frm.is_dirty()){let e=!1;await this.frm.save(null,null,null,()=>e=!0),!e&&this.payment.checkout(),e&&setTimeout(()=>{this.cart.toggle_checkout_btn(!0)},300)}else this.payment.checkout()}};})();
//# sourceMappingURL=point-of-sale.bundle.TD3M6W6G.js.map
